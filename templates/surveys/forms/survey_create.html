{% extends 'app_base.html' %}
{% load static %}

{% block page_styles %}
<style>
    /* ESTILOS DE TU DISEÑO */
    .step-card { border: 1px solid var(--bs-border-color); transition: all 0.2s ease-in-out; cursor: pointer; }
    .step-card.active { border-color: var(--bs-primary); background-color: var(--bs-primary-bg-subtle); box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.15); }
    .step-card.completed { border-color: var(--bs-success); background-color: var(--bs-success-bg-subtle); }
    .step-card:not(.active):not(.completed) { opacity: 0.6; }
    .step-icon { width: 2.5rem; height: 2.5rem; flex-shrink: 0; }

    /* Corrección Modo Noche */
    [data-bs-theme="dark"] .step-card.active { background-color: rgba(13, 110, 253, 0.15); }
    [data-bs-theme="dark"] .step-card.completed { background-color: rgba(25, 135, 84, 0.15); }

    /* Estilos de Vista Previa (Simulador) */
    .preview-device {
        background-color: var(--bs-body-tertiary);
        border-radius: 1rem;
        border: 1px solid var(--card-border-color);
        padding: 1.5rem;
        min-height: 400px;
    }
    .preview-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border-color);
        border-radius: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
</style>
{% endblock %}

{% block app_content %}
<div class="p-4 p-md-5">

    {% csrf_token %}

    <div class="mb-4">
        <h1 class="h2 fw-semibold text-body-emphasis">Crear Encuesta</h1>
        <p class="text-muted">Sigue los pasos para crear tu survey profesional</p>
    </div>

    <div class="mb-4">
        <div class="progress bg-body-tertiary" style="height: 0.5rem;">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar"></div>
        </div>
        <div class="d-flex justify-content-between text-muted small mt-2">
            <span id="stepCounter">Paso 1 de 3</span>
            <span id="percentCounter">0% completado</span>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-body step-card active h-100" id="card-step-1">
                <div class="d-flex align-items-start gap-3">
                    <div class="step-icon d-flex align-items-center justify-content-center rounded-circle bg-primary text-white fs-5 fw-semibold">1</div>
                    <div>
                        <h3 class="h6 mb-1 fw-semibold text-body-emphasis">Información básica</h3>
                        <p class="text-muted small mb-0">Nombre y categoría</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-body step-card h-100" id="card-step-2">
                <div class="d-flex align-items-start gap-3">
                    <div class="step-icon d-flex align-items-center justify-content-center rounded-circle bg-secondary-subtle text-muted fs-5 fw-semibold">2</div>
                    <div>
                        <h3 class="h6 mb-1 fw-semibold text-body-emphasis">Agregar preguntas</h3>
                        <p class="text-muted small mb-0">Construye tu survey</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-body step-card h-100" id="card-step-3">
                <div class="d-flex align-items-start gap-3">
                    <div class="step-icon d-flex align-items-center justify-content-center rounded-circle bg-secondary-subtle text-muted fs-5 fw-semibold">3</div>
                    <div>
                        <h3 class="h6 mb-1 fw-semibold text-body-emphasis">Revisar y publicar</h3>
                        <p class="text-muted small mb-0">Vista previa final</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4 p-lg-5">

            <div id="step-1-content">
                <div class="alert alert-info-subtle border border-info-subtle d-flex gap-3" role="alert">
                    <i class="bi bi-info-circle-fill text-info fs-5"></i>
                    <div>
                        <h5 class="alert-heading h6 text-info-emphasis">Paso 1: Información básica</h5>
                        <p class="mb-0 small text-body-secondary">Define el nombre de tu survey para comenzar.</p>
                    </div>
                </div>

                <div class="mt-3">
                    <label for="surveyTitle" class="form-label fw-medium text-body">Nombre de la survey <span class="text-danger">*</span>
                        <a tabindex="0" class="ms-2 text-primary small" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="¿Cómo nombrar la survey?" data-bs-content="Usa un nombre claro que incluya objetivo y periodo, por ejemplo: 'Satisfacción Clientes Q1 2025'. Esto facilita búsquedas y exportaciones.">
                            <i class="bi bi-question-circle"></i>
                        </a>
                    </label>
                    <input type="text" class="form-control bg-body-tertiary" id="surveyTitle" placeholder="ej. Satisfacción de clientes Q1 2025">
                    <div class="form-text small text-muted">Un título claro y descriptivo ayudará a organizar tus estudios.</div>
                </div>

                <div class="mt-4">
                    <label for="surveyDescription" class="form-label fw-medium text-body">Descripción (opcional)
                        <a tabindex="0" class="ms-2 text-primary small" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="¿Qué incluir en la descripción?" data-bs-content="Explica brevemente el objetivo y audiencia. Esto ayuda a recordar el propósito y a que otros colaboradores entiendan el estudio.">
                            <i class="bi bi-question-circle"></i>
                        </a>
                    </label>
                    <textarea class="form-control bg-body-tertiary" id="surveyDescription" rows="4" placeholder="Describe brevemente el objetivo..."></textarea>
                </div>

                <div class="d-flex justify-content-end pt-4 mt-5 border-top border-secondary-subtle">
                    <button class="btn btn-primary" id="btn-next-1">
                        Continuar a preguntas <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>

            <div id="step-2-content" class="d-none">
                <div class="alert alert-info-subtle border border-info-subtle d-flex gap-3" role="alert">
                    <i class="bi bi-info-circle-fill text-info fs-5"></i>
                    <div>
                        <h5 class="alert-heading h6 text-info-emphasis">Paso 2: Construye tu survey</h5>
                        <p class="mb-0 small text-body-secondary">Añade las preguntas que necesites.</p>
                    </div>
                </div>

                <div class="text-center my-4">
                    <button class="btn btn-primary btn-lg shadow-sm me-2" id="btn-suggest-questions">
                        <i class="bi bi-magic me-2"></i> Generar preguntas sugeridas
                    </button>
                    <button class="btn btn-outline-secondary btn-lg border-dashed text-body" id="btn-add-custom-question">
                        <i class="bi bi-plus-lg me-2"></i> Crear pregunta personalizada
                    </button>
                </div>

                <div id="questions-list" class="vstack gap-3"></div>

                <div class="d-flex justify-content-between pt-4 mt-5 border-top border-secondary-subtle">
                    <button class="btn btn-outline-secondary" id="btn-to-step-1-from-2">
                        <i class="bi bi-arrow-left me-1"></i> Volver
                    </button>
                    <button class="btn btn-primary" id="btn-next-2">
                        Revisar survey <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>

            <div id="step-3-content" class="d-none">
                <div class="alert alert-success-subtle border border-success-subtle d-flex gap-3" role="alert">
                    <i class="bi bi-check-circle-fill text-success fs-5"></i>
                    <div>
                        <h5 class="alert-heading h6 text-success">Paso 3: Revisa y publica</h5>
                        <p class="mb-0 small text-body-secondary">Verifica que todo esté correcto antes de lanzar.</p>
                    </div>
                </div>

                <div class="row g-4 mt-4">
                    <div class="col-lg-4">
                        <div class="card bg-body-tertiary border-0 h-100">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3">Resumen del Proyecto</h6>

                                <div class="mb-3">
                                    <label class="small text-muted d-block">Título</label>
                                    <span class="fw-bold text-body-emphasis" id="review-title">...</span>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted d-block">Descripción</label>
                                    <span class="small text-body-emphasis" id="review-description">Sin descripción</span>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted d-block">Preguntas</label>
                                    <span class="h4 fw-bold text-body-emphasis" id="review-count">0</span>
                                </div>

                                <hr class="border-secondary-subtle">

                                <div class="small text-muted">
                                    <i class="bi bi-info-circle me-1"></i> Al publicar, la survey quedará activa inmediatamente.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card border">
                            <div class="card-header bg-body-tertiary fw-bold border-secondary-subtle">
                                <i class="bi bi-eye me-2"></i>Vista Previa (Simulador)
                            </div>
                            <div class="card-body preview-device p-4">
                                <div class="text-center mb-4">
                                    <h4 class="fw-bold text-body-emphasis mb-1" id="preview-header-title">Título</h4>
                                    <p class="text-muted small" id="preview-header-desc">Descripción...</p>
                                </div>

                                <div id="preview-container" class="vstack gap-3">
                                    </div>

                                <div class="mt-4 text-center">
                                    <button class="btn btn-primary w-100" disabled>Enviar Respuestas (Demo)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between pt-4 mt-5 border-top">
                    <button class="btn btn-outline-secondary" id="btn-to-step-2-from-3">
                        <i class="bi bi-arrow-left me-1"></i> Volver a editar
                    </button>
                    <button class="btn btn-success px-4 fw-bold shadow-sm" id="btn-publish">
                        <i class="bi bi-rocket-takeoff me-2"></i> Publicar survey
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal para seleccionar tipo de questions sugeridas -->
<div class="modal fade" id="suggestQuestionsModal" tabindex="-1" aria-labelledby="suggestQuestionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suggestQuestionsModalLabel">
                    <i class="bi bi-magic me-2"></i>Selecciona el tipo de questions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Elige qué tipo de preguntas deseas agregar a tu encuesta:</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="satisfaccion">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-emoji-smile fs-3"></i>
                                <div>
                                    <div class="fw-bold">Satisfacción del Cliente</div>
                                    <small class="text-muted">NPS, calificaciones, mejoras</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="mercado">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-graph-up fs-3"></i>
                                <div>
                                    <div class="fw-bold">Investigación de Mercado</div>
                                    <small class="text-muted">Demografía, preferencias, competencia</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="rrhh">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-people fs-3"></i>
                                <div>
                                    <div class="fw-bold">Recursos Humanos</div>
                                    <small class="text-muted">Clima laboral, retención, beneficios</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="educacion">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-book fs-3"></i>
                                <div>
                                    <div class="fw-bold">Educación</div>
                                    <small class="text-muted">Calidad de enseñanza, recursos</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="producto">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-box fs-3"></i>
                                <div>
                                    <div class="fw-bold">Producto</div>
                                    <small class="text-muted">Usabilidad, expectativas, features</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="tecnologia">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-laptop fs-3"></i>
                                <div>
                                    <div class="fw-bold">Tecnología</div>
                                    <small class="text-muted">UX, problemas técnicos, funcionalidades</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="evento">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-calendar-event fs-3"></i>
                                <div>
                                    <div class="fw-bold">Evento</div>
                                    <small class="text-muted">Organización, experiencia, logística</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="general">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-star fs-3"></i>
                                <div>
                                    <div class="fw-bold">General</div>
                                    <small class="text-muted">Preguntas básicas y versátiles</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="questionTemplate">
    <div class="card border shadow-sm question-item mb-3 animate__animated animate__fadeIn">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center pb-3 border-bottom mb-3">
                <span class="badge bg-secondary-subtle text-secondary-emphasis question-number">Pregunta #</span>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm question-type bg-body-tertiary text-body" style="width: 160px;">
                        <option value="text">Texto libre</option>
                        <option value="number">Número</option>
                        <option value="scale">Escala 1-10</option>
                        <option value="single">Opción única</option>
                        <option value="multi">Opción múltiple</option>
                    </select>
                    <button type="button" class="btn btn-close btn-remove-question" aria-label="Eliminar"></button>
                </div>
            </div>

            <div class="mb-3">
                <input type="text" class="form-control question-title fw-medium bg-body-tertiary" placeholder="Escribe tu question aquí..." required>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input question-required" type="checkbox">
                <label class="form-check-label small text-muted">Respuesta obligatoria</label>
            </div>

            <div class="options-container d-none bg-body-tertiary p-3 rounded">
                <label class="small fw-bold text-muted mb-1">Opciones (separadas por coma)</label>
                <input type="text" class="form-control question-options bg-body border-0" placeholder="Ej: Rojo, Verde, Azul">
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/survey_creator.js' %}"></script>
{% endblock %}