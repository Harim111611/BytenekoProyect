{% extends 'app_base.html' %}
{% load static %}

{% comment %} Estilos migrados a static/css/byteneko.css {% endcomment %}

{% block app_content %}
<div class="p-4 p-md-5">

    {% csrf_token %}

    <div class="mb-4">
        <h1 class="h2 fw-semibold text-body-emphasis">Crear Encuesta</h1>
        <p class="text-muted">Puedes crear una encuesta desde cero o agregar preguntas sugeridas y guardar tu propia plantilla personalizada.</p>
    </div>

    <div class="mb-4">
        <div class="progress bk-progress-5">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar"></div>
        </div>
        <div class="d-flex justify-content-between text-muted small mt-2">
            <span id="stepCounter">Paso 1 de 3</span>
            <span id="percentCounter">0% completado</span>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card card-body step-card active h-100 border-0 shadow-sm" id="card-step-1">
                <div class="d-flex align-items-center gap-3">
                    <div class="step-icon step-icon-40 d-flex align-items-center justify-content-center rounded-circle bg-primary text-white fs-5 fw-bold">1</div>
                    <div>
                        <h6 class="mb-0 fw-bold text-body-emphasis">Información Básica</h6>
                        <small class="text-muted">Título y Categoría</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-body step-card h-100 border-0 shadow-sm" id="card-step-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="step-icon step-icon-40 d-flex align-items-center justify-content-center rounded-circle bg-body-secondary text-muted fs-5 fw-bold">2</div>
                    <div>
                        <h6 class="mb-0 fw-bold text-body-emphasis">Preguntas</h6>
                        <small class="text-muted">Construye el contenido</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-body step-card h-100 border-0 shadow-sm" id="card-step-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="step-icon step-icon-40 d-flex align-items-center justify-content-center rounded-circle bg-body-secondary text-muted fs-5 fw-bold">3</div>
                    <div>
                        <h6 class="mb-0 fw-bold text-body-emphasis">Revisar y Publicar</h6>
                        <small class="text-muted">Lanzamiento</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4 p-lg-5">

            <div id="step-1-content" class="animate__animated animate__fadeIn">
                <div class="d-flex gap-3 align-items-start mb-4 p-3 rounded bg-primary-subtle text-primary-emphasis">
                    <i class="bi bi-info-circle-fill fs-5 mt-1"></i>
                    <div>
                        <h6 class="fw-bold mb-1">Comencemos con lo básico</h6>
                        <p class="mb-0 small opacity-75">Define un título claro para que tus encuestados sepan de qué trata el estudio.</p>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-12">
                        <label for="surveyTitle" class="form-label fw-bold text-body-secondary small text-uppercase">Título del Proyecto <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-lg" id="surveyTitle" placeholder="Ej. Encuesta de Satisfacción Anual 2025">
                    </div>
                    
                    <div class="col-md-6">
                        <label for="surveyCategory" class="form-label fw-bold text-body-secondary small text-uppercase">Categoría</label>
                        <input type="text" class="form-control" id="surveyCategory" placeholder="Ej. RRHH, Marketing, Producto..." list="categorySuggestions">
                        <datalist id="categorySuggestions">
                            <option value="General">
                            <option value="Marketing">
                            <option value="Recursos Humanos">
                            <option value="Producto">
                            <option value="Educación">
                            <option value="Servicio al Cliente">
                        </datalist>
                        <div class="form-text">Ayuda a organizar y filtrar tus encuestas en el dashboard.</div>
                    </div>

                    <div class="col-12">
                        <label for="surveyDescription" class="form-label fw-bold text-body-secondary small text-uppercase">Descripción (Opcional)</label>
                        <textarea class="form-control" id="surveyDescription" rows="4" placeholder="Describe brevemente el objetivo de esta encuesta para los participantes..."></textarea>
                    </div>
                </div>

                <div class="d-flex justify-content-end pt-5 mt-4 border-top">
                    <button class="btn btn-primary px-4 fw-bold" id="btn-next-1">
                        Siguiente: Preguntas <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>

            <div id="step-2-content" class="d-none animate__animated animate__fadeIn">
                
                <div class="alert alert-info-subtle border border-info-subtle d-flex gap-3" role="alert">
                    <i class="bi bi-info-circle-fill text-info fs-5"></i>
                    <div>
                        <h5 class="alert-heading h6 text-info-emphasis">Paso 2: Construye tu survey</h5>
                        <p class="mb-0 small text-body-secondary">Añade las preguntas que necesites.</p>
                    </div>
                </div>

                <div class="text-center my-4">
                    <button class="btn btn-primary btn-lg shadow-sm me-2" id="btn-suggest-questions">
                        <i class="bi bi-magic me-2"></i> Generar preguntas sugeridas
                    </button>
                    <button class="btn btn-outline-secondary btn-lg border-dashed text-body" id="btn-add-custom-question">
                        <i class="bi bi-plus-lg me-2"></i> Crear pregunta personalizada
                    </button>
                    <button class="btn btn-success btn-lg ms-2 d-none" id="btn-save-template">
                        <i class="bi bi-save me-2"></i> Guardar como plantilla
                    </button>
                </div>

                <div id="questions-list" class="vstack gap-3"></div>
                
                <div id="empty-state-questions" class="text-center py-5 text-muted">
                    <i class="bi bi-ui-checks display-4 opacity-25"></i>
                    <p class="mt-3">Aún no hay preguntas. ¡Agrega la primera!</p>
                </div>

                <div class="d-flex justify-content-between pt-4 mt-5 border-top border-secondary-subtle">
                    <button class="btn btn-outline-secondary" id="btn-to-step-1-from-2">
                        <i class="bi bi-arrow-left me-1"></i> Volver
                    </button>
                    <button class="btn btn-primary" id="btn-next-2">
                        Revisar survey <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>

            <div id="step-3-content" class="d-none animate__animated animate__fadeIn">
                <div class="alert alert-success d-flex align-items-center gap-3 shadow-sm border-success-subtle bg-success-subtle text-success-emphasis" role="alert">
                    <i class="bi bi-check-circle-fill fs-4"></i>
                    <div>
                        <h6 class="fw-bold mb-0">¡Casi listo!</h6>
                        <small>Revisa los detalles finales antes de lanzar tu encuesta.</small>
                    </div>
                </div>

                <div class="row g-4 mt-4">
                    <div class="col-lg-4">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3">Resumen del Proyecto</h6>
                                <div class="mb-3">
                                    <label class="small text-muted d-block fw-bold">Título</label>
                                    <span class="fw-bold text-body-emphasis" id="review-title">...</span>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted d-block fw-bold">Categoría</label>
                                    <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle" id="review-category">General</span>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted d-block fw-bold">Descripción</label>
                                    <span class="small text-body-emphasis" id="review-description">Sin descripción</span>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted d-block">Preguntas</label>
                                    <span class="h4 fw-bold text-body-emphasis" id="review-count">0</span>
                                </div>
                                <hr class="border-secondary-subtle">
                                <div class="small text-muted">
                                    <i class="bi bi-info-circle me-1"></i> Configura el estado al finalizar.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card border">
                            <div class="card-header fw-bold border-secondary-subtle">
                                <i class="bi bi-eye me-2"></i>Vista Previa (Simulador)
                            </div>
                            <div class="card-body preview-device p-4">
                                <div class="text-center mb-4">
                                    <h4 class="fw-bold text-body-emphasis mb-1" id="preview-header-title">Título</h4>
                                    <p class="text-muted small" id="preview-header-desc">Descripción...</p>
                                </div>
                                <div id="preview-container" class="vstack gap-3"></div>
                                <div class="mt-4 text-center">
                                    <button class="btn btn-primary w-100" disabled>Enviar Respuestas (Demo)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between pt-4 mt-5 border-top">
                    <button class="btn btn-outline-secondary" id="btn-to-step-2-from-3">
                        <i class="bi bi-arrow-left me-1"></i> Volver a editar
                    </button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" id="btn-pre-publish">
                        <i class="bi bi-check-lg me-2"></i> Finalizar Encuesta
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="saveTemplateModal" tabindex="-1" aria-labelledby="saveTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveTemplateModalLabel">
                    <i class="bi bi-save me-2"></i>Guardar Plantilla
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saveTemplateForm">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Nombre de la plantilla</label>
                        <input type="text" class="form-control" id="templateName" required>
                    </div>
                    <div class="mb-3">
                        <label for="templateDesc" class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="templateDesc">
                    </div>
                    <div class="mb-3">
                        <label for="templateCat" class="form-label">Categoría</label>
                        <input type="text" class="form-control" id="templateCat" value="General">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-confirm-save-template">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="crudTemplateModal" tabindex="-1" aria-labelledby="crudTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crudTemplateModalLabel">
                    <i class="bi bi-collection me-2"></i>Gestionar Plantillas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="template-list-container"></div>
                </div>
        </div>
    </div>
</div>

<div class="modal fade" id="suggestQuestionsModal" tabindex="-1" aria-labelledby="suggestQuestionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suggestQuestionsModalLabel">
                    <i class="bi bi-magic me-2"></i>Selecciona el tipo de preguntas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <div id="my-custom-templates-section" class="d-none mb-4">
                    <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person-workspace me-2"></i>Mis Plantillas Guardadas</h6>
                    <div id="my-templates-container" class="row g-3">
                        </div>
                    <hr class="text-secondary opacity-25 my-4">
                </div>

                <h6 class="fw-bold text-muted mb-3 small text-uppercase">Plantillas del Sistema</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="satisfaccion">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-emoji-smile fs-3"></i>
                                <div>
                                    <div class="fw-bold">Satisfacción del Cliente</div>
                                    <small class="text-muted">NPS, calificaciones, mejoras</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="mercado">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-graph-up fs-3"></i>
                                <div>
                                    <div class="fw-bold">Investigación de Mercado</div>
                                    <small class="text-muted">Demografía, preferencias, competencia</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="rrhh">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-people fs-3"></i>
                                <div>
                                    <div class="fw-bold">Recursos Humanos</div>
                                    <small class="text-muted">Clima laboral, retención, beneficios</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="educacion">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-book fs-3"></i>
                                <div>
                                    <div class="fw-bold">Educación</div>
                                    <small class="text-muted">Calidad de enseñanza, recursos</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="producto">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-box fs-3"></i>
                                <div>
                                    <div class="fw-bold">Producto</div>
                                    <small class="text-muted">Usabilidad, expectativas, features</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="tecnologia">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-laptop fs-3"></i>
                                <div>
                                    <div class="fw-bold">Tecnología</div>
                                    <small class="text-muted">UX, problemas técnicos, funcionalidades</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="evento">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-calendar-event fs-3"></i>
                                <div>
                                    <div class="fw-bold">Evento</div>
                                    <small class="text-muted">Organización, experiencia, logística</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary w-100 text-start p-3 template-option" data-template="general">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-star fs-3"></i>
                                <div>
                                    <div class="fw-bold">General</div>
                                    <small class="text-muted">Preguntas básicas y versátiles</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteTemplateModal" tabindex="-1" aria-labelledby="deleteTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTemplateModalLabel">Eliminar plantilla personalizada</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de eliminar esta plantilla permanentemente?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirm-delete-template">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="publishOptionsModal" tabindex="-1" aria-labelledby="publishOptionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="publishOptionsModalLabel">¿Cómo deseas guardar la encuesta?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-secondary w-100 h-100 p-3 text-start border-2" id="btn-confirm-draft">
                            <div class="mb-2"><i class="bi bi-pencil-square fs-3"></i></div>
                            <div class="fw-bold">Guardar como Borrador</div>
                            <small class="text-muted lh-1" style="font-size: 0.8rem;">
                                Guarda el progreso. La encuesta no será pública y podrás editarla después.
                            </small>
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-success w-100 h-100 p-3 text-start border-2" id="btn-confirm-active">
                            <div class="mb-2"><i class="bi bi-rocket-takeoff-fill fs-3"></i></div>
                            <div class="fw-bold">Publicar Ahora</div>
                            <small class="text-muted lh-1" style="font-size: 0.8rem;">
                                La encuesta estará activa inmediatamente y lista para recibir respuestas.
                            </small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="questionTemplate">
    <div class="card border shadow-sm question-item mb-3 animate__animated animate__fadeIn">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center pb-3 border-bottom mb-3">
                <span class="badge bg-secondary-subtle text-secondary-emphasis question-number">Pregunta #</span>
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select form-select-sm question-type select-fixed-width">
                        <option value="text">Texto libre</option>
                        <option value="number">Número</option>
                        <option value="scale">Escala 1-10</option>
                        <option value="single">Opción única</option>
                        <option value="multi">Opción múltiple</option>
                        <option value="select">Lista Desplegable</option>
                    </select>
                    <button type="button" class="btn btn-close btn-remove-question" aria-label="Eliminar"></button>
                </div>
            </div>

            <div class="mb-3">
                <input type="text" class="form-control question-title fw-medium" placeholder="Escribe tu question aquí..." required>
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input question-required" type="checkbox">
                <label class="form-check-label small text-muted">Respuesta obligatoria</label>
            </div>

            <div class="options-container d-none p-3 rounded">
                <label class="small fw-bold text-muted mb-1">Opciones (separadas por coma)</label>
                <textarea class="form-control question-options bg-body border-0" rows="2" placeholder="Ej: Rojo, Verde, Azul"></textarea>
            </div>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/survey_creator.js' %}"></script>
{% endblock %}