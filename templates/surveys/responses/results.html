{% extends 'app_base.html' %}
{% load static %}

{% block page_styles %}
{% endblock %}

{% block app_content %}
<div class="container-xl p-4 p-md-5">

    <div class="mb-4">
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'surveys:list' %}" class="text-decoration-none">Mis Encuestas</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ survey.title }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">Resultados Analíticos</h1>
                <p class="text-muted mb-0">Explora los datos y segmenta tu audiencia.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'surveys:export' survey.public_id %}" class="btn btn-outline-primary">
                    <i class="bi bi-download me-1"></i> Exportar
                </a>
            </div>
        </div>
    </div>

    <div class="filter-bar">
        <form method="GET" class="row g-3 align-items-end" id="filterForm">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Desde</label>
                <input type="date" name="start" class="form-control bg-body-tertiary border-0" value="{{ filter_start|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Hasta</label>
                <input type="date" name="end" class="form-control bg-body-tertiary border-0" value="{{ filter_end|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Filtrar por</label>
                <select name="segment_col" id="segmentSelect" class="form-select bg-body-tertiary border-0">
                    <option value="">-- Sin segmentar --</option>
                    {% for p in preguntas_filtro %}
                        <option value="{{ p.id }}" data-type="{{ p.type }}" data-is-demographic="{{ p.is_demographic|yesno:'1,0' }}" {% if filter_col|default:'' == p.id|stringformat:"s" %}selected{% endif %}>
                            {{ p.text|truncatechars:40 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted text-uppercase">Valor</label>
                <input type="text" name="segment_val" id="segmentValInput" class="form-control bg-body-tertiary border-0" value="{{ filter_val|default:'' }}">
                <div id="demographicContext" class="mt-2 d-none">
                     <select id="demographicSelect" class="form-select bg-body-tertiary border-0"><option value="">Selecciona...</option></select>
                     <input type="hidden" name="segment_demo" id="segmentDemoInput">
                </div>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel-fill"></i></button>
            </div>
        </form>
    </div>

    {% if total_respuestas == 0 %}
        <div class="card py-5">
            <div class="card-body text-center">
                <i class="bi bi-search fs-1 text-muted mb-3"></i>
                <h3 class="fw-bold">No hay resultados aún</h3>
                <p class="text-muted">Comparte tu encuesta para recibir respuestas.</p>
            </div>
        </div>
    {% else %}

        <div class="row g-4 mb-5">
            <div class="col-md-3 col-6">
                <div class="card h-100 hover-shadow">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="kpi-icon-box"><i class="bi bi-people-fill"></i></div>
                        <div>
                            <div class="small text-uppercase fw-bold text-muted opacity-75">Respuestas</div>
                            <div class="h3 fw-bold mb-0">{{ total_respuestas }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 text-center hover-shadow">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="text-muted small text-uppercase fw-bold mb-1">NPS (Lealtad)</div>
                        <div class="h3 fw-bold mb-0 {% if nps_score > 0 %}text-primary{% else %}text-muted{% endif %}">{{ nps_score|default:"--" }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 text-center hover-shadow">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Satisfacción</div>
                        <div class="h3 fw-bold mb-0">{{ metrics.promedio_satisfaccion|default:"--" }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card h-100 text-center hover-shadow">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Completitud</div>
                        <div class="h3 fw-bold mb-0">{{ data_quality.avg_completeness_pct|default:"--"|floatformat:1 }}%</div>
                    </div>
                </div>
            </div>
        </div>

        {% if analysis_data and top_insights %}
        <div class="mb-5">
            <h4 class="fw-bold mb-4">Hallazgos Clave</h4>
            <div class="row g-4">
                {% for item in top_insights %}
                    <div class="col-lg-4 col-md-6">
                        <div class="card h-100 hover-shadow">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <div class="kpi-icon-box bg-subtle-accent" style="width: 40px; height: 40px;">
                                        <i class="bi bi-lightbulb-fill fs-6"></i>
                                    </div>
                                    <span class="hallazgo-badge">{{ item.state|default:"Insight" }}</span>
                                </div>
                                <h6 class="fw-bold mb-2">{{ item.text|truncatechars:60 }}</h6>
                                <div class="text-muted small mb-3">
                                    {% if item.insight %}
                                        {{ item.insight|striptags|truncatechars:140 }}
                                    {% else %}
                                        Detalles disponibles en el análisis completo.
                                    {% endif %}
                                </div>
                                <a href="#q_{{ item.id }}" class="btn btn-sm btn-outline-secondary w-100 smooth-scroll stretched-link">
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0">Evolución Diaria</h6>
                    </div>
                    <div class="card-body p-4">
                        <div style="height: 300px; width: 100%; position: relative;">
                            <canvas id="trendLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0">Correlaciones</h6>
                    </div>
                    <div class="card-body p-4 text-center d-flex align-items-center justify-content-center">
                        {% if heatmap_image %}
                            <img src="data:image/png;base64,{{ heatmap_image }}" class="img-fluid rounded heatmap-light-mode" style="max-height: 220px;">
                            {% if heatmap_image_dark %}
                                <img src="data:image/png;base64,{{ heatmap_image_dark }}" class="img-fluid rounded heatmap-dark-mode d-none" style="max-height: 220px;">
                            {% endif %}
                        {% else %}
                            <p class="text-muted small">Se requieren más datos numéricos.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <h4 class="fw-bold mb-4 mt-5 pb-2 border-bottom">Detalle por Pregunta</h4>
        <div class="accordion" id="questionsAccordion">
            {% for item in analysis_data %}
                <div class="accordion-item mb-4 shadow-sm rounded overflow-hidden" id="q_{{ item.id }}">
                    <h2 class="accordion-header">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.id }}">
                            <span class="fw-bold me-2 opacity-50">{{ item.order }}.</span> {{ item.text }}
                        </button>
                    </h2>
                    <div id="collapse{{ item.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#questionsAccordion">
                        <div class="accordion-body p-4">
                            <div class="row g-4">
                                <div class="col-md-8 border-end border-secondary-subtle">
                                    {% if item.type == 'text' %}
                                        <ul class="list-group list-group-flush bg-transparent">
                                            {% for texto in item.samples_texto %}
                                                <li class="list-group-item bg-transparent border-0 px-0 py-2">
                                                    <i class="bi bi-quote text-primary me-2"></i>{{ texto }}
                                                </li>
                                            {% empty %}
                                                <li class="list-group-item bg-transparent border-0">Sin respuestas de texto.</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <div class="chart-container-q">
                                            <canvas id="chart_q_{{ item.id }}"></canvas>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 ps-md-4">
                                    {% if item.insight %}
                                        <div class="bg-subtle-accent">
                                            <div class="d-flex gap-2 mb-2 text-primary">
                                                <i class="bi bi-lightbulb-fill"></i>
                                                <h6 class="fw-bold mb-0">Análisis</h6>
                                            </div>
                                            <div class="small text-muted">
                                                {% autoescape off %}{{ item.insight }}{% endautoescape %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
        // Al enviar el filtro, añade el modo oscuro como query param
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            const theme = document.documentElement.getAttribute('data-bs-theme');
            if (theme) {
                let input = document.getElementById('themeInput');
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'theme';
                    input.id = 'themeInput';
                    this.appendChild(input);
                }
                input.value = theme;
            }
        });
    // Almacenamos referencias globales a los gráficos para poder actualizarlos luego
    let activeCharts = [];
    
    const chartConfig = {
        trendData: {{ trend_data|default:"null"|safe }},
        analysisData: {{ analysis_data_json|default:"[]"|safe }},
        hasDateFields: "{{ has_date_fields|default:'true'|lower }}" === "true",
        colors: ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#d63384', '#6f42c1']
    };

    document.addEventListener('DOMContentLoaded', function() {
        initCharts(); // 1. Crear gráficos
        
        // 2. OBSERVADOR DE TEMA (CRÍTICO)
        // Detecta si cambia la clase o atributo 'data-bs-theme' en <html>
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                    // Si cambia el tema, forzamos la actualización de colores en los gráficos
                    updateChartsColors();
                    updateHeatmapVisibility();
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
    });

    // Función auxiliar para leer las variables CSS del archivo byteneko.css
    function getThemeStyles() {
        const style = getComputedStyle(document.body);
        return {
            textColor: style.getPropertyValue('--chart-text-color').trim(),
            gridColor: style.getPropertyValue('--chart-grid-color').trim()
        };
    }

    // Actualiza los colores de TODOS los gráficos activos sin recargar
    function updateChartsColors() {
        const theme = getThemeStyles();
        activeCharts.forEach(chart => {
            // Ejes
            if (chart.options.scales.x) {
                chart.options.scales.x.ticks.color = theme.textColor;
                chart.options.scales.x.grid.color = 'transparent'; // Limpieza visual
            }
            if (chart.options.scales.y) {
                chart.options.scales.y.ticks.color = theme.textColor;
                chart.options.scales.y.grid.color = theme.gridColor;
            }
            // Leyenda
            if (chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = theme.textColor;
            }
            chart.update('none'); // 'none' para que el cambio sea instantáneo
        });
    }

    function initCharts() {
        const theme = getThemeStyles();

        // 1. Gráfico de Evolución
        const trendCtx = document.getElementById('trendLineChart');
        if (trendCtx && chartConfig.hasDateFields && chartConfig.trendData && chartConfig.trendData.labels) {
            const chart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: chartConfig.trendData.labels,
                    datasets: [{
                        label: 'Respuestas',
                        data: chartConfig.trendData.data,
                        borderColor: chartConfig.colors[0],
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // CRÍTICO: respeta el height: 300px del div padre
                    scales: {
                        y: { grid: { color: theme.gridColor }, ticks: { color: theme.textColor }, beginAtZero: true },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            activeCharts.push(chart);
        }

        // 2. Gráficos de Preguntas
        if (chartConfig.analysisData && chartConfig.analysisData.length > 0) {
            chartConfig.analysisData.forEach(item => {
                const ctx = document.getElementById('chart_q_' + item.id);
                // Validación estricta antes de crear
                if (!ctx || item.type === 'text' || !item.chart_data || item.chart_data.length === 0) return;

                const chartType = item.type === 'multi' ? 'doughnut' : 'bar';
                const bgColors = item.chart_labels.map((_, i) => chartConfig.colors[i % chartConfig.colors.length]);

                const chart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: item.chart_labels,
                        datasets: [{
                            label: 'Votos',
                            data: item.chart_data,
                            backgroundColor: bgColors,
                            borderWidth: 0 // Diseño plano moderno
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: chartType === 'doughnut', 
                                position: 'right',
                                labels: { color: theme.textColor, boxWidth: 12 }
                            } 
                        },
                        scales: chartType === 'bar' ? {
                            y: { grid: { color: theme.gridColor }, ticks: { color: theme.textColor }, beginAtZero: true },
                            x: { display: false }
                        } : { x: { display: false }, y: { display: false } }
                    }
                });
                activeCharts.push(chart);
            });
        }
    }
    
    function updateHeatmapVisibility() {
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const lightImg = document.querySelector('.heatmap-light-mode');
        const darkImg = document.querySelector('.heatmap-dark-mode');
        if(lightImg && darkImg) {
            if(isDark) {
                lightImg.classList.add('d-none');
                darkImg.classList.remove('d-none');
            } else {
                lightImg.classList.remove('d-none');
                darkImg.classList.add('d-none');
            }
        }
    }
    // Ejecutar al inicio para asegurar estado correcto
    updateHeatmapVisibility();
</script>
{% endblock %}