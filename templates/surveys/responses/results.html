{% extends 'app_base.html' %}
{% load static humanize %}

{% block app_content %}
{# --- ESTILOS CENTRALIZADOS EN static/css/byteneko.css --- #}

<div class="container-fluid p-4 p-md-5 dashboard-container">
    {# CSRF token for AJAX POSTs (used by save-segment fetch) #}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    
    {# --- HEADER --- #}
    <div class="d-flex flex-column flex-xl-row justify-content-between align-items-xl-center mb-5 gap-4">
        <div>
            <div class="d-flex align-items-center mb-3">
                <span class="badge bg-primary rounded-pill px-3 py-2 fw-bold me-2">
                    <i class="bi bi-pie-chart-fill me-1"></i> Data Studio
                </span>
                <span class="small text-uppercase fw-bold text-muted ls-1">Resultados en Tiempo Real</span>
            </div>
            <h1 class="display-6 fw-bold mb-1 ls-tight text-bk-primary">{{ survey.title }}</h1>
            <p class="mb-0 fs-5 text-muted">
                Base total: <span class="fw-bold text-primary">{{ total_respuestas|intcomma }}</span> respuestas analizadas
            </p>
        </div>
        
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-lg btn-outline-primary shadow-sm fw-bold px-4 rounded-pill d-flex align-items-center gap-2"
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#filtersCollapse">
                <i class="bi bi-sliders2 text-primary"></i>
                <span>Filtros y Cruces</span>
            </button>
            
            {% if request.GET.crosstab_col %}
            <a href="?" class="btn btn-lg bk-btn-clear-view shadow-sm fw-bold px-4 rounded-pill d-flex align-items-center gap-2">
                <i class="bi bi-x-circle-fill"></i> Limpiar Vista
            </a>
            {% endif %}
            
            <!-- Bot√≥n de ayuda para filtros y tablas cruzadas -->
            <button type="button" class="btn btn-lg btn-outline-secondary rounded-pill d-flex align-items-center gap-2" id="btnAyudaFiltros">
                <i class="bi bi-question-circle-fill"></i>
                <span class="d-none d-md-inline">¬øC√≥mo funcionan?</span>
            </button>
        </div>
    </div>

    {# --- FILTROS --- #}
    <div class="collapse mb-5 {% if request.GET.crosstab_col %}show{% endif %}" id="filtersCollapse">
        <div class="card border-0 shadow-lg rounded-4 p-4 p-lg-5 bk-card-bg">
            <form method="GET" class="row g-4">
                <div class="col-12">
                    <h6 class="fw-bold text-uppercase small mb-2 text-muted opacity-75">Configuraci√≥n de An√°lisis</h6>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label class="form-label small fw-bold text-muted">Desde Fecha</label>
                    <input type="date" name="start" class="form-control form-control-lg" value="{{ request.GET.start }}">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="form-label small fw-bold text-muted">Hasta Fecha</label>
                    <input type="date" name="end" class="form-control form-control-lg" value="{{ request.GET.end }}">
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label class="form-label small fw-bold text-muted">Segmentar (Filtrar)</label>
                    <select name="segment_col" class="form-select form-select-lg">
                        <option value="">-- Todos los datos --</option>
                        {% for p in preguntas_filtro %}
                            <option value="{{ p.id }}" {% if request.GET.segment_col == p.id|stringformat:"s" %}selected{% endif %}>{{ p.text|truncatechars:25 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 col-lg-3">
                     <label class="form-label small fw-bold text-muted">Valor del Segmento</label>
                     <input type="text" name="segment_val" class="form-control form-control-lg" placeholder="Ej. Ventas" value="{{ request.GET.segment_val|default:'' }}">
                </div>

                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-success btn-lg rounded-pill fw-bold px-4 shadow-sm">
                        <i class="bi bi-funnel-fill me-1"></i> Aplicar filtros
                    </button>
                </div>

                <div class="col-12 mt-4"><hr class="opacity-10"></div>

                <div class="col-12">
                    <div class="alert alert-light border-start border-4 border-primary mb-0">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-grid-3x3-gap-fill fs-5 text-primary"></i>
                            <h6 class="fw-bold text-primary mb-0">Tabla Cruzada (An√°lisis Comparativo)</h6>
                        </div>
                        <p class="small text-muted mb-0">
                            <strong>¬øPara qu√© sirve?</strong> Compara dos variables: muestra c√≥mo una variable (en las filas) 
                            se distribuye seg√∫n otra variable (en las columnas). Por ejemplo: "Planes de suscripci√≥n" vs "Nivel de satisfacci√≥n".
                        </p>
                    </div>
                </div>

                {# DOS SELECTS: FILAS Y COLUMNAS #}
                <div class="col-12 col-lg-6">
                    <label class="form-label fw-bold text-uppercase small mb-2">
                        <i class="bi bi-arrow-down me-1 text-info"></i>Variable para FILAS (Primera comparaci√≥n)
                    </label>
                    <select name="crosstab_row" class="form-select form-select-lg shadow-sm">
                        <option value="">-- Seleccionar Variable --</option>
                        {% for p in preguntas_filtro %}
                            <option value="{{ p.id }}" {% if request.GET.crosstab_row == p.id|stringformat:"s" %}selected{% endif %}>{{ p.text|truncatechars:40 }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-12 col-lg-6">
                    <label class="form-label fw-bold text-uppercase small mb-2">
                        <i class="bi bi-arrow-right me-1 text-success"></i>Variable para COLUMNAS (Segunda comparaci√≥n)
                    </label>
                    <div class="input-group input-group-lg shadow-sm">
                        <select name="crosstab_col" class="form-select border-success">
                            <option value="">-- Seleccionar Variable --</option>
                            {% for p in preguntas_filtro %}
                                <option value="{{ p.id }}" {% if request.GET.crosstab_col == p.id|stringformat:"s" %}selected{% endif %}>{{ p.text|truncatechars:40 }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-success px-4 fw-bold">
                            <i class="bi bi-lightning-charge-fill me-1"></i> Analizar
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    {# --- VISTA 1: TABLA CRUZADA (MODO COMPARATIVO) --- #}
    {% if crosstab_data %}
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5 hover-card bk-card-bg">
            {# HEADER CON CONTEXTO #}
            <div class="card-header border-0 p-4 bg-light border-bottom">
                <div class="row align-items-center">
                    <div class="col-12 col-md-8">
                        <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                            <span class="badge bg-primary rounded-pill px-3 py-2">
                                <i class="bi bi-grid-3x3-gap-fill me-1"></i>An√°lisis Comparativo
                            </span>
                            <span class="text-muted small"><i class="bi bi-lightning-charge-fill me-1 text-warning"></i>{{ crosstab_data.total_responses }} respuestas analizadas</span>
                            <button class="btn btn-sm btn-outline-warning ms-md-auto" data-bs-toggle="modal" data-bs-target="#guideModal" title="Gu√≠a de lectura">
                                <i class="bi bi-lightbulb me-1"></i><span class="d-none d-md-inline">Gu√≠a</span>
                            </button>
                        </div>
                        <h4 class="fw-bold mb-1">
                            <span class="text-muted">{{ crosstab_data.row_label }}</span> 
                            <span class="mx-2 opacity-25">vs</span> 
                            <span class="text-primary">{{ crosstab_data.col_label }}</span>
                        </h4>
                        <p class="mb-0 small text-muted">
                            Distribuci√≥n de <strong>{{ crosstab_data.row_label }}</strong> seg√∫n 
                            <strong>{{ crosstab_data.col_label }}</strong>
                        </p>
                    </div>
                    <div class="col-12 col-md-4 mt-3 mt-md-0">
                        <div class="alert alert-info mb-0 py-2 px-3 rounded">
                            <small class="d-block mb-1">
                                <strong>{{ crosstab_data.row_categories }}</strong> categor√≠as de fila
                            </small>
                            <small>
                                <strong>{{ crosstab_data.col_categories }}</strong> categor√≠as de columna
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                {# GR√ÅFICO #}
                <div class="px-4 py-5 border-bottom" style="background-color: var(--bk-hover-bg);">
                    <h6 class="fw-bold mb-3 text-uppercase small">
                        <i class="bi bi-bar-chart-fill me-2 text-primary"></i>Distribuci√≥n Visual
                    </h6>
                    <div class="chart-surface chart-pad">
                        <div id="crosstabChartContainer" class="bk-crosstab-chart-container">
                            <canvas id="crosstabChart"></canvas>
                        </div>
                    </div>
                    <p class="text-muted small mt-3 mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Las barras apiladas muestran c√≥mo se distribuye cada valor de "{{ crosstab_data.row_label }}" 
                        entre los diferentes niveles de "{{ crosstab_data.col_label }}".
                    </p>
                </div>

                {# TABLA DETALLADA #}
                <div>
                    <h6 class="fw-bold p-4 pb-2 mb-0 text-uppercase small border-bottom" style="background-color: var(--bk-hover-bg);">
                        <i class="bi bi-table me-2 text-primary"></i>Detalle Num√©rico
                    </h6>
                    <div class="table-container-scroll">
                        <table class="table align-middle mb-0 table-hover text-bk-primary fs-7 table-sm">
                            <thead class="sticky-top" style="background-color: var(--bk-hover-bg);">
                                <tr>
                                    <th class="ps-4 py-3 sticky-col-head sticky-col-first minw-200 fw-bold">{{ crosstab_data.row_label }}</th>
                                    {% for h in crosstab_data.headers %}
                                        <th class="text-center py-3 sticky-col-head minw-120 fw-bold">
                                            <div>{{ h }}</div>
                                            <small class="text-muted fw-normal">(Resp.)</small>
                                        </th>
                                    {% endfor %}
                                    <th class="text-end pe-4 py-3 sticky-col-head bg-light border-start fw-bold">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in crosstab_data.rows %}
                                <tr class="border-bottom">
                                    <td class="ps-4 py-3 fw-bold sticky-col-first">
                                        {{ row.label }}
                                    </td>
                                    {% for cell in row.values %}
                                        <td class="text-center py-3 position-relative">
                                            <div class="data-bar-bg" style="width: {{ cell.percentage }}%; background-color: var(--bk-primary);"></div>
                                            <div class="d-flex flex-column align-items-center z-1 position-relative gap-1">
                                                <span class="fw-bold">{{ cell.count }}</span>
                                                <small class="opacity-60 font-monospace fs-8">{{ cell.percentage }}%</small>
                                            </div>
                                        </td>
                                    {% endfor %}
                                    <td class="text-end pe-4 py-3 fw-bold border-start" style="background-color: var(--bk-hover-bg);">
                                        <span class="badge bg-secondary">{{ row.total }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold" style="background-color: var(--bk-hover-bg);">
                                    <td class="ps-4 py-3 sticky-col-first">TOTAL</td>
                                    {% for header in crosstab_data.headers %}
                                        <td class="text-center py-3">
                                            <span class="badge bg-primary">N</span>
                                        </td>
                                    {% endfor %}
                                    <td class="text-end pe-4 py-3">
                                        <span class="badge bg-success">{{ crosstab_data.total_responses }}</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    {% else %}
    
    {# --- VISTA 2: DASHBOARD GLOBAL KPI --- #}
    <div class="row g-4 mb-5">
        <div class="col-12 col-xl-4">
              <div class="card kpi-card-modern bk-kpi-border-primary shadow-lg h-100 rounded-4 p-4 position-relative overflow-hidden d-flex flex-column">
                {% widthratio kpi_score 10 100 as kpi_percent %}

                <div class="d-flex align-items-start justify-content-between gap-3 mb-2">
                    <div>
                        <h6 class="text-uppercase text-muted fw-bold mb-1 ls-1">Satisfacci√≥n Global (NPS)</h6>
                        <div class="small text-muted opacity-75">Puntuaci√≥n promedio (escala 0‚Äì10)</div>
                    </div>
                    <div class="bk-kpi-icon-pill" aria-hidden="true">
                        <i class="bi bi-trophy-fill"></i>
                    </div>
                </div>

                <div class="d-flex align-items-end mt-3">
                    <span class="display-2 fw-bold bk-gradient-text">{{ kpi_score }}</span>
                    <span class="fs-4 ms-2 opacity-50 text-muted">/ 10</span>
                </div>

                <div class="mt-2">
                    <div class="d-flex justify-content-between align-items-center small text-muted">
                        <span class="opacity-75">{{ kpi_percent }}% del m√°ximo</span>
                        {% if kpi_score >= 8 %}
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10 rounded-pill">Excelente</span>
                        {% elif kpi_score >= 6 %}
                            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 rounded-pill">Bueno</span>
                        {% elif kpi_score >= 4 %}
                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-10 rounded-pill">Regular</span>
                        {% else %}
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10 rounded-pill">Cr√≠tico</span>
                        {% endif %}
                    </div>

                    <div class="progress rounded-pill bk-progress-10 mt-2">
                        <div class="progress-bar rounded-pill shadow-sm bk-progress-bar-gradient" role="progressbar"
                            style="width: {{ kpi_percent }}%">
                        </div>
                    </div>
                </div>

                <div class="mt-auto pt-3">
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-10 rounded-pill px-3 py-2">
                            <i class="bi bi-people-fill me-1"></i> {{ total_respuestas|intcomma }} respuestas
                        </span>
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 rounded-pill px-3 py-2">
                            <i class="bi bi-speedometer2 me-1"></i> Indicador global
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-8">
            <div class="card border-0 shadow-lg h-100 rounded-4 p-4 bk-card-bg">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="fw-bold text-uppercase text-muted">Tendencia de Participaci√≥n</h6>
                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 py-2 border border-success border-opacity-10">
                        <i class="bi bi-graph-up-arrow me-1"></i> {{ total_respuestas }} Totales
                    </span>
                </div>
                <div class="chart-surface chart-pad bk-chart-280">
                    <canvas id="evolutionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# --- SECCI√ìN: AN√ÅLISIS ESTAD√çSTICO AVANZADO --- #}
    {% if advanced_stats.cronbach_alpha or advanced_stats.correlation_matrix %}
    <div class="card border-0 shadow-lg rounded-4 mb-5 bk-card-bg">
        <div class="card-header bg-transparent border-0 p-4">
            <h5 class="fw-bold text-primary mb-0"><i class="bi bi-calculator me-2"></i>An√°lisis Estad√≠stico Avanzado</h5>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="p-4 rounded-3 bg-light border text-center h-100">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Confiabilidad (Cronbach)</h6>
                        <div class="display-4 fw-bold {% if advanced_stats.cronbach_alpha >= 0.7 %}text-success{% else %}text-warning{% endif %}">
                            {{ advanced_stats.cronbach_alpha|floatformat:2 }}
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="table-responsive rounded-3 border">
                        <table class="table table-sm table-hover mb-0 text-center small">
                            <thead class="bg-light">
                                <tr>
                                    <th class="text-start p-2">Variable</th>
                                    {% for key in advanced_stats.correlation_matrix.keys %}
                                        <th class="p-2">{{ forloop.counter }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row_key, row_values in advanced_stats.correlation_matrix.items %}
                                <tr>
                                    <td class="text-start fw-bold p-2 text-truncate truncate-text" style="max-width: 150px;">{{ forloop.counter }}. {{ row_key }}</td>
                                    {% for col_key, val in row_values.items %}
                                        <td class="p-2" style="background-color: rgba(99, 102, 241, {{ val|default:0 }}); color: {% if val > 0.5 %}#fff{% else %}#000{% endif %};">
                                            {{ val|floatformat:1 }}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# --- GRID DE INSIGHTS --- #}
    {% if analysis_data %}
    <div class="d-flex align-items-center mb-4 mt-5 ps-1">
        <div class="rounded-pill me-3 bk-vertical-gradient-bar"></div>
        <h4 class="fw-bold mb-0 text-bk-primary">Desglose por Pregunta</h4>
    </div>
    
    <div class="row g-4 pb-5">
        {% for item in analysis_data %}
            <div class="col-md-6 col-xxl-4 d-flex">
                {# UTILIZAMOS EL COMPONENTE COMPLETO QUE CONTIENE LOS TEXTOS #}
                {% include "surveys/components/insight_card.html" with data=item scale_max=item.insight_data.max %}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- MODAL: Ayuda Filtros y Cruces (IN-BLOCK) -->
    <div class="modal fade" id="modalAyudaFiltros" tabindex="-1" aria-labelledby="modalAyudaFiltrosLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-header border-0 p-4 pb-0">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3 d-flex align-items-center justify-content-center badge-circle-md">
                            <i class="bi bi-lightbulb-fill text-primary fs-4"></i>
                        </div>
                        <div>
                            <h5 class="modal-title fw-bold ls-tight" id="modalAyudaFiltrosLabel">Gu√≠a de An√°lisis</h5>
                            <p class="mb-0 small text-muted">Aprende a interpretar tus datos</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4 p-md-5">
                    <div class="row g-4">
                        <div class="col-md-6 position-relative">
                            <div class="p-4 rounded-4 h-100 border border-light bg-light bg-opacity-10">
                                <h6 class="fw-bold text-primary mb-3 d-flex align-items-center">
                                    <i class="bi bi-funnel-fill me-2"></i> Segmentaci√≥n (Filtros)
                                </h6>
                                <p class="small text-muted mb-0 lh-lg">
                                    Utiliza los filtros para aislar un subconjunto espec√≠fico de respuestas.
                                    <br><br>
                                    <strong>Ejemplo:</strong> Si quieres ver solo las respuestas del departamento de "Ventas", selecciona la pregunta correspondiente y escribe el valor. Los gr√°ficos se recalcular√°n autom√°ticamente.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-4 rounded-4 h-100 border border-light bg-light bg-opacity-10">
                                <h6 class="fw-bold text-primary mb-3 d-flex align-items-center">
                                    <i class="bi bi-grid-3x3-gap-fill me-2"></i> Tablas Cruzadas
                                </h6>
                                <p class="small text-muted mb-0 lh-lg">
                                    Las tablas cruzadas te permiten comparar <strong>dos variables</strong> simult√°neamente para detectar patrones ocultos.
                                    <br><br>
                                    <strong>Ejemplo:</strong> Cruza "Satisfacci√≥n" vs "Antig√ºedad" para ver si los empleados m√°s nuevos est√°n m√°s felices que los antiguos.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 bg-light bg-opacity-10">
                    <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm" data-bs-dismiss="modal">¬°Entendido!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Gu√≠a de Lectura (Tabla Cruzada) -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header border-0 pb-0 pt-4">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-lightbulb me-2 text-warning"></i>Gu√≠a de Lectura
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="alert alert-info mb-0">
                                <p class="mb-1"><strong>üìä FILAS (Verticalmente)</strong></p>
                                <p class="mb-0 small text-muted">
                                    Cada fila representa un valor diferente del an√°lisis.
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-success mb-0">
                                <p class="mb-1"><strong>üìà COLUMNAS (Horizontalmente)</strong></p>
                                <p class="mb-0 small text-muted">
                                    Cada columna representa otro valor para comparar.
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-primary mb-0">
                                <p class="mb-1"><strong>üî¢ N√öMEROS (Centro de la celda)</strong></p>
                                <p class="mb-0 small text-muted">
                                    Cantidad de respuestas que coinciden en esa intersecci√≥n.
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-warning mb-0">
                                <p class="mb-1"><strong>% PORCENTAJES (Abajo)</strong></p>
                                <p class="mb-0 small text-muted">
                                    Qu√© % de esa fila representa esa columna (siempre suma 100% por fila).
                                </p>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="alert alert-secondary mb-0">
                                <p class="mb-1"><strong>üé® BARRAS COLOREADAS</strong></p>
                                <p class="mb-0 small text-muted">
                                    Visualizaci√≥n de la intensidad: barras m√°s grandes = m√°s respuestas en esa combinaci√≥n.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 rounded alert alert-success mb-0">
                        <p class="mb-0 small">
                            <strong>üí° Ejemplo pr√°ctico:</strong> Si ves que el plan "Premium" tiene 85% de satisfacci√≥n "Excelente" 
                            y el plan "Basic" solo 30%, significa que Premium tiene clientes m√°s satisfechos.
                        </p>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 px-4 pb-4">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Guardar Segmento (IN-BLOCK) -->
    <div class="modal fade" id="modalGuardarSegmento" tabindex="-1" role="dialog" aria-labelledby="modalGuardarSegmentoLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-success bg-opacity-10 border-0 py-4">
                    <h5 class="modal-title fw-bold text-success" id="modalGuardarSegmentoLabel">
                        <i class="bi bi-bookmark-fill me-2"></i>Guardar Filtros como Segmento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-4">
                        Los filtros aplicados se guardar√°n como un segmento reutilizable. Podr√°s acceder a √©l desde Resultados Globales.
                    </p>
                    <form id="formGuardarSegmento">
                        <div class="mb-3">
                            <label for="segmentName" class="form-label fw-bold">Nombre del Segmento *</label>
                            <input type="text" class="form-control form-control-lg" id="segmentName" placeholder="Ej. Clientes Premium de Madrid" maxlength="100" required>
                            <small class="text-muted d-block mt-1">M√°ximo 100 caracteres</small>
                        </div>
                        <div class="alert alert-info small mb-0">
                            <strong>Se guardar√°n los siguientes filtros:</strong>
                            <ul class="mb-0 mt-2 ps-3">
                                <li id="filterStart">Desde fecha: <span id="valStart">-</span></li>
                                <li id="filterEnd">Hasta fecha: <span id="valEnd">-</span></li>
                                <li id="filterSegment">Segmentaci√≥n: <span id="valSegment">-</span></li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success rounded-pill fw-bold px-5" id="btnConfirmarSegmento">
                        <i class="bi bi-check-lg me-1"></i>Guardar Segmento
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // --- Configuraci√≥n Global ---
    Chart.register(ChartDataLabels);
    const getCssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    
    const theme = () => ({
        primary: getCssVar('--bk-primary') || '#6366f1',
        text: getCssVar('--bk-text-primary') || '#1f2937',
        grid: getCssVar('--bk-card-border') || 'rgba(0,0,0,0.1)',
        font: "'Inter', sans-serif"
    });

    // Paleta sobria basada en el color primario del tema (sin multicolor vibrante)
    const datasetColors = (idx, total) => {
        const base = theme().primary;
        const maxAlpha = 0.75;
        const minAlpha = 0.25;
        const alpha = (total && total > 1)
            ? (maxAlpha - (idx * (maxAlpha - minAlpha) / (total - 1)))
            : maxAlpha;
        return {
            backgroundColor: hexToRgba(base, alpha),
            borderColor: base,
        };
    };
    
    const hexToRgba = (hex, alpha) => {
        let c = hex.substring(1).split('');
        if(c.length==3) c = [c[0], c[0], c[1], c[1], c[2], c[2]];
        c = '0x'+c.join('');
        return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
    };

    
    const wrapLabel = (str, maxLen = 22) => {
        if (!str) return '';
        str = str.toString();
        if (str.length <= maxLen) return str;
        return str.substring(0, maxLen) + '...';
    };

    Chart.defaults.font.family = theme().font;
    Chart.defaults.color = theme().text;
    Chart.defaults.scale.grid.color = theme().grid;
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = 6;
    Chart.defaults.maintainAspectRatio = false; // CRUCIAL para evitar deformaciones


    // ==========================================
    // 2. CROSSTAB CHART (Tabla Cruzada - Barras Apiladas)
    // ==========================================
    {% if crosstab_chart_json %}
    const crosstabData = {{ crosstab_chart_json|safe }};
    const ctxCrosstab = document.getElementById('crosstabChart');
    
    if (ctxCrosstab && crosstabData && crosstabData.labels && crosstabData.labels.length > 0) {
        // Preparar datasets con colores sobrios
        const datasets = crosstabData.datasets.map((ds, idx) => {
            const colors = datasetColors(idx, crosstabData.datasets.length);
            return {
                label: ds.label,
                data: ds.data,
                backgroundColor: colors.backgroundColor,
                borderColor: colors.borderColor,
                borderWidth: 1,
                borderRadius: 4
            };
        });
        
        new Chart(ctxCrosstab, {
            type: 'bar',
            data: {
                labels: crosstabData.labels.map(l => wrapLabel(l, 20)),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: crosstabData.labels.length > 6 ? 'y' : 'x', // Horizontal si hay muchas categor√≠as
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            font: { size: 11, weight: '600' },
                            padding: 12,
                            color: theme().text,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.85)',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y || context.parsed.x || 0;
                                const total = context.chart.data.datasets.reduce((sum, ds) => {
                                    const val = crosstabData.labels.length > 6 ? 
                                        ds.data[context.dataIndex] : 
                                        ds.data[context.dataIndex];
                                    return sum + (val || 0);
                                }, 0);
                                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: ${value} (${pct}%)`;
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { 
                            color: theme().text, 
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: { color: theme().grid, drawBorder: false },
                        ticks: { 
                            color: theme().text, 
                            font: { size: 11 },
                            precision: 0
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    }
    {% endif %}

    // ==========================================
    // 3. EVOLUTION CHART (Tendencia de Participaci√≥n)
    // ==========================================
    const evolutionData = (typeof evolution_chart !== 'undefined') ? evolution_chart : {{ evolution_chart|default:'{"labels":[],"data":[]}'|safe }};
    const ctxEvolution = document.getElementById('evolutionChart');
    if (ctxEvolution && evolutionData && evolutionData.labels && evolutionData.labels.length > 0) {
        new Chart(ctxEvolution, {
            type: 'line',
            data: {
                labels: evolutionData.labels,
                datasets: [{
                    label: 'Respuestas',
                    data: evolutionData.data,
                    fill: true,
                    backgroundColor: hexToRgba(theme().primary, 0.13),
                    borderColor: theme().primary,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: theme().primary,
                    pointBorderColor: theme().primary,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false },
                    tooltip: {
                        padding: 10,
                        cornerRadius: 6
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: theme().text, font: { size: 12 } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: theme().grid },
                        ticks: { color: theme().text, font: { size: 12 } }
                    }
                }
            }
        });
    }

    // ==========================================
    // 3. MINI CHARTS (INSIGHT CARDS) - CORREGIDO
    // ==========================================
    (function initMiniCharts() {
        if (!window.chartRegistry || !window.chartRegistry.length) return;

        window.chartRegistry.forEach((conf, index) => {
            const canvas = document.getElementById(conf.id);
            if (!canvas) return;

            const jsonElem = document.getElementById(conf.dataId);
            if (!jsonElem) return;
            const data = JSON.parse(jsonElem.textContent);
            
            // --- COLORES SIEMPRE VARIADOS ---
            const backgroundColors = data.data.map((_, i) => hexToRgba(PALETTE[i % PALETTE.length], 0.85));
            const borderColors = data.data.map((_, i) => PALETTE[i % PALETTE.length]);

            // Detecci√≥n de horizontalidad necesaria
            const needsHorizontal = (conf.displayType === 'bar' && data.labels.length > 5);
            const isPie = (conf.displayType === 'doughnut' || conf.displayType === 'pie');

            let chartConfig = {
                type: conf.displayType,
                data: {
                    labels: data.labels.map(l => wrapLabel(l, 25)),
                    datasets: [{
                        data: data.data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 3,
                        barPercentage: 0.7, // Grosor equilibrado
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: needsHorizontal ? 'y' : 'x',
                    layout: { padding: { top: 15, bottom: 5, left: 5, right: 15 } },
                    plugins: {
                        legend: { 
                            display: isPie, 
                            position: 'right', 
                            labels: { boxWidth: 10, font: { size: 10 }, padding: 10 } 
                        },
                        datalabels: {
                            color: isPie ? '#fff' : theme().text,
                            anchor: isPie ? 'center' : (needsHorizontal ? 'end' : 'end'),
                            align: isPie ? 'center' : (needsHorizontal ? 'end' : 'top'),
                            font: { size: 10, weight: 'bold' },
                            offset: isPie ? 0 : -2,
                            formatter: (val, ctx) => {
                                const total = ctx.dataset.data.reduce((a,b) => a+Number(b), 0);
                                const pct = Math.round((val/total)*100);
                                return pct > 4 ? pct + '%' : '';
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: !isPie, 
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: { 
                            display: !isPie, 
                            grid: { display: false },
                            ticks: { font: { size: 10 }, autoSkip: false } 
                        }
                    }
                }
            };
            
            // --- AJUSTE DE ALTURA INTELIGENTE ---
            if (needsHorizontal && data.labels.length > 5) {
                // 40px por barra: Ni muy fino ni muy grueso. Perfecto para leer.
                const newHeight = data.labels.length * 40 + 50; 
                canvas.parentNode.style.height = `${newHeight}px`;
            } else {
                // Altura est√°ndar base (210px) para que Pie/Barras cortas se vean bien
                canvas.parentNode.style.height = '210px';
            }

            // Excepci√≥n para tarjetas KPI (Num√©ricas) que van en columna peque√±a
            // Si el canvas est√° dentro de un col-8 (KPI), forzamos altura menor pero suficiente
            if (canvas.closest('.col-8')) {
                 canvas.parentNode.style.height = '160px'; // Fijo para KPI
            }

            new Chart(canvas, chartConfig);
        });
    })();
});
</script>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Safely initialize modals without Bootstrap auto-init
    const btnAyuda = document.getElementById('btnAyudaFiltros');
    const btnSegmento = document.getElementById('btnGuardarSegmento');
    const modalAyuda = document.getElementById('modalAyudaFiltros');
    const modalSegmento = document.getElementById('modalGuardarSegmento');
    const btnConfirmar = document.getElementById('btnConfirmarSegmento');
    const nameInput = document.getElementById('segmentName');
    
    console.log('Modales inicializando...', { btnAyuda, btnSegmento, modalAyuda, modalSegmento });
    
    // Helper to show modal with Bootstrap backdrop
    function showModal(modalEl) {
        if (!modalEl) {
            console.error('Modal element not found');
            return;
        }
        console.log('Showing modal:', modalEl.id);
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        modalEl.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        
        // Crear backdrop
        if (!document.querySelector('.modal-backdrop')) {
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
    }
    
    // Helper to hide modal
    function hideModal(modalEl) {
        if (!modalEl) {
            console.error('Modal element not found');
            return;
        }
        console.log('Hiding modal:', modalEl.id);
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
        
        // Remover backdrop
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
    }
    
    // Help modal
    if (btnAyuda && modalAyuda) {
        btnAyuda.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Help button clicked');
            showModal(modalAyuda);
        });
        
        const closeAyuda = modalAyuda.querySelector('[data-bs-dismiss="modal"]');
        if (closeAyuda) {
            closeAyuda.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Help close button clicked');
                hideModal(modalAyuda);
            });
        }
    } else {
        console.warn('Help modal elements not found');
    }
    
    // Save segment modal
    if (btnSegmento && modalSegmento) {
        btnSegmento.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Save segment button clicked');
            updatePreview();
            showModal(modalSegmento);
        });
        
        const closeSegmento = modalSegmento.querySelector('[data-bs-dismiss="modal"]');
        if (closeSegmento) {
            closeSegmento.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save segment close button clicked');
                hideModal(modalSegmento);
            });
        }
    } else {
        console.warn('Save segment modal elements not found');
    }
    
    function updatePreview() {
        const startVal = document.querySelector('input[name="start"]')?.value || '-';
        const endVal = document.querySelector('input[name="end"]')?.value || '-';
        const segCol = document.querySelector('select[name="segment_col"]')?.value || '';
        const segVal = document.querySelector('input[name="segment_val"]')?.value || '';
        
        const valStart = document.getElementById('valStart');
        const valEnd = document.getElementById('valEnd');
        const valSeg = document.getElementById('valSegment');
        
        if (valStart) valStart.textContent = startVal;
        if (valEnd) valEnd.textContent = endVal;
        
        if (valSeg) {
            if (segCol && segVal) {
                const opt = document.querySelector(`select[name="segment_col"] option[value="${segCol}"]`);
                valSeg.textContent = `${opt ? opt.textContent : 'Sin segmentar'}: ${segVal}`;
            } else {
                valSeg.textContent = 'Sin segmentar';
            }
        }
    }
    
    // Handle save button click
    if (btnConfirmar) {
        btnConfirmar.addEventListener('click', async function() {
            if (!nameInput) return;
            
            const name = nameInput.value?.trim();
            if (!name) {
                alert('Ingresa un nombre');
                return;
            }
            
            const start = document.querySelector('input[name="start"]')?.value || '';
            const end = document.querySelector('input[name="end"]')?.value || '';
            const segCol = document.querySelector('select[name="segment_col"]')?.value || '';
            const segVal = document.querySelector('input[name="segment_val"]')?.value || '';
            
            btnConfirmar.disabled = true;
            const origText = btnConfirmar.innerHTML;
            btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
            
            try {
                const surveyId = '{{ survey.public_id }}';
                const response = await fetch(`/surveys/${surveyId}/api/save-segment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        name: name,
                        start: start,
                        end: end,
                        segment_col: segCol,
                        segment_val: segVal
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Close modal
                    hideModal(modalSegmento);
                    
                    // Show success message
                    const alertEl = document.createElement('div');
                    alertEl.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertEl.innerHTML = `<i class="bi bi-check-circle me-2"></i><strong>¬°Segmento guardado!</strong> "${name}" disponible en Resultados Globales<button class="btn-close" data-bs-dismiss="alert"></button>`;
                    
                    const container = document.querySelector('.dashboard-container');
                    if (container) container.insertBefore(alertEl, container.firstChild);
                    
                    nameInput.value = '';
                    setTimeout(() => {
                        if (alertEl.parentNode) alertEl.remove();
                    }, 5000);
                } else {
                    alert('Error: ' + (data.error || 'Desconocido'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = origText;
            }
        });
    }
});
</script>

<style>
/* Modal overrides */
.modal {
    z-index: 1050 !important;
}

.modal.show {
    display: block !important;
}

.modal-backdrop {
    z-index: 1040 !important;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-backdrop.show {
    opacity: 1;
}
</style>

{% endblock %}
