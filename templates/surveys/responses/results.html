{% extends 'app_base.html' %}
{% load static humanize %}

{% block app_content %}
<div class="container-fluid bg-light min-vh-100 p-4 p-md-5">
    
    {# HEADER #}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-5">
        <div>
            <h1 class="display-6 fw-bold text-dark mb-1">{{ survey.title }}</h1>
            <p class="text-muted mb-0">
                <i class="bi bi-bar-chart-line-fill me-1"></i> Dashboard Inteligente &bull; 
                <span class="fw-medium text-dark">{{ total_respuestas|intcomma }}</span> respuestas
            </p>
        </div>
        <div class="d-flex gap-2 mt-3 mt-md-0">
            <button class="btn btn-white border shadow-sm text-dark fw-medium" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                <i class="bi bi-filter"></i> Filtros
            </button>
            <a href="{% url 'reports' %}?public_id={{ survey.public_id }}" class="btn btn-dark fw-medium shadow-sm">
                <i class="bi bi-file-earmark-arrow-down me-1"></i> Exportar
            </a>
        </div>
    </div>

    {# FILTROS #}
    <div class="collapse mb-5" id="filtersCollapse">
        <div class="card card-body border-0 shadow-sm rounded-4 p-4">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-uppercase text-muted">Desde</label>
                    <input type="date" name="start" class="form-control bg-light border-0" value="{{ filter_start }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-uppercase text-muted">Hasta</label>
                    <input type="date" name="end" class="form-control bg-light border-0" value="{{ filter_end }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-uppercase text-muted">Segmentar</label>
                    <select name="segment_col" class="form-select bg-light border-0">
                        <option value="">Todo el público</option>
                        {% for p in preguntas_filtro %}
                            <option value="{{ p.id }}" {% if filter_col == p.id|stringformat:"s" %}selected{% endif %}>
                                {{ p.text|truncatechars:30 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Actualizar Datos</button>
                </div>
            </form>
        </div>
    </div>

    {# KPI GLOBAL #}
    <div class="row g-4 mb-5">
        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm h-100 bg-dark text-white overflow-hidden position-relative rounded-4">
                <div class="position-absolute top-0 end-0 opacity-10 p-3">
                    <i class="bi bi-trophy-fill" style="font-size: 8rem;"></i>
                </div>
                <div class="card-body p-4 d-flex flex-column justify-content-center">
                    <h6 class="text-uppercase opacity-75 fw-bold mb-3">Satisfacción General</h6>
                    <div class="d-flex align-items-baseline">
                        <span class="display-3 fw-bold">{{ kpi_score }}</span>
                        <span class="fs-4 ms-2 opacity-50">/ 10</span>
                    </div>
                    <div class="mt-3">
                        <div class="progress" style="height: 6px; background: rgba(255,255,255,0.2);">
                            <div class="progress-bar bg-white" role="progressbar" 
                                 style="width: {% widthratio kpi_score 10 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-8">
            <div class="card border-0 shadow-sm h-100 rounded-4">
                <div class="card-body p-4">
                    <h6 class="fw-bold text-muted text-uppercase mb-4">Evolución de Respuestas</h6>
                    <div style="height: 200px; width: 100%;">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# GRID DE INSIGHTS #}
    <h5 class="fw-bold text-dark mb-4 ps-1">Análisis Detallado</h5>
    <div class="row g-4">
        {% for item in analysis_data %}
            <div class="col-md-6 col-xl-4">
                {% include "surveys/components/insight_card.html" with data=item scale_max=item.insight_data.max %}
            </div>
        {% empty %}
            <div class="col-12 py-5 text-center">
                <div class="text-muted mb-3"><i class="bi bi-inbox fs-1"></i></div>
                <h5 class="fw-normal text-muted">No hay datos que coincidan con los filtros.</h5>
            </div>
        {% endfor %}
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. GLOBAL EVOLUTION
        const evolCtx = document.getElementById('evolutionChart');
        if (evolCtx) {
            const evolData = JSON.parse('{{ evolution_chart|escapejs }}');
            new Chart(evolCtx, {
                type: 'line',
                data: {
                    labels: evolData.labels || [],
                    datasets: [{
                        label: 'Respuestas',
                        data: evolData.data || [],
                        borderColor: '#0d6efd',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
                            gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { grid: { display: false } },
                        y: { beginAtZero: true, border: { display: false } }
                    }
                }
            });
        }

        // 2. MINI CHARTS REGISTRY
        if (window.chartRegistry) {
            window.chartRegistry.forEach(chartItem => {
                const ctx = document.getElementById(chartItem.id);
                if (!ctx) return;

                const rawData = JSON.parse(document.getElementById(chartItem.dataId).textContent);
                let chartConfig = {};

                // --- CONFIGURACIÓN DINÁMICA ---
                
                if (chartItem.isDemographic) {
                    // DEMOGRÁFICOS = DONUT
                    chartConfig = {
                        type: 'doughnut',
                        data: {
                            labels: rawData.labels,
                            datasets: [{
                                data: rawData.data,
                                backgroundColor: [
                                    '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                                    '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                                ],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: { 
                                legend: { 
                                    display: true, 
                                    position: 'right',
                                    labels: { boxWidth: 10, font: { size: 10 }, usePointStyle: true }
                                } 
                            }
                        }
                    };

                } else if (chartItem.type === 'numeric' || chartItem.type === 'scale') {
                    // NUMÉRICOS = BARRAS VERTICALES
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: rawData.labels,
                            datasets: [{
                                data: rawData.data,
                                backgroundColor: '#0d6efd',
                                borderRadius: 4,
                                barThickness: 'flex',
                                maxBarThickness: 15
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false, beginAtZero: true }
                            }
                        }
                    };

                } else if (chartItem.type === 'single' || chartItem.type === 'multi') {
                    // CATEGÓRICAS NO DEMOGRÁFICAS = BARRAS HORIZONTALES
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: rawData.labels,
                            datasets: [{
                                data: rawData.data,
                                backgroundColor: '#198754', // Verde para opciones
                                borderRadius: 4,
                                barThickness: 12
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false, beginAtZero: true },
                                y: { 
                                    grid: { display: false, drawBorder: false },
                                    ticks: { font: { size: 11 }, autoSkip: false }
                                }
                            }
                        }
                    };
                }

                if (chartConfig.type) {
                    new Chart(ctx, chartConfig);
                }
            });
        }
    });
</script>
{% endblock %}