{% extends 'app_base.html' %}
{% load static %}

{% block title %}Mis Encuestas | Byteneko{% endblock %}

{% block app_content %}
{# --- MODALES INCLUIDOS --- #}
{% include 'surveys/modals/delete_selected_modal.html' %}
{% include 'surveys/modals/delete_all_modal.html' %}
{% include 'surveys/modals/delete_one_modal.html' %}
{% include 'surveys/modals/announcement_modal.html' %}

<div class="modal fade" id="importModalPreview" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-content border-0 shadow-lg overflow-hidden">
            <div class="modal-header border-0 bg-body-tertiary py-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-primary text-white me-3 shadow-sm">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-body-emphasis mb-0">Asistente de Importación</h5>
                        <small class="text-muted">Sube tus datos y valida la estructura.</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close-import-modal-header"></button>
            </div>

            <div id="step1-upload" class="modal-body p-4 p-lg-5">
                <div class="text-center mb-4">
                    <h4 class="fw-bold text-body-emphasis">Sube tu archivo CSV</h4>
                    <p class="text-muted col-lg-8 mx-auto">
                        Arrastra tus archivos aquí o haz clic para explorar. <br>
                        <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle rounded-pill mt-2">Soporta .csv UTF-8</span>
                    </p>
                </div>

                <div class="card border-dashed bg-body-tertiary mb-4 mx-auto position-relative overflow-hidden transition-all" 
                     id="upload-drop-zone" 
                     style="max-width: 700px; cursor: pointer; min-height: 250px;">
                    
                    <div class="card-body p-5 text-center d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="mb-3 text-primary opacity-50 icon-bounce">
                            <i class="bi bi-cloud-arrow-up" style="font-size: 3.5rem;"></i>
                        </div>
                        <h5 class="fw-bold mb-2 text-body-emphasis">Arrastra y suelta aquí</h5>
                        <p class="text-muted mb-4 small">o</p>
                        
                        <button type="button" class="btn btn-primary shadow-sm px-4 fw-medium" onclick="document.getElementById('csvFileInput').click()">
                            <i class="bi bi-folder2-open me-2"></i>Explorar Archivos
                        </button>
                        
                        <input class="form-control d-none" type="file" id="csvFileInput" accept=".csv" multiple required>

                        <div id="fileList" class="mt-4 small text-muted fst-italic transition-all">Ningún archivo seleccionado</div>
                        
                        <div class="form-text mt-3 text-body-secondary">
                            <i class="bi bi-info-circle me-1"></i> La primera fila debe contener encabezados.
                            <div class="text-danger fw-semibold mt-1 animate-fade-in" id="multi-file-warning" style="display:none;">
                                <i class="bi bi-exclamation-triangle"></i> Múltiples archivos: Se omitirá la vista previa.
                            </div>
                        </div>
                    </div>

                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center backdrop-blur-sm" 
                         id="drop-zone-overlay" 
                         style="pointer-events: none; opacity: 0; transition: all 0.2s ease; z-index: 10;">
                        <div class="bg-body px-4 py-3 rounded-pill shadow-sm text-primary fw-bold fs-5 border border-primary">
                            <i class="bi bi-download me-2"></i>¡Suéltalos aquí!
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <label class="form-label fw-bold small text-uppercase text-muted tracking-wide">
                            Nombre del Proyecto (Opcional)
                        </label>
                        <input type="text" class="form-control form-control-lg bg-body-tertiary"
                                <button type="submit" class="btn btn-outline-primary border-0 px-3" title="Buscar">
                                    <i class="bi bi-search"></i>
                                </button>
                               id="surveyTitleInput"
                               placeholder="Ej. Análisis de Mercado 2025"
                               maxlength="255">
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-3 mt-5">
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary btn-lg px-5 shadow-sm" id="btn-analyze" disabled>
                        <i class="bi bi-magic me-2"></i>Analizar Archivo
                    </button>
                </div>
            </div>

            <div id="step2-preview" class="modal-body p-0" style="display:none;">
                <div class="bg-body-tertiary border-bottom px-4 py-3">
                    <div class="row align-items-center g-3">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                <div>
                                    <h6 class="fw-bold mb-0 text-success">Archivo Validado</h6>
                                    <div class="small text-body-secondary text-truncate" style="max-width: 400px;" id="preview-filename">archivo.csv</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                             <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-back-to-upload">
                                <i class="bi bi-arrow-left me-1"></i>Reemplazar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-0" style="height: 65vh; min-height: 500px;">
                    <div class="col-lg-3 border-end bg-body-tertiary p-4 d-flex flex-column gap-3 overflow-auto">
                        <h6 class="fw-bold text-uppercase text-muted small mb-2 tracking-wide">Resumen</h6>
                        
                        <div class="card border-0 shadow-sm mb-2 bg-body">
                            <div class="card-body p-3 d-flex align-items-center gap-3">
                                <div class="rounded-3 bg-primary-subtle text-primary-emphasis p-2">
                                    <i class="bi bi-list-ol fs-4"></i>
                                </div>
                                <div>
                                    <div class="h4 fw-bold mb-0 text-body-emphasis" id="preview-total-rows">0</div>
                                    <div class="small text-muted">Respuestas</div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-2 bg-body">
                            <div class="card-body p-3 d-flex align-items-center gap-3">
                                <div class="rounded-3 bg-success-subtle text-success-emphasis p-2">
                                    <i class="bi bi-columns fs-4"></i>
                                </div>
                                <div>
                                    <div class="h4 fw-bold mb-0 text-body-emphasis" id="preview-total-questions">0</div>
                                    <div class="small text-muted">Columnas</div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info border-0 shadow-sm small mb-0 mt-auto bg-info-subtle text-info-emphasis">
                            <i class="bi bi-lightbulb-fill me-1"></i>
                            <strong>Tip:</strong> Verifica los tipos de datos en la pestaña "Estructura" antes de importar.
                        </div>
                    </div>

                    <div class="col-lg-9 d-flex flex-column h-100 bg-body">
                        <ul class="nav nav-tabs nav-fill px-3 pt-3 border-bottom-0" id="previewTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-medium" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure-pane" type="button">
                                    <i class="bi bi-diagram-3 me-2"></i>Estructura
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-medium" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button">
                                    <i class="bi bi-table me-2"></i>Datos
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content flex-grow-1 overflow-hidden border-top position-relative" id="previewTabsContent">
                            <div class="tab-pane fade show active h-100 overflow-auto p-0" id="structure-pane">
                                <table class="table table-hover table-striped mb-0 align-middle w-100">
                                    <thead class="sticky-top shadow-sm bg-body-tertiary">
                                        <tr>
                                            <th class="ps-4 bg-body-tertiary" style="width: 50px;">#</th>
                                            <th class="bg-body-tertiary">Columna</th>
                                            <th class="bg-body-tertiary">Tipo</th>
                                            <th class="text-center bg-body-tertiary">Únicos</th>
                                            <th class="bg-body-tertiary">Muestra</th>
                                        </tr>
                                    </thead>
                                    <tbody id="preview-columns-table"></tbody>
                                </table>
                            </div>

                            <div class="tab-pane fade h-100 overflow-auto p-0" id="data-pane">
                                <div class="table-responsive h-100">
                                    <table class="table table-sm table-bordered mb-0 spreadsheet-table">
                                        <thead class="sticky-top bg-body-tertiary" id="preview-sample-header"></thead>
                                        <tbody id="preview-sample-body" class="font-monospace small text-body-secondary"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-top p-3 bg-body-tertiary d-flex justify-content-end gap-2">
                             <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-success px-4 fw-bold shadow-sm" id="btn-import-confirm">
                                <i class="bi bi-check-lg me-2"></i>Confirmar e Importar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="step-loading" class="modal-body text-center py-5" style="display:none;">
                <div class="py-5">
                    <div class="spinner-grow text-primary mb-4" style="width: 4rem; height: 4rem;" role="status"></div>
                    <h4 class="fw-bold text-body-emphasis mb-2" id="loading-title">Procesando...</h4>
                    <p class="text-muted mb-4" id="loading-text">Espera mientras analizamos tus datos.</p>
                    <div class="progress mx-auto shadow-sm bg-body-secondary" style="max-width: 400px; height: 10px; border-radius: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div id="step-error" class="modal-body py-5 text-center" style="display:none;">
                <div class="mb-3 text-danger"><i class="bi bi-x-circle-fill" style="font-size: 4rem;"></i></div>
                <h4 class="fw-bold text-danger mb-3">Error en la importación</h4>
                <div class="alert alert-danger d-inline-block text-start shadow-sm" style="max-width: 80%;">
                    <i class="bi bi-bug me-2"></i><span id="error-message">Error desconocido</span>
                </div>
                <div class="mt-4">
                    <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Cerrar</button>
                    <button type="button" class="btn btn-outline-primary" id="btn-retry-upload">Intentar de nuevo</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-xl p-4 p-md-5">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="h2 fw-bold mb-1 text-body-emphasis">Mis Proyectos</h1>
            <p class="text-muted mb-0">Gestiona y organiza tus estudios de mercado.</p>
        </div>
        <div class="d-flex gap-2 flex-wrap justify-content-md-end">
            <button type="button"
                    class="btn btn-outline-secondary border-dashed fw-medium shadow-sm hover-lift"
                    data-bs-toggle="modal"
                    data-bs-target="#importModalPreview"
                    title="Importar CSV">
                <i class="bi bi-cloud-upload me-2"></i>Importar CSV
            </button>
            <a href="{% url 'surveys:create' %}" class="btn btn-primary fw-medium shadow-sm px-4 hover-lift">
                <i class="bi bi-plus-lg me-2"></i>Crear Encuesta
            </a>
            <button type="button"
                    class="btn btn-outline-danger fw-medium"
                    id="toggleSelectionBtn"
                    title="Seleccionar múltiples encuestas">
                <i class="bi bi-check2-square me-1"></i>Seleccionar
            </button>
        </div>
    </div>

    <div id="pageAlert" class="alert alert-success d-none mb-4 shadow-sm border-0" role="alert">
        <strong id="pageAlertTitle"></strong><span id="pageAlertBody" class="ms-2"></span>
    </div>
    
    <div class="card border-0 shadow-sm mb-4 bg-body-tertiary">
        <div class="card-body p-2">
            <form method="get" class="row g-2 align-items-center">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control border-0 bg-body-tertiary search-input py-2" 
                               placeholder="Buscar por título..." 
                               value="{{ request.GET.q|default_if_none:'' }}">
                        <button type="submit" class="btn btn-outline-primary border-0 px-3" title="Buscar" style="z-index:2;">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <select name="status" class="form-select border-0 bg-body-tertiary py-2" onchange="this.form.submit()">
                        <option value="">Todos los estados</option>
                        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Activas</option>
                        <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Borradores</option>
                        <option value="closed" {% if request.GET.status == 'closed' %}selected{% endif %}>Cerradas</option>
                        <option value="paused" {% if request.GET.status == 'paused' %}selected{% endif %}>En pausa</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div id="bulkActionsBar"
        class="alert alert-warning d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 bulk-actions-bar-custom shadow-sm"
        style="display:none !important;">
        <div class="d-flex align-items-center mb-2 mb-md-0 gap-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span class="small">
                <strong><span id="selectedCountSpan">0</span> encuestas seleccionadas.</strong>
            </span>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-sm btn-light border" id="selectAllBtn">Todas</button>
            <button type="button" class="btn btn-sm btn-light border" id="deselectAllBtn" style="display:none;">Nada</button>
            <button type="button" class="btn btn-sm btn-danger shadow-sm" id="deleteSelectedBtn">
                <i class="bi bi-trash-fill me-1"></i>Eliminar Selección
            </button>
            <button type="button" class="btn btn-sm btn-danger shadow-sm" id="deleteAllBtn">
                <i class="bi bi-trash3-fill me-1"></i>Eliminar TODO
            </button>
            <button type="button" class="btn btn-sm btn-dark" id="cancelSelectionBtn">Cancelar</button>
        </div>
    </div>

    {% if surveys %}
        <div class="row g-4">
            {% for survey in surveys %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 survey-card border-0 shadow-sm overflow-hidden" data-survey-id="{{ survey.pk }}">
                    
                    <div class="position-absolute top-0 start-0 mt-3 ms-3 selection-checkbox" style="z-index: 10; display: none;">
                        <button type="button" class="btn btn-sm survey-select-btn js-select-survey-btn"
                                data-survey-id="{{ survey.pk }}"
                                style="width: 36px; height: 36px; border-radius: 8px; padding: 0; border: 2px solid var(--bs-border-color);">
                            <i class="bi bi-circle" style="font-size: 1rem;"></i>
                        </button>
                    </div>

                    <div class="card-body d-flex flex-column p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill text-uppercase border border-primary-subtle" style="font-size: 0.7rem; letter-spacing: 0.5px; font-weight: 600;">
                                {{ survey.category|default:"General" }}
                            </span>
                            
                            <div class="d-flex align-items-center small">
                                {% if survey.is_imported %}
                                    <span class="badge rounded-pill bg-light text-dark border me-1" title="Importada"><i class="bi bi-filetype-csv"></i></span>
                                {% endif %}
                        {# Render insight/context if available #}
                        {% if survey.insight %}
                        <div class="analysis-card p-3 border border-success-subtle bg-success-subtle rounded-3 mb-3 overflow-auto" style="max-height: 140px; min-height: 48px;">
                            {% autoescape off %}{{ survey.insight }}{% endautoescape %}
                        </div>
                        {% endif %}

                                {% if survey.status == 'active' %}
                                    <span class="status-dot bg-success"></span><span class="text-success-emphasis fw-bold ms-1" style="font-size:0.8rem">Activa</span>
                                {% elif survey.status == 'paused' %}
                                    <span class="status-dot bg-warning"></span><span class="text-warning-emphasis fw-bold ms-1" style="font-size:0.8rem">Pausa</span>
                                {% elif survey.status == 'draft' %}
                                    <span class="status-dot bg-secondary"></span><span class="text-body-secondary ms-1" style="font-size:0.8rem">Borrador</span>
                                {% else %}
                                    <span class="status-dot bg-danger"></span><span class="text-danger-emphasis ms-1" style="font-size:0.8rem">Cerrada</span>
                                {% endif %}
                            </div>
                        </div>

                        <h5 class="card-title fw-bold text-body-emphasis mb-2 text-truncate" title="{{ survey.title }}">
                            <a href="{% url 'surveys:detail' survey.public_id %}" class="text-decoration-none text-reset stretched-link hover-underline-animation">
                                {{ survey.title }}
                            </a>
                        </h5>

                        <p class="card-text text-body-secondary small flex-grow-1 mb-4 text-truncate-2">
                            {{ survey.description|default:"Sin descripción adicional." }}
                        </p>

                        <div class="mb-4">
                            {% if survey.sample_goal > 0 %}
                                <div class="d-flex justify-content-between align-items-center mb-1 small">
                                    <span class="text-muted fw-medium">Progreso de Muestra</span>
                                    <span class="text-primary fw-bold">{{ survey.total_responses }} <span class="text-muted fw-normal">/ {{ survey.sample_goal }}</span></span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    {% widthratio survey.total_responses survey.sample_goal 100 as progress_percent %}
                                    <div class="progress-bar bg-primary rounded-pill" role="progressbar" style="width: {{ progress_percent }}%" aria-valuenow="{{ survey.total_responses }}" aria-valuemin="0" aria-valuemax="{{ survey.sample_goal }}"></div>
                                </div>
                            {% else %}
                                <div class="row g-2 text-center">
                                    <div class="col-6">
                                        <div class="p-2 rounded-3 bg-body-tertiary border border-dashed h-100">
                                            <div class="h5 fw-bold text-body-emphasis mb-0">{{ survey.total_responses }}</div>
                                            <div class="small text-muted" style="font-size: 0.75rem;">Respuestas</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 rounded-3 bg-body-tertiary border border-dashed h-100">
                                            <div class="h5 fw-bold text-body-emphasis mb-0">{{ survey.total_questions|default:"0" }}</div>
                                            <div class="small text-muted" style="font-size: 0.75rem;">Preguntas</div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top border-light-subtle">
                             <div class="small text-body-secondary d-flex align-items-center" title="Fecha de creación">
                                <i class="bi bi-calendar3 me-2 opacity-50"></i>{{ survey.created_at|date:"d M Y" }}
                             </div>
                             
                             <div class="d-flex gap-2 position-relative" style="z-index: 2;">
                                 <a href="{% url 'surveys:results' survey.public_id %}" 
                                    class="btn btn-sm btn-light border text-body-secondary hover-primary shadow-sm" 
                                    data-bs-toggle="tooltip" title="Ver Resultados">
                                    <i class="bi bi-bar-chart-fill"></i>
                                </a>
                                 <a href="{% url 'surveys:edit' survey.public_id %}" 
                                    class="btn btn-sm btn-light border text-body-secondary hover-primary shadow-sm" 
                                    data-bs-toggle="tooltip" title="Configuración">
                                    <i class="bi bi-gear-fill"></i>
                                </a>
                                <button type="button" 
                                        class="btn btn-sm btn-light border text-danger hover-danger shadow-sm js-delete-survey-btn"
                                        data-action="delete-survey" 
                                        data-survey-id="{{ survey.pk }}"
                                        data-bs-toggle="tooltip" title="Eliminar">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                             </div>
                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-5">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link border-0 rounded-pill px-3 me-1 shadow-sm bg-body-tertiary text-body" 
                       href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                        <i class="bi bi-chevron-left"></i> Anterior
                    </a>
                </li>
                {% endif %}
                <li class="page-item disabled">
                    <span class="page-link border-0 bg-transparent fw-bold mx-2 text-muted">
                        {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link border-0 rounded-pill px-3 ms-1 shadow-sm bg-body-tertiary text-body" 
                       href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                        Siguiente <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <div class="text-center py-5 my-5" id="surveys-empty-state">
            <div class="mb-4">
                <div class="bg-body-tertiary rounded-circle d-inline-flex align-items-center justify-content-center border border-dashed animate-float" style="width: 120px; height: 120px;">
                    <i class="bi bi-folder2-open text-muted opacity-50" style="font-size: 3.5rem;"></i>
                </div>
            </div>
            <h3 class="fw-bold text-body-emphasis mb-2">No tienes encuestas aún</h3>
            <p class="text-muted mb-4 col-md-6 mx-auto">
                {% if request.GET.q or request.GET.status %}
                    No se encontraron resultados.
                {% else %}
                    Comienza creando una encuesta desde cero o importando datos existentes.
                {% endif %}
            </p>
            <div class="d-flex justify-content-center gap-3">
                <a href="{% url 'surveys:create' %}" class="btn btn-primary btn-lg px-4 shadow-sm hover-lift">
                    <i class="bi bi-plus-lg me-2"></i>Crear Nueva
                </a>
                <button class="btn btn-outline-secondary btn-lg px-4 shadow-sm hover-lift"
                        data-bs-toggle="modal" data-bs-target="#importModalPreview">
                    Importar CSV
                </button>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function createFloatingProgressBar() {
    let bar = document.getElementById('floating-progress-bar');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'floating-progress-bar';
        bar.className = 'shadow-lg bg-body border';
        bar.style.position = 'fixed';
        bar.style.bottom = '30px';
        bar.style.right = '30px';
        bar.style.zIndex = '1080';
        bar.style.borderRadius = '16px';
        bar.style.padding = '16px 24px';
        bar.style.display = 'flex';
        bar.style.alignItems = 'center';
        bar.style.gap = '16px';
        bar.innerHTML = `
            <div class="d-flex align-items-center gap-3">
                <div class="spinner-border text-primary" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
                <div>
                    <div id="floating-progress-title" class="fw-bold text-body-emphasis" style="font-size:0.95rem">Importando...</div>
                    <div id="floating-progress-text" class="text-body-secondary small">Procesando en segundo plano</div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="restore-progress-modal" title="Maximizar">
                <i class="bi bi-arrows-angle-expand"></i>
            </button>
        `;
        document.body.appendChild(bar);
    }
    return bar;
}

function saveFloatingProgressState(title, text) {
    localStorage.setItem('import_progress_minimized', '1');
    localStorage.setItem('import_progress_title', title || 'Importando...');
    localStorage.setItem('import_progress_text', text || 'Procesando...');
}
function clearFloatingProgressState() {
    localStorage.removeItem('import_progress_minimized');
    localStorage.removeItem('import_progress_title');
    localStorage.removeItem('import_progress_text');
}
function restoreFloatingProgressIfNeeded() {
    if (localStorage.getItem('import_progress_minimized') === '1') {
        const bar = createFloatingProgressBar();
        document.getElementById('floating-progress-title').textContent = localStorage.getItem('import_progress_title') || 'Importando...';
        document.getElementById('floating-progress-text').textContent = localStorage.getItem('import_progress_text') || 'Procesando...';
        bar.style.display = 'flex';
    }
}
let progressModalInstance = null;
function restoreProgressModal() {
    const modalEl = document.getElementById('importModalPreview');
    if (!progressModalInstance) progressModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    progressModalInstance.show();
    const bar = document.getElementById('floating-progress-bar');
    if (bar) bar.style.display = 'none';
    clearFloatingProgressState();
}

document.addEventListener('DOMContentLoaded', function() {
    const importModalEl = document.getElementById('importModalPreview');
    if (importModalEl) {
        bootstrap.Modal.getOrCreateInstance(importModalEl, {backdrop: 'static', keyboard: false});
    }
    restoreFloatingProgressIfNeeded();
    document.body.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('#restore-progress-modal')) restoreProgressModal();
    });
    
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
});

// Utils
let pageAlertTimeoutId = null;
function showPageAlert(type, title, body, durationMs) {
    const box = document.getElementById('pageAlert');
    const tEl = document.getElementById('pageAlertTitle');
    const bEl = document.getElementById('pageAlertBody');
    if (!box) return;
    
    box.className = `alert alert-${type || 'info'} d-flex align-items-center mb-4 shadow-sm border-0`;
    box.classList.remove('d-none');
    tEl.textContent = title || '';
    bEl.textContent = body || '';

    if (pageAlertTimeoutId) clearTimeout(pageAlertTimeoutId);
    if (durationMs !== 0) {
        pageAlertTimeoutId = setTimeout(() => box.classList.add('d-none'), durationMs || 5000);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Polling
window.pollDeleteTask = async function(taskId) {
    const statusUrl = "{% url 'surveys:delete_task_status' 'TASK_ID_PLACEHOLDER' %}".replace('TASK_ID_PLACEHOLDER', taskId);
    const start = Date.now();
    while (Date.now() - start < 120000) {
        try {
            const res = await fetch(statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) break;
            const info = await res.json();
            if (info.ready && (info.status === 'SUCCESS' || info.status === 'success')) return info;
            if (info.error || (info.ready && info.status !== 'SUCCESS')) return info;
        } catch (e) { console.warn('Polling error', e); }
        await new Promise(r => setTimeout(r, 1500));
    }
    return false;
};

window.pollImportJob = async function(jobId) {
    const statusUrl = "{% url 'surveys:import_job_status' 0 %}".replace('/0/', `/${jobId}/`);
    const start = Date.now();
    while (Date.now() - start < 300000) {
        try {
            const res = await fetch(statusUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) break;
            const info = await res.json();
            if (info.status === 'completed') return true;
            if (info.status === 'failed' || info.error_message) return false;
        } catch (e) { console.warn('Polling error', e); }
        await new Promise(r => setTimeout(r, 1500));
    }
    return false;
};

window.addEventListener('pageshow', function(event) {
    if (event.persisted) window.location.reload();
});
</script>

<script>
// JS: Selección Múltiple
document.addEventListener('DOMContentLoaded', function () {
    const toggleSelectionBtn = document.getElementById('toggleSelectionBtn');
    const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');
    const bulkActionsBar     = document.getElementById('bulkActionsBar');
    const selectedCountSpan  = document.getElementById('selectedCountSpan');
    const selectAllBtn       = document.getElementById('selectAllBtn');
    const deselectAllBtn     = document.getElementById('deselectAllBtn');
    const deleteSelectedBtn  = document.getElementById('deleteSelectedBtn');
    const deleteAllBtn       = document.getElementById('deleteAllBtn');

    function getSelectBtns() { return Array.from(document.querySelectorAll('.js-select-survey-btn')); }
    function getCards() { return Array.from(document.querySelectorAll('.survey-card')); }

    if (!toggleSelectionBtn || !bulkActionsBar) return;
    if (getCards().length === 0) {
        toggleSelectionBtn.disabled = true;
        toggleSelectionBtn.classList.add('disabled', 'opacity-50');
        return;
    }

    const selectedSurveys = new Set();
    let selectionMode = false;
    let skipConfirmBulk = false;

    function updateSelectionUI() {
        const selectBtns = getSelectBtns();
        const count = selectedSurveys.size;
        selectedCountSpan.textContent = count;
        
        if (selectionMode) {
            bulkActionsBar.style.display = 'flex';
            bulkActionsBar.classList.remove('d-none');
            document.querySelectorAll('.selection-checkbox').forEach(el => el.style.display = 'block');
        } else {
            bulkActionsBar.style.display = 'none';
            bulkActionsBar.classList.add('d-none');
            document.querySelectorAll('.selection-checkbox').forEach(el => el.style.display = 'none');
        }

        const allSelected = (selectBtns.length > 0) && (count === selectBtns.length);
        if (selectAllBtn && deselectAllBtn) {
            selectAllBtn.style.display   = allSelected ? 'none' : 'inline-block';
            deselectAllBtn.style.display = allSelected ? 'inline-block' : 'none';
        }
    }

    function toggleSelectionMode(forceOff = false) {
        selectionMode = forceOff ? false : true;
        document.body.classList.toggle('survey-selection-mode', selectionMode);
        if (!selectionMode) {
            selectedSurveys.clear();
            getSelectBtns().forEach(btn => {
                btn.classList.remove('selected', 'btn-primary');
                btn.querySelector('i').className = 'bi bi-circle';
            });
        }
        updateSelectionUI();
    }

    function toggleSurveySelection(surveyId, btn) {
        if (selectedSurveys.has(surveyId)) {
            selectedSurveys.delete(surveyId);
            btn.classList.remove('selected', 'btn-primary');
            btn.querySelector('i').className = 'bi bi-circle';
        } else {
            selectedSurveys.add(surveyId);
            btn.classList.add('selected', 'btn-primary');
            btn.querySelector('i').className = 'bi bi-check-circle-fill';
        }
        updateSelectionUI();
    }

    toggleSelectionBtn.addEventListener('click', () => toggleSelectionMode(false));
    cancelSelectionBtn.addEventListener('click', () => toggleSelectionMode(true));

    getCards().forEach(card => {
        card.onclick = function (e) {
            if (!selectionMode) return;
            if (e.target.closest('.js-select-survey-btn')) return;
            if (e.target.closest('a') && card.contains(e.target.closest('a'))) {
                e.preventDefault(); e.stopPropagation();
            }
            const btn = card.querySelector('.js-select-survey-btn');
            if (btn && btn.dataset.surveyId) toggleSurveySelection(btn.dataset.surveyId, btn);
        };
    });
    getSelectBtns().forEach(btn => {
        btn.onclick = function (e) {
            e.preventDefault(); e.stopPropagation();
            if (this.dataset.surveyId) toggleSurveySelection(this.dataset.surveyId, this);
        };
    });

    if (selectAllBtn) {
        selectAllBtn.onclick = function () {
            getSelectBtns().forEach(btn => {
                const sid = btn.dataset.surveyId;
                if (!selectedSurveys.has(sid)) selectedSurveys.add(sid);
                btn.classList.add('selected', 'btn-primary');
                btn.querySelector('i').className = 'bi bi-check-circle-fill';
            });
            updateSelectionUI();
        };
    }
    if (deselectAllBtn) {
        deselectAllBtn.onclick = function () {
            selectedSurveys.clear();
            getSelectBtns().forEach(btn => {
                btn.classList.remove('selected', 'btn-primary');
                btn.querySelector('i').className = 'bi bi-circle';
            });
            updateSelectionUI();
        };
    }

    deleteSelectedBtn.onclick = async function () {
        if (selectedSurveys.size === 0) return showPageAlert('warning', 'Atención', 'Selecciona al menos una encuesta.', 4000);
        
        if (!skipConfirmBulk) {
            const deleteSelectedModal = document.getElementById('deleteSelectedModal');
            if (!deleteSelectedModal) {
                if (!confirm(`¿Eliminar ${selectedSurveys.size} encuestas?`)) return;
            } else {
                document.getElementById('deleteSelectedCount').textContent = selectedSurveys.size;
                const modal = new bootstrap.Modal(deleteSelectedModal);
                const confirmed = await new Promise(resolve => {
                    const btn = document.getElementById('confirmDeleteSelectedBtn');
                    const handler = () => { modal.hide(); resolve(true); btn.removeEventListener('click', handler); };
                    btn.addEventListener('click', handler);
                    deleteSelectedModal.addEventListener('hidden.bs.modal', () => resolve(false), {once:true});
                    modal.show();
                });
                if (!confirmed) return;
            }
        }
        
        skipConfirmBulk = false;
        const originalHtml = deleteSelectedBtn.innerHTML;
        deleteSelectedBtn.disabled = true;
        deleteSelectedBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>';

        const ids = Array.from(selectedSurveys);
        const cardsToDelete = ids.map(id => document.querySelector(`.survey-card[data-survey-id="${id}"]`)).filter(c=>c);
        cardsToDelete.forEach(c => c.classList.add('survey-card--deleting'));

        try {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken') || '{{ csrf_token }}');
            ids.forEach(id => formData.append('survey_ids', id));
            
            const res = await fetch("{% url 'surveys:bulk_delete' %}", { 
                method: 'POST', 
                body: formData, 
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!res.ok) throw new Error(await res.text());
            
            const data = await res.json();
            if (data.success === false) throw new Error(data.error);
            if (data.task_id) await pollDeleteTask(data.task_id);

            cardsToDelete.forEach(c => c.closest('.col-md-6').classList.add('col-removing'));
            setTimeout(() => window.location.reload(), 500);
        } catch (err) {
            console.error(err);
            cardsToDelete.forEach(c => c.classList.remove('survey-card--deleting'));
            showPageAlert('danger', 'Error', 'Falló la eliminación en lote.', 5000);
        } finally {
            deleteSelectedBtn.disabled = false;
            deleteSelectedBtn.innerHTML = originalHtml;
        }
    };

    if (deleteAllBtn) {
        deleteAllBtn.onclick = function() {
            const total = getCards().length;
            document.getElementById('deleteAllCount').textContent = total;
            const modal = new bootstrap.Modal(document.getElementById('deleteAllModal'));
            modal.show();
            document.getElementById('confirmDeleteAllBtn').onclick = function() {
                selectAllBtn.click();
                skipConfirmBulk = true;
                modal.hide();
                setTimeout(() => deleteSelectedBtn.click(), 200);
            };
        };
    }
});

// Single Delete
document.addEventListener('click', async function(e) {
    const btn = e.target.closest('[data-action="delete-survey"]');
    if (!btn) return;
    e.preventDefault();
    const surveyId = btn.dataset.surveyId;

    const modal = new bootstrap.Modal(document.getElementById('deleteOneModal'));
    modal.show();
    
    document.getElementById('confirmDeleteOneBtn').onclick = async function() {
        modal.hide();
        const card = btn.closest('.survey-card');
        card.classList.add('survey-card--deleting');
        
        try {
            const formData = new URLSearchParams();
            formData.append('survey_ids', surveyId);
            const res = await fetch("{% url 'surveys:bulk_delete' %}", {
                method: 'POST',
                headers: { 
                    'X-CSRFToken': getCookie('csrftoken'), 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData.toString()
            });
            const data = await res.json();
            if (data.task_id) await pollDeleteTask(data.task_id);
            
            card.closest('.col-md-6').classList.add('col-removing');
            setTimeout(() => {
                if (document.querySelectorAll('.survey-card').length <= 1) window.location.reload();
                else card.closest('.col-md-6').remove();
            }, 300);
        } catch (err) {
            card.classList.remove('survey-card--deleting');
            showPageAlert('danger', 'Error', 'No se pudo eliminar.', 3000);
        }
    };
});
</script>

<script>
// JS: Importación CSV (CON DRAG & DROP LOGIC)
document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('importModalPreview');
    if (!modalElement) return;

    const fileInput = document.getElementById('csvFileInput');
    const titleInput = document.getElementById('surveyTitleInput');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnConfirm = document.getElementById('btn-import-confirm');
    const btnBack = document.getElementById('btn-back-to-upload');
    const btnRetry = document.getElementById('btn-retry-upload');
    const multiWarning = document.getElementById('multi-file-warning');
    const fileListDisplay = document.getElementById('fileList');
    
    // Drop Zone Elements
    const dropZone = document.getElementById('upload-drop-zone');
    const dropOverlay = document.getElementById('drop-zone-overlay');

    const totalRowsEl = document.getElementById('preview-total-rows');
    const totalColsEl = document.getElementById('preview-total-questions');
    const filenameEl = document.getElementById('preview-filename');
    const columnsTable = document.getElementById('preview-columns-table');
    const sampleHeaderEl = document.getElementById('preview-sample-header');
    const sampleBodyEl = document.getElementById('preview-sample-body');

    // --- Drag & Drop Logic ---
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') {
                fileInput.click();
            }
        });
    }

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        dropZone.classList.add('border-primary', 'bg-body-secondary');
        if (dropOverlay) dropOverlay.style.opacity = '1';
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-primary', 'bg-body-secondary');
        if (dropOverlay) dropOverlay.style.opacity = '0';
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    }

    function showStep(stepName) {
        ['step1-upload', 'step2-preview', 'step-loading', 'step-error'].forEach(id => {
            document.getElementById(id).style.display = (id === stepName) ? 'block' : 'none';
        });
        modalElement.classList.toggle('modal-blocked', stepName === 'step-loading');
    }

    function showError(msg) {
        document.getElementById('error-message').textContent = msg;
        showStep('step-error');
    }

    modalElement.addEventListener('show.bs.modal', () => {
        fileInput.value = '';
        titleInput.value = '';
        fileListDisplay.textContent = 'Ningún archivo seleccionado';
        btnAnalyze.disabled = true;
        showStep('step1-upload');
    });

    fileInput.addEventListener('change', function() {
        const count = this.files.length;
        if (count > 0) {
            fileListDisplay.textContent = count === 1 ? this.files[0].name : `${count} archivos seleccionados`;
            fileListDisplay.className = 'mt-4 small fw-bold text-primary animate-fade-in';
            btnAnalyze.disabled = false;
        } else {
            fileListDisplay.textContent = 'Ningún archivo seleccionado';
            fileListDisplay.className = 'mt-4 small text-muted fst-italic';
            btnAnalyze.disabled = true;
        }
        
        if (count > 1) {
            btnAnalyze.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Importar Todos';
            multiWarning.style.display = 'block';
        } else {
            btnAnalyze.innerHTML = '<i class="bi bi-magic me-2"></i>Analizar Archivo';
            multiWarning.style.display = 'none';
        }
    });

    function renderPreview(data) {
        totalRowsEl.textContent = data.total_rows ?? 0;
        totalColsEl.textContent = (data.columns || []).filter(c => !c.is_metadata).length;
        filenameEl.textContent = data.filename || 'Archivo CSV';

        columnsTable.innerHTML = '';
        (data.columns || []).forEach((col, idx) => {
            let typeBadge = '<span class="badge bg-secondary-subtle text-secondary-emphasis border">Texto</span>';
            if (col.type === 'number' || col.type === 'integer') typeBadge = '<span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle">Numérico</span>';
            if (col.type === 'date') typeBadge = '<span class="badge bg-info-subtle text-info-emphasis border border-info-subtle">Fecha</span>';

            columnsTable.innerHTML += `
                <tr>
                    <td class="text-center text-body-secondary small">${idx + 1}</td>
                    <td class="fw-medium text-body-emphasis">${col.name}</td>
                    <td>${typeBadge}</td>
                    <td class="text-center"><span class="badge bg-body-secondary text-body-secondary border">${col.unique_values || '-'}</span></td>
                    <td class="text-body-secondary small text-truncate" style="max-width: 200px;">${(col.sample_values || []).join(', ')}</td>
                </tr>
            `;
        });

        if (data.columns && data.sample_rows) {
            sampleHeaderEl.innerHTML = '<tr>' + data.columns.map(c => `<th class="bg-body-tertiary text-body-secondary text-uppercase" style="font-size:0.75rem;">${c.display_name}</th>`).join('') + '</tr>';
            sampleBodyEl.innerHTML = '';
            data.sample_rows.forEach(row => {
                const tds = row.map(val => `<td>${val ?? ''}</td>`).join('');
                sampleBodyEl.innerHTML += `<tr>${tds}</tr>`;
            });
        }
    }

    btnAnalyze.addEventListener('click', async () => {
        if (!fileInput.files.length) return;
        
        showStep('step-loading');
        document.getElementById('loading-title').textContent = "Procesando...";
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken') || '{{ csrf_token }}');

        if (fileInput.files.length > 1) {
            for (let i = 0; i < fileInput.files.length; i++) formData.append('csv_files', fileInput.files[i]);
            try {
                const res = await fetch("{% url 'surveys:import_survey_csv_async' %}", {
                    method: 'POST', body: formData, headers: {'X-CSRFToken': getCookie('csrftoken')}
                });
                const data = await res.json();
                if (data.success && data.jobs) {
                    document.getElementById('loading-text').textContent = "Importando múltiples archivos...";
                    await Promise.all(data.jobs.map(j => pollImportJob(j.job_id)));
                    window.location.reload();
                } else {
                    showError(data.error || 'Error en importación masiva');
                }
            } catch (e) { showError(e.message); }
            return;
        }

        formData.append('csv_file', fileInput.files[0]);
        try {
            const res = await fetch("{% url 'surveys:import_preview' %}", {
                method: 'POST', body: formData, headers: {'X-CSRFToken': getCookie('csrftoken')}
            });
            const data = await res.json();
            if (data.success) {
                renderPreview(data);
                showStep('step2-preview');
            } else {
                showError(data.error || 'No se pudo leer el archivo.');
            }
        } catch (e) { showError("Error de conexión."); }
    });

    btnConfirm.addEventListener('click', async () => {
        showStep('step-loading');
        document.getElementById('loading-title').textContent = "Importando...";
        
        const formData = new FormData();
        formData.append('csv_file', fileInput.files[0]);
        if (titleInput.value) formData.append('survey_title', titleInput.value);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken') || '{{ csrf_token }}');

        try {
            const res = await fetch("{% url 'surveys:import_survey_csv_async' %}", {
                method: 'POST', body: formData, headers: {'X-CSRFToken': getCookie('csrftoken')}
            });
            const data = await res.json();
            if (data.success) {
                const jobId = data.job_id || data.import_job_id;
                if (jobId) {
                    const success = await pollImportJob(jobId);
                    if (success) window.location.reload();
                    else showError("La importación falló.");
                } else window.location.reload();
            } else showError(data.error);
        } catch (e) { showError(e.message); }
    });

    if (btnBack) btnBack.addEventListener('click', () => showStep('step1-upload'));
    if (btnRetry) btnRetry.addEventListener('click', () => showStep('step1-upload'));
});
</script>

<link rel="stylesheet" href="{% static 'css/byteneko.css' %}">
{% endblock %}