{% extends 'app_base.html' %}
{% load static %}

{% block page_styles %}
<style>
    /* Icon box para KPIs */
    .kpi-icon-box {
        width: 48px; height: 48px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 12px;
        background-color: var(--bs-tertiary-bg);
    }
    .insight-icon-box { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

    /* Barra de filtros */
    .filter-bar {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border-color);
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block app_content %}
<div class="container-xl p-4 p-md-5">

    <div class="mb-4">
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'surveys:list' %}" class="text-decoration-none">Mis Encuestas</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ encuesta.titulo }}</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 fw-bold mb-1 text-body-emphasis">Resultados Analíticos</h1>
                <p class="text-muted mb-0">Explora los datos y segmenta tu audiencia.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'surveys:exportar' encuesta.pk %}" class="btn btn-outline-primary">
                    <i class="bi bi-download me-1"></i> Exportar
                </a>
            </div>
        </div>
    </div>

    <div class="filter-bar shadow-sm">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Desde</label>
                <input
                    type="date"
                    name="start"
                    class="form-control bg-body-tertiary border-0"
                    value="{{ filter_start|default:'' }}"
                >
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Hasta</label>
                <input
                    type="date"
                    name="end"
                    class="form-control bg-body-tertiary border-0"
                    value="{{ filter_end|default:'' }}"
                >
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold text-muted text-uppercase">Segmentar por Pregunta</label>
                <select name="segment_col" class="form-select bg-body-tertiary border-0">
                    <option value="">-- Sin segmentar --</option>
                    {% for p in preguntas_filtro %}
                        <option
                            value="{{ p.texto }}"
                            {% if filter_col == p.texto %}
                                selected
                            {% endif %}
                        >
                            {{ p.texto|truncatechars:30 }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-muted text-uppercase">Valor (Contiene)</label>
                <input
                    type="text"
                    name="segment_val"
                    class="form-control bg-body-tertiary border-0"
                    placeholder="Ej. Empresarial"
                    value="{{ filter_val|default:'' }}"
                >
            </div>

            <div class="col-md-1">
                <button type="submit" class="btn btn-primary w-100" title="Aplicar Filtros">
                    <i class="bi bi-funnel-fill"></i>
                </button>
            </div>
        </form>
    </div>

    {% if total_respuestas == 0 %}
        <div class="card border-0 shadow-sm py-5 bg-body-tertiary">
            <div class="card-body text-center">
                <i class="bi bi-search fs-1 text-muted mb-3"></i>
                <h3 class="fw-bold text-body-emphasis">No se encontraron resultados</h3>
                <p class="text-muted">Intenta ajustar los filtros o comparte tu encuesta para recibir datos.</p>
                <a href="{% url 'surveys:resultados' encuesta.pk %}" class="btn btn-outline-secondary mt-2">Limpiar Filtros</a>
            </div>
        </div>
    {% else %}

        <div class="row g-4 mb-5">
            <div class="col-md-3 col-6">
                <div class="card kpi-card-results h-100 py-3 hover-shadow">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="kpi-icon-box text-primary"><i class="bi bi-people-fill fs-4"></i></div>
                        <div>
                            <div class="small text-uppercase fw-bold opacity-75">Muestra</div>
                            <div class="h3 fw-bold mb-0 text-body-emphasis">{{ total_respuestas }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card kpi-card-results h-100 py-3 text-center hover-shadow">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="text-muted small text-uppercase fw-bold">NPS Segmento</div>
                        <div class="h3 fw-bold mb-0 {% if nps_score > 0 %}text-success{% elif nps_score < 0 %}text-danger{% else %}text-muted{% endif %}">
                            {{ nps_score|default:"--" }}
                        </div>
                    </div>
                </div>
            </div>
             <div class="col-md-3 col-6">
                <div class="card kpi-card-results h-100 py-3 text-center hover-shadow">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="text-muted small text-uppercase fw-bold">Satisfacción</div>
                        <div class="h3 fw-bold mb-0 text-body-emphasis">
                            {{ metrics.promedio_satisfaccion|default:"--" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if analysis_data %}
        <div class="mb-5">
            <h4 class="fw-bold mb-3 text-body-emphasis">
                <i class="bi bi-stars text-warning me-2"></i>
                Hallazgos del Segmento
            </h4>
            <div class="row g-3">
                {% for item in top_insights %}
                    <div class="col-md-4">
                        <div class="card h-100 insight-card shadow-sm hover-shadow">
                            <div class="card-body p-4 d-flex flex-column">
                                <h6 class="fw-bold text-body-emphasis mb-2">{{ item.texto|truncatechars:40 }}</h6>
                                <p class="card-text text-secondary flex-grow-1 small">
                                    {% if item.insight %}
                                        {% autoescape off %}{{ item.insight }}{% endautoescape %}
                                    {% else %}
                                        Ver detalle.
                                    {% endif %}
                                </p>
                                <div class="mt-3 pt-3 border-top border-secondary-subtle">
                                    <a href="#q_{{ item.id }}" class="text-decoration-none small stretched-link">
                                        Ver detalle <i class="bi bi-arrow-right-short"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3">
                        <h6 class="m-0 fw-bold text-primary">Historial (Filtrado)</h6>
                    </div>
                    <div class="card-body p-4">
                        <div style="height: 300px;">
                            <canvas id="trendLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-transparent py-3">
                        <h6 class="m-0 fw-bold text-primary">Correlaciones</h6>
                    </div>
                    <div class="card-body p-4 d-flex align-items-center justify-content-center">
                        {% if heatmap_image %}
                            <img
                                src="data:image/png;base64,{{ heatmap_image }}"
                                class="img-fluid rounded shadow-sm"
                                style="max-height: 280px;"
                            >
                        {% else %}
                            <p class="text-muted small">Sin datos suficientes en este segmento.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <h4 class="fw-bold mb-4 pb-2 border-bottom border-secondary-subtle text-body-emphasis">
            Detalle por Pregunta
        </h4>
        <div class="accordion" id="questionsAccordion">
            {% for item in analysis_data %}
                <div class="accordion-item mb-3 shadow-sm" id="q_{{ item.id }}">
                    <h2 class="accordion-header">
                        <button
                            class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse{{ item.id }}"
                        >
                            <span class="fw-bold me-2 opacity-50">{{ item.orden }}.</span>
                            {{ item.texto }}
                        </button>
                    </h2>
                    <div
                        id="collapse{{ item.id }}"
                        class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                        data-bs-parent="#questionsAccordion"
                    >
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-8 border-end border-secondary-subtle">
                                    {% if item.tipo == 'text' %}
                                        <ul class="list-group list-group-flush small">
                                            {% for resp in item.respuestas %}
                                                <li class="list-group-item border-0 px-0 bg-transparent text-body">
                                                    "{{ resp.valor_texto }}"
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <div style="height: 250px;">
                                            <canvas id="chart_q_{{ item.id }}"></canvas>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 ps-md-4">
                                    {% if item.insight %}
                                        <div class="alert alert-info-soft py-2 small mb-4">
                                            {% autoescape off %}{{ item.insight }}{% endautoescape %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if total_respuestas > 0 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const analysisData = {{ analysis_data_json|default:"null"|safe }};
        const trendData = {{ trend_data|default:"null"|safe }};

        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#f3f4f6';
        const textColor = isDark ? '#adb5bd' : '#666';

        if (document.getElementById('trendLineChart') && trendData) {
            new Chart(document.getElementById('trendLineChart'), {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Respuestas',
                        data: trendData.data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: textColor } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    }
                }
            });
        }

        if (analysisData) {
            analysisData.forEach(item => {
                if (item.tipo === 'text') return;
                const canvas = document.getElementById('chart_q_' + item.id);
                if (!canvas) return;

                let type = (item.tipo === 'single' || item.tipo === 'multi') ? 'doughnut' : 'bar';
                let options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor } } }
                };

                if (type === 'bar') {
                    options.scales = {
                        x: { grid: { display: false }, ticks: { color: textColor } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    };
                } else {
                    options.cutout = '65%';
                    options.plugins.legend.position = 'right';
                }

                new Chart(canvas, {
                    type: type,
                    data: {
                        labels: item.chart_labels,
                        datasets: [{
                            label: 'Votos',
                            data: item.chart_data,
                            backgroundColor: [
                                '#4e73df', '#1cc88a', '#36b9cc',
                                '#f6c23e', '#e74a3b', '#858796'
                            ],
                            borderColor: isDark ? '#1e1e1e' : '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: options
                });
            });
        }
    });
</script>
{% endif %}
{% endblock %}