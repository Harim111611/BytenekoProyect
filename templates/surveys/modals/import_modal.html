<div class="modal fade" id="importModalPreview" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-content border-0 shadow-lg overflow-hidden">
            <div class="modal-header border-0 bg-body-tertiary py-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-primary text-white me-3 shadow-sm">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold text-body-emphasis mb-0">Asistente de Importación</h5>
                        <small class="text-muted">Sube tus datos y valida la estructura.</small>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close-import-modal-header"></button>
            </div>

            <div id="step1-upload" class="modal-body p-4 p-lg-5">
                <div class="text-center mb-4">
                    <h4 class="fw-bold text-body-emphasis">Sube tu archivo CSV</h4>
                    <p class="text-muted col-lg-8 mx-auto">
                        Arrastra tus archivos aquí o haz clic para explorar. <br>
                        <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle rounded-pill mt-2">Soporta .csv UTF-8</span>
                    </p>
                </div>

                <div class="card border-dashed bg-body-tertiary mb-4 mx-auto position-relative overflow-hidden transition-all" 
                     id="upload-drop-zone" 
                     style="max-width: 700px; cursor: pointer; min-height: 250px;">
                    
                    <div class="card-body p-5 text-center d-flex flex-column align-items-center justify-content-center h-100">
                        <div class="mb-3 text-primary opacity-50 icon-bounce">
                            <i class="bi bi-cloud-arrow-up" style="font-size: 3.5rem;"></i>
                        </div>
                        <h5 class="fw-bold mb-2 text-body-emphasis">Arrastra y suelta aquí</h5>
                        <p class="text-muted mb-4 small">o</p>
                        
                        <button type="button" class="btn btn-primary shadow-sm px-4 fw-medium" onclick="document.getElementById('csvFileInput').click()">
                            <i class="bi bi-folder2-open me-2"></i>Explorar Archivos
                        </button>
                        
                        <input class="form-control d-none" type="file" id="csvFileInput" accept=".csv" multiple required>

                        <div id="fileList" class="mt-4 small text-muted fst-italic transition-all">Ningún archivo seleccionado</div>
                        
                        <div class="form-text mt-3 text-body-secondary">
                            <i class="bi bi-info-circle me-1"></i> La primera fila debe contener encabezados.
                            <div class="text-danger fw-semibold mt-1 animate-fade-in" id="multi-file-warning" style="display:none;">
                                <i class="bi bi-exclamation-triangle"></i> Múltiples archivos: Se omitirá la vista previa.
                            </div>
                        </div>
                    </div>

                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center backdrop-blur-sm" 
                         id="drop-zone-overlay" 
                         style="pointer-events: none; opacity: 0; transition: all 0.2s ease; z-index: 10;">
                        <div class="bg-body px-4 py-3 rounded-pill shadow-sm text-primary fw-bold fs-5 border border-primary">
                            <i class="bi bi-download me-2"></i>¡Suéltalos aquí!
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <label class="form-label fw-bold small text-uppercase text-muted tracking-wide">
                            Nombre del Proyecto (Opcional)
                        </label>
                        <div class="input-group input-group-lg mb-2">
                            <input type="text" class="form-control bg-body-tertiary" id="surveyTitleInput" placeholder="Ej. Análisis de Mercado 2025" maxlength="255">
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center gap-3 mt-5">
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-lg px-5 shadow-sm" id="btn-analyze" disabled>
                        <i class="bi bi-magic me-2"></i>Analizar Archivo
                    </button>
                </div>
            </div>

            <div id="step2-preview" class="modal-body p-0" style="display:none;">
                <div class="bg-body-tertiary border-bottom px-4 py-3">
                    <div class="row align-items-center g-3">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                <div>
                                    <h6 class="fw-bold mb-0 text-success">Archivo Validado</h6>
                                    <div class="small text-body-secondary text-truncate" style="max-width: 400px;" id="preview-filename">archivo.csv</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                             <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-back-to-upload">
                                <i class="bi bi-arrow-left me-1"></i>Reemplazar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-0" style="height: 65vh; min-height: 500px;">
                    <div class="col-lg-3 border-end bg-body-tertiary p-4 d-flex flex-column gap-3 overflow-auto">
                        <h6 class="fw-bold text-uppercase text-muted small mb-2 tracking-wide">Resumen</h6>
                        
                        <div class="card border-0 shadow-sm mb-2 bg-body">
                            <div class="card-body p-3 d-flex align-items-center gap-3">
                                <div class="rounded-3 bg-primary-subtle text-primary-emphasis p-2">
                                    <i class="bi bi-list-ol fs-4"></i>
                                </div>
                                <div>
                                    <div class="h4 fw-bold mb-0 text-body-emphasis" id="preview-total-rows">0</div>
                                    <div class="small text-muted">Respuestas</div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-2 bg-body">
                            <div class="card-body p-3 d-flex align-items-center gap-3">
                                <div class="rounded-3 bg-success-subtle text-success-emphasis p-2">
                                    <i class="bi bi-columns fs-4"></i>
                                </div>
                                <div>
                                    <div class="h4 fw-bold mb-0 text-body-emphasis" id="preview-total-questions">0</div>
                                    <div class="small text-muted">Columnas</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-9 d-flex flex-column h-100 bg-body">
                        <ul class="nav nav-tabs nav-fill px-3 pt-3 border-bottom-0" id="previewTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active fw-medium" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure-pane" type="button">
                                    <i class="bi bi-diagram-3 me-2"></i>Estructura
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link fw-medium" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button">
                                    <i class="bi bi-table me-2"></i>Datos
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content flex-grow-1 overflow-hidden border-top position-relative" id="previewTabsContent">
                            <div class="tab-pane fade show active h-100 overflow-auto p-0" id="structure-pane">
                                <table class="table table-hover table-striped mb-0 align-middle w-100">
                                    <thead class="sticky-top shadow-sm bg-body-tertiary">
                                        <tr>
                                            <th class="ps-4 bg-body-tertiary" style="width: 50px;">#</th>
                                            <th class="bg-body-tertiary">Columna</th>
                                            <th class="bg-body-tertiary">Tipo</th>
                                            <th class="text-center bg-body-tertiary">Únicos</th>
                                            <th class="bg-body-tertiary">Muestra</th>
                                        </tr>
                                    </thead>
                                    <tbody id="preview-columns-table"></tbody>
                                </table>
                            </div>

                            <div class="tab-pane fade h-100 overflow-auto p-0" id="data-pane">
                                <div class="table-responsive h-100">
                                    <table class="table table-sm table-bordered mb-0 spreadsheet-table">
                                        <thead class="sticky-top bg-body-tertiary" id="preview-sample-header"></thead>
                                        <tbody id="preview-sample-body" class="font-monospace small text-body-secondary"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-top p-3 bg-body-tertiary d-flex justify-content-end gap-2">
                             <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success px-4 fw-bold shadow-sm" id="btn-import-confirm">
                                <i class="bi bi-check-lg me-2"></i>Confirmar e Importar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="step-loading" class="modal-body text-center py-5" style="display:none;">
                <div class="py-5">
                    <div class="spinner-grow text-primary mb-4" style="width: 4rem; height: 4rem;" role="status"></div>
                    <h4 class="fw-bold text-body-emphasis mb-2" id="loading-title">Procesando...</h4>
                    <p class="text-muted mb-4" id="loading-text">Espera mientras analizamos tus datos.</p>
                    <div class="progress mx-auto shadow-sm bg-body-secondary" style="max-width: 400px; height: 10px; border-radius: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <div id="step-error" class="modal-body py-5 text-center" style="display:none;">
                <div class="mb-3 text-danger"><i class="bi bi-x-circle-fill" style="font-size: 4rem;"></i></div>
                <h4 class="fw-bold text-danger mb-3">Error en la importación</h4>
                <div class="alert alert-danger d-inline-block text-start shadow-sm" style="max-width: 80%;">
                    <i class="bi bi-bug me-2"></i><span id="error-message">Error desconocido</span>
                </div>
                <div class="mt-4">
                    <button type="button" class="btn btn-secondary" onclick="window.location.reload()">Cerrar</button>
                    <button type="button" class="btn btn-outline-primary" id="btn-retry-upload">Intentar de nuevo</button>
                </div>
            </div>
        </div>
    </div>
</div>