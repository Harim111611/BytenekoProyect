{% extends 'app_base.html' %}
{% load static %}

{% block app_content %}
{% include 'surveys/delete_selected_modal.html' %}
{% include 'surveys/delete_all_modal.html' %}
{% include 'surveys/delete_one_modal.html' %}
<!-- Modal Importar CSV con Vista Previa -->
<div class="modal fade" id="importModalPreview" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0 bg-body-tertiary">
                <h5 class="modal-title fw-bold text-body-emphasis">
                    <i class="bi bi-upload me-2"></i>Importar con Vista Previa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- PASO 1: Subir archivo -->
            <div id="step1-upload" class="modal-body pt-4">
                <div class="text-center mb-4">
                    <div class="bg-primary-subtle text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-file-earmark-spreadsheet-fill fs-3"></i>
                    </div>
                    <h6 class="fw-bold text-body-emphasis mb-2">Paso 1: Selecciona tu archivo</h6>
                    <p class="small text-muted">
                        Sube un archivo <code>.csv</code> y te mostraremos una vista previa antes de importar.
                    </p>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">
                        <i class="bi bi-file-earmark-arrow-up me-1"></i>Archivo(s) CSV
                    </label>
                    <input class="form-control bg-body-tertiary form-control-lg" type="file"
                           id="csvFileInput" accept=".csv" multiple required>
                    <div class="form-text small">
                        <i class="bi bi-info-circle me-1"></i>
                        Puedes seleccionar múltiples archivos CSV. La primera fila debe contener los encabezados.
                    </div>
                    <div id="fileList" class="mt-2"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold small">
                        <i class="bi bi-tag me-1"></i>Nombre del Proyecto (Opcional)
                    </label>
                    <input type="text" class="form-control bg-body-tertiary"
                           id="surveyTitleInput"
                           placeholder="Ej. Satisfacción Q4 2025"
                           maxlength="255">
                    <div class="form-text small">
                        <i class="bi bi-info-circle me-1"></i>
                        Solo aplica si seleccionaste un solo archivo. Para múltiples archivos, se usa el nombre de cada archivo.
                    </div>
                </div>

                <div class="alert alert-primary d-flex align-items-center" role="alert">
                    <i class="bi bi-lightbulb fs-4 me-3"></i>
                    <div class="small">
                        <strong>¡Nuevo!</strong> Puedes importar múltiples surveys a la vez.  
                        Si seleccionas varios archivos, se crearán automáticamente.
                    </div>
                </div>
            </div>

            <!-- PASO 2: Preview -->
            <div id="step2-preview" class="modal-body pt-4" style="display:none;">
                <div class="alert alert-success d-flex align-items-start mb-4">
                    <i class="bi bi-check-circle fs-4 me-3"></i>
                    <div>
                        <h6 class="alert-heading mb-1">✅ Archivo validado correctamente</h6>
                        <p class="mb-0 small">
                            Los datos se interpretarán como se muestra abajo.
                            Al confirmar, se creará la survey y serás redirigido al
                            <strong>Dashboard de Resultados</strong> para explorar el análisis completo.
                        </p>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card bg-body-tertiary border-0">
                            <div class="card-body text-center py-3">
                                <div class="small text-muted fw-bold mb-1">RESPUESTAS</div>
                                <div class="h4 fw-bold mb-0 text-primary" id="preview-total-rows">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-body-tertiary border-0">
                            <div class="card-body text-center py-3">
                                <div class="small text-muted fw-bold mb-1">PREGUNTAS</div>
                                <div class="h4 fw-bold mb-0 text-success" id="preview-total-questions">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-body-tertiary border-0">
                            <div class="card-body text-center py-3">
                                <div class="small text-muted fw-bold mb-1">ARCHIVO</div>
                                <div class="small fw-bold text-truncate" id="preview-filename">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i>Preguntas detectadas</h6>
                <div class="table-responsive mb-4" style="max-height:300px; overflow-y:auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:5%">#</th>
                                <th style="width:35%">Columna</th>
                                <th style="width:25%">Tipo</th>
                                <th style="width:10%">Valores</th>
                                <th style="width:25%">Muestra</th>
                            </tr>
                        </thead>
                        <tbody id="preview-columns-table"></tbody>
                    </table>
                </div>

                <h6 class="fw-bold mb-3"><i class="bi bi-table me-2"></i>Datos (primeras 5 filas)</h6>
                <div class="table-responsive" style="max-height:250px; overflow:auto;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light sticky-top" id="preview-sample-header"></thead>
                        <tbody id="preview-sample-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Loading -->
            <div id="step-loading" class="modal-body text-center py-5" style="display:none;">
                <div class="mb-4" id="loading-animation">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <h5 class="mb-3" id="loading-title">Processing Data</h5>
                <p class="text-muted" id="loading-text">Analizando...</p>
                <div class="progress mx-auto" style="max-width: 300px; height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>

            <!-- Error -->
            <div id="step-error" class="modal-body" style="display:none;">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="error-message"></span>
                </div>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" id="btn-cancel">Cancelar</button>
                <button type="button" class="btn btn-outline-primary" id="btn-back-to-upload" style="display:none;">
                    <i class="bi bi-arrow-left me-1"></i>Volver
                </button>
                <button type="button" class="btn btn-primary" id="btn-analyze">
                    <i class="bi bi-search me-2"></i>Ver Vista Previa
                </button>
                <button type="button" class="btn btn-success" id="btn-confirm-import" style="display:none;">
                    <i class="bi bi-check-circle me-2"></i>Importar y Ver Resultados
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Fin modal importación CSV -->

<div class="container-xl p-4 p-md-5">

    <!-- Cabecera -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="h2 fw-bold mb-1 text-body-emphasis">Mis Proyectos</h1>
            <p class="text-muted mb-0">Gestiona y organiza tus estudios de mercado.</p>
        </div>
        <div class="d-flex gap-2 flex-wrap justify-content-md-end">
            <button type="button"
                    class="btn btn-outline-secondary border-dashed fw-medium"
                    data-bs-toggle="modal"
                    data-bs-target="#importModalPreview"
                    title="Importar CSV">
                <i class="bi bi-cloud-upload me-2"></i>Importar CSV
            </button>
            <a href="{% url 'surveys:create' %}" class="btn btn-primary fw-medium shadow-sm px-4">
                <i class="bi bi-plus-lg me-2"></i>Crear Encuesta
            </a>
            <!-- BOTÓN PARA ENTRAR/SALIR DE MODO SELECCIÓN -->
            <button type="button"
                    class="btn btn-outline-danger fw-medium"
                    id="toggleSelectionBtn"
                    title="Seleccionar múltiples encuestas">
                <i class="bi bi-check2-square me-1"></i>Seleccionar
            </button>
        </div>
    </div>

    <!-- ALERTA GLOBAL (éxito / error) -->
    <div id="pageAlert" class="alert alert-success d-none mb-4" role="alert">
        <strong id="pageAlertTitle"></strong>
        <span id="pageAlertBody" class="ms-2"></span>
    </div>

    <!-- BARRA DE ACCIONES MASIVAS -->
        <div id="bulkActionsBar"
            class="alert alert-warning d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 bulk-actions-bar-custom"
            style="display:none !important;">
        <div class="d-flex align-items-center mb-2 mb-md-0 gap-2">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span class="small">
                <strong><span id="selectedCountSpan">0</span> encuestas seleccionadas.</strong>
                Las encuestas con muchos registros pueden tardar algunos segundos en eliminarse por completo.
            </span>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllBtn">
                Seleccionar todas
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn" style="display:none;">
                Quitar selección
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="deleteSelectedBtn">
                <i class="bi bi-trash-fill me-1"></i>Eliminar seleccionadas
            </button>
            <button type="button" class="btn btn-sm btn-danger" id="deleteAllBtn">
                <i class="bi bi-trash3-fill me-1"></i>Eliminar todas
            </button>
            <button type="button" class="btn btn-sm btn-outline-dark" id="cancelSelectionBtn">
                Salir de selección
            </button>
        </div>
    </div>

    {% if surveys %}
        <div class="row g-4">
            {% for survey in surveys %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 survey-card shadow-sm" data-survey-id="{{ survey.pk }}">
                    <div class="card-body p-4 d-flex flex-column">

                        <!-- Botón de selección múltiple (checkbox) -->
                        <div class="position-absolute top-0 start-0 mt-3 ms-3 selection-checkbox"
                             style="z-index: 10; display: none;">
                            <button type="button"
                                    class="btn btn-sm survey-select-btn js-select-survey-btn"
                                    data-survey-id="{{ survey.pk }}"
                                    style="width: 36px; height: 36px; border-radius: 8px; padding: 0; border: 2px solid #dee2e6;">
                                <i class="bi bi-circle" style="font-size: 1rem;"></i>
                            </button>
                        </div>

                        <!-- Fecha + estado -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge rounded-pill bg-body-tertiary text-secondary border border-dashed fw-normal">
                                    {{ survey.created_at|date:"d M Y" }}
                                </span>
                                {% if survey.is_imported %}
                                <span class="badge rounded-pill bg-warning-subtle text-warning border border-warning fw-normal" title="Esta encuesta fue importada desde CSV y está cerrada">
                                    <i class="bi bi-file-earmark-lock2 me-1"></i>Importada (Cerrada)
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center small">
                                {% if survey.status == 'active' %}
                                    <span class="status-dot bg-active"></span>
                                    <span class="text-success fw-bold" style="font-size: 0.8rem;">Activa</span>
                                {% elif survey.status == 'paused' %}
                                    <span class="status-dot bg-paused"></span>
                                    <span class="text-warning" style="font-size: 0.8rem;">En pausa</span>
                                {% elif survey.status == 'draft' %}
                                    <span class="status-dot bg-draft"></span>
                                    <span class="text-muted" style="font-size: 0.8rem;">Borrador</span>
                                {% else %}
                                    <span class="status-dot bg-closed"></span>
                                    <span class="text-danger" style="font-size: 0.8rem;">Cerrada</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Título -->
                        <h5 class="card-title fw-bold text-body-emphasis mb-2 text-truncate"
                            title="{{ survey.title }}">
                            <a href="{% url 'surveys:detail' survey.public_id %}"
                               class="text-decoration-none text-body-emphasis stretched-link">
                                {{ survey.title }}
                            </a>
                        </h5>

                        <!-- Descripción -->
                        <p class="card-text text-secondary small flex-grow-1 mb-4" style="line-height: 1.5;">
                            {{ survey.description|default:"Sin descripción adicional."|truncatechars:85 }}
                        </p>

                        <!-- Respuestas / Preguntas -->
                        <div class="d-flex align-items-center text-secondary small mb-4
                                    bg-body-tertiary rounded-3 p-2 border border-dashed">
                            <div class="d-flex align-items-center me-3">
                                <i class="bi bi-people-fill me-2 text-primary"></i>
                                <strong class="text-body">{{ survey.total_respuestas }}</strong>&nbsp;respuestas
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-layers-fill me-2 text-primary"></i>
                                <strong class="text-body">{{ survey.total_preguntas }}</strong>&nbsp;preguntas
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex gap-2 action-btn-group" style="position: relative; z-index: 2;">
                            <a href="{% url 'surveys:results' survey.public_id %}"
                               class="btn btn-sm btn-outline-primary flex-grow-1">
                                <i class="bi bi-bar-chart-fill me-1"></i> Resultados
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger js-delete-survey-btn"
                                    data-action="delete-survey"
                                    data-survey-id="{{ survey.pk }}"
                                    title="Eliminar">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5 my-5">
            <div class="mb-4">
                <div class="bg-body-tertiary rounded-circle d-inline-flex align-items-center justify-content-center border border-dashed" style="width: 100px; height: 100px;">
                    <i class="bi bi-folder2-open text-muted opacity-50" style="font-size: 3rem;"></i>
                </div>
            </div>
            <h3 class="fw-bold text-body-emphasis mb-2">Tu espacio de trabajo está vacío</h3>
            <p class="text-muted mb-4 col-md-6 mx-auto">
                Crea tu primera survey desde cero o importa un archivo CSV existente para comenzar a analizar datos hoy mismo.
            </p>
            <div class="d-flex justify-content-center gap-3">
                <a href="{% url 'surveys:create' %}" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-plus-lg me-2"></i>Crear Encuesta
                </a>
                <button class="btn btn-outline-secondary btn-lg px-4"
                        data-bs-toggle="modal"
                        data-bs-target="#importModalPreview">
                    Importar CSV
                </button>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * ALERTA GLOBAL (superior)
 * type: 'success' | 'danger' | 'warning' | 'info'
 * durationMs: tiempo en ms antes de ocultarse automáticamente (por defecto 5000).
 *             Si es 0, NO se oculta solo.
 */
let pageAlertTimeoutId = null;

function showPageAlert(type, title, body, durationMs) {
    const box   = document.getElementById('pageAlert');
    const tEl   = document.getElementById('pageAlertTitle');
    const bEl   = document.getElementById('pageAlertBody');
    if (!box || !tEl || !bEl) return;

    // Limpiar clases previas
    box.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
    box.classList.add('alert-' + (type || 'info'));
    tEl.textContent = title || '';
    bEl.textContent = body || '';

    // Limpiar timeout anterior si existe
    if (pageAlertTimeoutId) {
        clearTimeout(pageAlertTimeoutId);
        pageAlertTimeoutId = null;
    }

    // Auto-ocultar salvo que durationMs sea 0
    const timeout = (typeof durationMs === 'number') ? durationMs : 5000;
    if (timeout > 0) {
        pageAlertTimeoutId = setTimeout(function () {
            box.classList.add('d-none');
        }, timeout);
    }
}
</script>

<script>
// -----------------------------------------
// Selección múltiple y borrado en bloque
// -----------------------------------------
(function () {
    const toggleSelectionBtn = document.getElementById('toggleSelectionBtn');
    const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');
    const bulkActionsBar     = document.getElementById('bulkActionsBar');
    const selectedCountSpan  = document.getElementById('selectedCountSpan');
    const selectAllBtn       = document.getElementById('selectAllBtn');
    const deselectAllBtn     = document.getElementById('deselectAllBtn');
    const deleteSelectedBtn  = document.getElementById('deleteSelectedBtn');
    const deleteAllBtn       = document.getElementById('deleteAllBtn');

    const selectBtns = document.querySelectorAll('.js-select-survey-btn');
    const cards      = document.querySelectorAll('.survey-card');

    if (!toggleSelectionBtn || !cancelSelectionBtn || !bulkActionsBar || !selectedCountSpan || !deleteSelectedBtn) {
        return;
    }

    // Si NO hay encuestas, ocultamos la barra y deshabilitamos el botón "Seleccionar"
    if (!cards.length) {
        bulkActionsBar.style.display = 'none';
        bulkActionsBar.classList.add('d-none');
        toggleSelectionBtn.disabled = true;
        toggleSelectionBtn.classList.add('disabled', 'opacity-50');
        return;
    }

    const selectedSurveys = new Set();
    let selectionMode = false;
    let skipConfirmBulk = false;

    function updateSelectionUI() {
        const count = selectedSurveys.size;
        selectedCountSpan.textContent = count;

        // Mostrar la barra cuando estamos en modo selección (aunque no haya ninguna seleccionada)
        if (selectionMode) {
            bulkActionsBar.style.display = 'flex';
            bulkActionsBar.classList.remove('d-none');
        } else {
            bulkActionsBar.style.display = 'none';
            bulkActionsBar.classList.add('d-none');
        }

        const allSelected = (selectBtns.length > 0) && (count === selectBtns.length);
        if (selectAllBtn && deselectAllBtn) {
            selectAllBtn.style.display   = allSelected ? 'none' : 'inline-block';
            deselectAllBtn.style.display = allSelected ? 'inline-block' : 'none';
        }
    }

    function toggleSelectionMode() {
        selectionMode = !selectionMode;
        document.body.classList.toggle('survey-selection-mode', selectionMode);

        document.querySelectorAll('.selection-checkbox').forEach(el => {
            el.style.display = selectionMode ? 'block' : 'none';
        });

        if (!selectionMode) {
            // Salimos de selección: limpiar selección
            selectedSurveys.clear();
            selectBtns.forEach(btn => {
                btn.classList.remove('btn-primary', 'text-white');
                btn.style.border = '2px solid #dee2e6';
                const icon = btn.querySelector('i');
                if (icon) icon.className = 'bi bi-circle';
            });
        }

        updateSelectionUI();
    }

    function toggleSurveySelection(surveyId, btn) {
        if (selectedSurveys.has(surveyId)) {
            selectedSurveys.delete(surveyId);
            btn.classList.remove('btn-primary', 'text-white');
            btn.style.border = '2px solid #dee2e6';
            const icon = btn.querySelector('i');
            if (icon) icon.className = 'bi bi-circle';
        } else {
            selectedSurveys.add(surveyId);
            btn.classList.add('btn-primary', 'text-white');
            btn.style.border = '2px solid var(--bk-primary)';
            const icon = btn.querySelector('i');
            if (icon) icon.className = 'bi bi-check-circle-fill';
        }
        updateSelectionUI();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Eventos
    toggleSelectionBtn.addEventListener('click', toggleSelectionMode);
    cancelSelectionBtn.addEventListener('click', toggleSelectionMode);

    selectBtns.forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const surveyId = this.dataset.surveyId;
            if (!surveyId) return;
            toggleSurveySelection(surveyId, this);
        });
    });

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function () {
            selectBtns.forEach(btn => {
                const surveyId = btn.dataset.surveyId;
                if (!surveyId) return;
                if (!selectedSurveys.has(surveyId)) {
                    selectedSurveys.add(surveyId);
                    btn.classList.add('btn-primary', 'text-white');
                    btn.style.border = '2px solid var(--bk-primary)';
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = 'bi bi-check-circle-fill';
                }
            });
            updateSelectionUI();
        });
    }

    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function () {
            selectedSurveys.clear();
            selectBtns.forEach(btn => {
                btn.classList.remove('btn-primary', 'text-white');
                btn.style.border = '2px solid #dee2e6';
                const icon = btn.querySelector('i');
                if (icon) icon.className = 'bi bi-circle';
            });
            updateSelectionUI();
        });
    }

    // --- BOTÓN ELIMINAR SELECCIONADAS ---
    deleteSelectedBtn.addEventListener('click', async function () {
        if (selectedSurveys.size === 0) {
            showPageAlert('warning', 'Nada para eliminar', 'No hay encuestas seleccionadas.', 4000);
            return;
        }

        const count = selectedSurveys.size;

        if (!skipConfirmBulk) {
            const message = count === 1
                ? '¿Estás seguro de que deseas eliminar esta encuesta?'
                : `¿Estás seguro de que deseas eliminar ${count} encuestas?`;
            if (!confirm(message + ' Esta acción no se puede deshacer.')) {
                return;
            }
        }
        skipConfirmBulk = false;

        const originalBtnHtml = deleteSelectedBtn.innerHTML;
        deleteSelectedBtn.disabled = true;
        deleteSelectedBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';

        const ids = Array.from(selectedSurveys);
        const cardsToDelete = [];

        ids.forEach(id => {
            const card = document.querySelector('.survey-card[data-survey-id="' + id + '"]');
            if (card) {
                card.classList.add('survey-card--deleting');
                cardsToDelete.push(card);
            }
        });

        try {
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken') || '{{ csrf_token }}');
            ids.forEach(id => formData.append('survey_ids', id));

            const response = await fetch("{% url 'surveys:bulk_delete' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '{{ csrf_token }}'
                }
            });

            if (!response.ok) {
                const txt = await response.text();
                throw new Error(txt || ('Error HTTP ' + response.status));
            }

            let data = {};
            try {
                data = await response.json();
            } catch (e) {
                data = { success: true };
            }

            if (data.success === false) {
                throw new Error(data.error || 'No se pudieron eliminar las encuestas.');
            }


            cardsToDelete.forEach(card => card.remove());
            selectedSurveys.clear();
            updateSelectionUI();

            // Si ya no quedan encuestas, recargar para mostrar el aviso vacío
            if (document.querySelectorAll('.survey-card').length === 0) {
                window.location.reload();
            }

            if (selectionMode) {
                toggleSelectionMode();
            }

            const summary = data.message || 'Las encuestas seleccionadas se eliminaron correctamente.';
            const detail  = data.detail || (
                data.deleted
                    ? `Se eliminaron ${data.deleted} encuestas.`
                    : ''
            );

            showPageAlert('success', summary, detail, 5000);

        } catch (error) {
            console.error('Error eliminando encuestas:', error);
            cardsToDelete.forEach(card => card.classList.remove('survey-card--deleting'));
            showPageAlert(
                'danger',
                'Error al eliminar encuestas',
                error.message || 'Ocurrió un error al eliminar las encuestas. Intenta de nuevo.',
                6000
            );
        } finally {
            deleteSelectedBtn.disabled = false;
            deleteSelectedBtn.innerHTML = originalBtnHtml;
        }
    });

    // --- BOTÓN ELIMINAR TODAS ---
    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', function () {
            const total = cards.length;
            if (!total) {
                showPageAlert('info', 'No hay encuestas', 'No hay encuestas en la lista para eliminar.', 4000);
                return;
            }

            // Set modal values
            document.getElementById('deleteAllCount').textContent = `${total}`;
            const heavyNotice = document.getElementById('deleteAllHeavyNotice');
            if (total >= 5) {
                heavyNotice.textContent = 'Las encuestas con muchos registros pueden tardar algunos segundos en eliminarse.';
                heavyNotice.style.display = '';
            } else {
                heavyNotice.style.display = 'none';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('deleteAllModal'));
            modal.show();

            // Confirm button handler
            const confirmBtn = document.getElementById('confirmDeleteAllBtn');
            const handler = function () {
                selectedSurveys.clear();
                selectBtns.forEach(btn => {
                    const surveyId = btn.dataset.surveyId;
                    if (!surveyId) return;
                    selectedSurveys.add(surveyId);
                    btn.classList.add('btn-primary', 'text-white');
                    btn.style.border = '2px solid var(--bk-primary)';
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = 'bi bi-check-circle-fill';
                });
                updateSelectionUI();

                skipConfirmBulk = true;
                deleteSelectedBtn.click();
                modal.hide();
                confirmBtn.removeEventListener('click', handler);
            };
            confirmBtn.addEventListener('click', handler);
        });
    }

    // Estado inicial: barra oculta
    bulkActionsBar.style.display = 'none';
    updateSelectionUI();
})();
</script>

<script>
// -----------------------------------------
// Borrado individual con estado "eliminando" persistente
// -----------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    const DELETING_KEY = 'surveys_deleting_ids';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getDeletingIds() {
        try { return JSON.parse(localStorage.getItem(DELETING_KEY) || '[]'); } catch { return []; }
    }
    function setDeletingIds(ids) {
        localStorage.setItem(DELETING_KEY, JSON.stringify(ids));
    }
    function addDeletingId(id) {
        const ids = getDeletingIds();
        if (!ids.includes(id)) {
            ids.push(id);
            setDeletingIds(ids);
        }
    }
    function removeDeletingId(id) {
        setDeletingIds(getDeletingIds().filter(x => x !== id));
    }

    // Al cargar, aplicar clase a las cards en proceso
    getDeletingIds().forEach(id => {
        const card = document.querySelector('.survey-card[data-survey-id="' + id + '"]');
        if (card) card.classList.add('survey-card--deleting');
    });

    // Borrado individual
    document.addEventListener('click', async function(event) {
        const btn = event.target.closest('[data-action="delete-survey"]');
        if (!btn) return;

        event.preventDefault();

        const surveyId = btn.getAttribute('data-survey-id');
        if (!surveyId) return;


        // Modal de confirmación en vez de confirm() con check defensivo
        let confirmDelete = await new Promise((resolve) => {
            const deleteOneModal = document.getElementById('deleteOneModal');
            const confirmDeleteOneBtn = document.getElementById('confirmDeleteOneBtn');
            // Si no existe el modal, no reventar la app
            if (!deleteOneModal || !confirmDeleteOneBtn) {
                console.error('No se encontró el modal de eliminación individual');
                resolve(false);
                return;
            }
            const modal = bootstrap.Modal.getOrCreateInstance(deleteOneModal);
            // Asegura aria-hidden correcto al mostrar
            deleteOneModal.setAttribute('aria-hidden', 'false');
            const onHide = function () {
                confirmDeleteOneBtn.removeEventListener('click', onConfirm);
                deleteOneModal.removeEventListener('hidden.bs.modal', onHide);
                // Al ocultar, poner aria-hidden y mover foco fuera del modal
                deleteOneModal.setAttribute('aria-hidden', 'true');
                // Mueve el foco al botón de selección principal si existe
                const fallbackBtn = document.getElementById('toggleSelectionBtn');
                if (fallbackBtn) fallbackBtn.focus();
                resolve(false);
            };
            const onConfirm = function () {
                confirmDeleteOneBtn.removeEventListener('click', onConfirm);
                deleteOneModal.removeEventListener('hidden.bs.modal', onHide);
                modal.hide();
                // Al ocultar, poner aria-hidden y mover foco fuera del modal
                deleteOneModal.setAttribute('aria-hidden', 'true');
                const fallbackBtn = document.getElementById('toggleSelectionBtn');
                if (fallbackBtn) fallbackBtn.focus();
                resolve(true);
            };
            deleteOneModal.addEventListener('hidden.bs.modal', onHide);
            confirmDeleteOneBtn.addEventListener('click', onConfirm);
            modal.show();
        });
        if (!confirmDelete) return;

        const card = btn.closest('.survey-card');
        if (!card) return;

        card.classList.add('survey-card--deleting');
        addDeletingId(surveyId);

        try {
            const formData = new URLSearchParams();
            formData.append('survey_ids', surveyId);

            const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
            const response = await fetch("{% url 'surveys:bulk_delete' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData.toString(),
            });

            if (!response.ok) throw new Error('Error HTTP ' + response.status);

            const data = await response.json();
            if (!data.success) throw new Error(data.error || 'No se pudo eliminar la encuesta.');


            card.remove();
            removeDeletingId(surveyId);

            // Si ya no quedan encuestas, recargar para mostrar el aviso vacío
            if (document.querySelectorAll('.survey-card').length === 0) {
                window.location.reload();
                return;
            }

            const summary = data.message || 'La encuesta se eliminó correctamente.';
            const detail  = data.detail || '';
            showPageAlert('success', summary, detail, 5000);

        } catch (err) {
            console.error('Error eliminando encuesta:', err);
            card.classList.remove('survey-card--deleting');
            removeDeletingId(surveyId);
            showPageAlert(
                'danger',
                'No se pudo eliminar la encuesta',
                err.message || 'Intenta de nuevo.',
                6000
            );
        }
    });
});
</script>

<script>
// --- Lógica de importación con vista previa + importación múltiple ---
document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('importModalPreview');
    if (!modalElement) return;

    const fileInput      = document.getElementById('csvFileInput');
    const titleInput     = document.getElementById('surveyTitleInput');
    const btnAnalyze     = document.getElementById('btn-analyze');
    const btnConfirm     = document.getElementById('btn-confirm-import');
    const btnBack        = document.getElementById('btn-back-to-upload');
    const btnCancel      = document.getElementById('btn-cancel');

    const stepUpload     = document.getElementById('step1-upload');
    const stepPreview    = document.getElementById('step2-preview');
    const stepLoading    = document.getElementById('step-loading');
    const stepError      = document.getElementById('step-error');

    const errorEl        = document.getElementById('error-message');
    const loadingAnim    = document.getElementById('loading-animation');
    const loadingTitle   = document.getElementById('loading-title');
    const loadingText    = document.getElementById('loading-text');

    const totalRowsEl        = document.getElementById('preview-total-rows');
    const totalQuestionsEl   = document.getElementById('preview-total-questions');
    const filenameEl         = document.getElementById('preview-filename');
    const columnsTable       = document.getElementById('preview-columns-table');
    const sampleHeaderEl     = document.getElementById('preview-sample-header');
    const sampleBodyEl       = document.getElementById('preview-sample-body');

    if (!fileInput || !btnAnalyze || !btnConfirm || !stepUpload || !stepPreview || !stepLoading || !stepError) {
        return;
    }

    let previewData   = null;
    let isProcessing  = false;
    let isImporting   = false;
    let abortController = null;

    function getCsrfToken() {
        const match = document.cookie.match(/csrftoken=([^;]+)/);
        return match ? match[1] : '{{ csrf_token }}';
    }

    function showStep(step) {
        stepUpload.style.display  = (step === 'upload')  ? 'block' : 'none';
        stepPreview.style.display = (step === 'preview') ? 'block' : 'none';
        stepLoading.style.display = (step === 'loading') ? 'block' : 'none';
        stepError.style.display   = (step === 'error')   ? 'block' : 'none';

        btnAnalyze.style.display = (step === 'upload') ? 'inline-block' : 'none';
        btnBack.style.display    = (step === 'preview' || step === 'error') ? 'inline-block' : 'none';
        btnConfirm.style.display = (step === 'preview') ? 'inline-block' : 'none';
    }

    function showError(message) {
        errorEl.textContent = message || 'Error desconocido.';
        showStep('error');
    }

    function resetModal() {
        fileInput.value = '';
        if (titleInput) titleInput.value = '';
        previewData = null;
        showStep('upload');
        // Resetear el texto del botón a su estado original
        btnAnalyze.innerHTML = '<i class="bi bi-search me-2"></i>Ver Vista Previa';
    }

    // Reset al abrir el modal
    modalElement.addEventListener('show.bs.modal', resetModal);

    // Actualizar el texto del botón según el número de archivos
    fileInput.addEventListener('change', function() {
        const files = fileInput.files;
        if (files && files.length > 1) {
            btnAnalyze.innerHTML = '<i class="bi bi-upload me-2"></i>Importar Directamente';
        } else {
            btnAnalyze.innerHTML = '<i class="bi bi-search me-2"></i>Ver Vista Previa';
        }
    });

    function renderPreview(data) {
        const questionColumns = data.columns.filter(c => !c.is_metadata);

        totalRowsEl.textContent      = data.total_rows ?? 0;
        totalQuestionsEl.textContent = questionColumns.length;
        filenameEl.textContent       = data.filename || '-';

        const typeIcons = {
            'scale':    '<i class="bi bi-star-fill text-warning"></i> Escala 1-10',
            'number':   '<i class="bi bi-123 text-info"></i> Número',
            'single':   '<i class="bi bi-ui-radios text-primary"></i> Opción única',
            'multi':    '<i class="bi bi-ui-checks text-success"></i> Múltiple',
            'text':     '<i class="bi bi-chat-left-text text-secondary"></i> Texto',
            'timestamp':'<i class="bi bi-clock text-muted"></i> Fecha/Hora',
            'metadata': '<i class="bi bi-tag text-muted"></i> Metadata'
        };

        columnsTable.innerHTML = '';
        data.columns.forEach((col, idx) => {
            const isMetadata = col.is_metadata || false;
            const rowClass   = isMetadata ? 'table-secondary opacity-75' : '';
            const skipBadge  = isMetadata ? '<span class="badge bg-secondary ms-2">Omitida</span>' : '';
            const uniqueVals = (typeof col.unique_values !== 'undefined') ? col.unique_values : '-';
            const samples    = Array.isArray(col.sample_values) ? col.sample_values.join(', ') : '-';

            columnsTable.innerHTML += `
                <tr class="${rowClass}">
                    <td class="text-center">${idx + 1}</td>
                    <td><code class="small">${col.name}</code> ${skipBadge}</td>
                    <td>${typeIcons[col.type] || col.type}</td>
                    <td class="text-center">${uniqueVals}</td>
                    <td class="small text-muted">${samples}</td>
                </tr>
            `;
        });

        sampleHeaderEl.innerHTML =
            '<tr>' + data.columns.map(c => `<th class="small">${c.display_name}</th>`).join('') + '</tr>';

        sampleBodyEl.innerHTML = '';
        (data.sample_rows || []).forEach(row => {
            const tds = row.map(val => {
                if (val === null || val === undefined || val === '') {
                    return '<td class="small"><span class="text-muted">-</span></td>';
                }
                return `<td class="small">${val}</td>`;
            }).join('');
            sampleBodyEl.innerHTML += `<tr>${tds}</tr>`;
        });
    }

    async function importMultiple(files) {
        if (!files || !files.length) return;

        isImporting = true;
        showStep('loading');

        if (loadingAnim) {
            loadingAnim.innerHTML =
                '<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">' +
                '<span class="visually-hidden">Loading...</span></div>';
        }
        loadingTitle.textContent = 'Importando datos';
        loadingText.textContent  =
            'Importando ' + files.length + ' encuesta' + (files.length > 1 ? 's' : '') + '... Por favor espera.';

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('csv_files', files[i]);
        }
        formData.append('csrfmiddlewaretoken', getCsrfToken());

        try {
            const response = await fetch("{% url 'surveys:import_multiple' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });

            const data = await response.json();
            if (data.success) {
                window.location.href = '{% url "surveys:list" %}';
            } else {
                let errorMsg = data.error || 'Error al importar';
                if (data.all_errors && data.all_errors.length > 0) {
                    errorMsg += '\n\nDetalles:\n' + data.all_errors.join('\n');
                }
                showError(errorMsg);
            }
        } catch (err) {
            console.error('Error importando encuestas múltiples:', err);
            showError('Error de conexión: ' + err.message);
        } finally {
            isImporting = false;
        }
    }

    if (btnAnalyze && fileInput) {
        btnAnalyze.addEventListener('click', async function() {
            const files = fileInput.files;
            if (!files || files.length === 0) {
                showError('Selecciona al menos un archivo CSV.');
                return;
            }

            // Si hay varios archivos, saltamos preview y vamos directo a importMultiple
            if (files.length > 1) {
                await importMultiple(files);
                return;
            }

            isProcessing = true;
            showStep('loading');

            if (loadingAnim) {
                loadingAnim.innerHTML =
                    '<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">' +
                    '<span class="visually-hidden">Loading...</span></div>';
            }
            loadingTitle.textContent = 'Analizando archivo';
            loadingText.textContent  =
                'Leyendo encabezados y detectando preguntas, por favor espera...';

            abortController = new AbortController();
            const formData = new FormData();
            formData.append('csv_file', files[0]);
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            try {
                const response = await fetch("{% url 'surveys:import_preview' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCsrfToken() },
                    signal: abortController.signal
                });

                const data = await response.json();
                if (data.success) {
                    previewData = data;
                    renderPreview(data);
                    showStep('preview');
                } else {
                    showError(data.error || 'Error al analizar el archivo');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error en preview:', error);
                    showError('Error de conexión: ' + error.message);
                }
            } finally {
                isProcessing = false;
                abortController = null;
            }
        });
    }

    if (btnBack) {
        btnBack.addEventListener('click', function() {
            if (isProcessing && abortController) {
                abortController.abort();
            }
            showStep('upload');
        });
    }

    if (btnConfirm && fileInput) {
        btnConfirm.addEventListener('click', async function() {
            const files = fileInput.files;
            if (!files || files.length === 0) {
                showError('Selecciona un archivo CSV.');
                return;
            }

            isImporting = true;
            showStep('loading');

            if (loadingAnim) {
                loadingAnim.innerHTML =
                    '<div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">' +
                    '<span class="visually-hidden">Loading...</span></div>';
            }
            loadingTitle.textContent = 'Importando datos';
            loadingText.textContent  =
                'Creando la encuesta y generando el análisis...';

            const formData = new FormData();
            formData.append('csv_file', files[0]);
            if (titleInput && titleInput.value) {
                formData.append('survey_title', titleInput.value);
            }
            formData.append('csrfmiddlewaretoken', getCsrfToken());

            try {
                const response = await fetch("{% url 'surveys:import_new' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCsrfToken() }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.href = '{% url "surveys:list" %}';
                    }
                } else {
                    showError(data.error || 'Error al importar');
                }
            } catch (error) {
                console.error('Error importando encuesta:', error);
                showError('Error de conexión: ' + error.message);
            } finally {
                isImporting = false;
            }
        });
    }
});
</script>

<style>
.survey-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--card-border-color, #e5e7eb);
    background-color: var(--card-bg, var(--bs-body-bg));
}
.survey-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15) !important;
    border-color: var(--bk-primary);
}
[data-bs-theme="dark"] .survey-card:hover {
    box-shadow: none !important;
    border-color: var(--bk-primary);
}

.status-dot {
    height: 8px;
    width: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.bg-active {
    background-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
}
.bg-paused {
    background-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
}
.bg-draft { background-color: #9ca3af; }
.bg-closed { background-color: #ef4444; }

.action-btn-group .btn {
    border-radius: 8px;
}


/* --- Botón de selección múltiple (checkbox circular) --- */
.survey-select-btn {
    transition: all 0.2s ease;
    background: var(--card-bg);
    cursor: pointer;
    border: 2px solid #dee2e6;
    color: var(--bs-secondary-color, #6c757d);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.survey-select-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    border-color: var(--bk-primary);
    color: var(--bk-primary);
}
.survey-select-btn.btn-primary, .survey-select-btn.selected {
    background: linear-gradient(135deg, var(--bk-primary) 60%, var(--bk-primary-light) 100%);
    border-color: var(--bk-primary);
    color: #fff !important;
    box-shadow: 0 0 0 3px var(--bk-primary-10);
}
.survey-select-btn.btn-primary i, .survey-select-btn.selected i {
    color: #fff !important;
    text-shadow: 0 2px 8px rgba(13,110,253,0.15);
}
/* Dark mode: mejorar contraste y borders */
[data-bs-theme="dark"] .survey-select-btn {
    background: var(--card-bg);
    border: 2px solid #30363d;
    color: #b3b3b3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}
[data-bs-theme="dark"] .survey-select-btn:hover {
    border-color: var(--bk-primary);
    color: var(--bk-primary);
    background: #23272f;
}
[data-bs-theme="dark"] .survey-select-btn.btn-primary, [data-bs-theme="dark"] .survey-select-btn.selected {
    background: linear-gradient(135deg, #2563eb 60%, #60a5fa 100%);
    border-color: #60a5fa;
    color: #fff !important;
    box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
}
[data-bs-theme="dark"] .survey-select-btn.btn-primary i, [data-bs-theme="dark"] .survey-select-btn.selected i {
    color: #fff !important;
    text-shadow: 0 2px 8px #2563eb44;
}
/* Mejorar el círculo de selección (ícono) */
.survey-select-btn i {
    font-size: 1.25rem;
    transition: color 0.2s;
}
.survey-select-btn.selected i, .survey-select-btn.btn-primary i {
    color: #fff !important;
}

.selection-checkbox {
    animation: fadeIn 0.2s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to   { opacity: 1; transform: scale(1); }
}

.survey-card--deleting {
    opacity: 0.5;
    filter: grayscale(0.8);
    pointer-events: none;
    position: relative;
}
.survey-card--deleting::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.7) url('{% static "img/loading.gif" %}') center center no-repeat;
    background-size: 48px 48px;
    z-index: 10;
    border-radius: inherit;
}
<style>
.bulk-actions-bar-custom {
    /* Mejor contraste para modo noche */
    border: 1.5px solid var(--bs-warning-border-subtle, #facc15);
    background: var(--bs-warning-bg-subtle, #f59e42);
    color: var(--bs-warning-text-emphasis, #fffbe6);
}
[data-bs-theme="dark"] .bulk-actions-bar-custom {
    background: #2d2600 !important;
    color: #ffe066 !important;
    border-color: #ffe066 !important;
}
/* Botones dentro de la barra para modo noche */
[data-bs-theme="dark"] .bulk-actions-bar-custom .btn,
[data-bs-theme="dark"] .bulk-actions-bar-custom .btn-outline-secondary {
    background: #232323;
    color: #ffe066;
    border-color: #ffe066;
}
[data-bs-theme="dark"] .bulk-actions-bar-custom .btn-outline-danger {
    background: #2d0000;
    color: #ff6b6b;
    border-color: #ff6b6b;
}
[data-bs-theme="dark"] .bulk-actions-bar-custom .btn-danger {
    background: #ff6b6b;
    color: #fff;
    border-color: #ff8787;
}
[data-bs-theme="dark"] .bulk-actions-bar-custom .btn:disabled {
    opacity: 0.5;
}
</style>
{% endblock %}
