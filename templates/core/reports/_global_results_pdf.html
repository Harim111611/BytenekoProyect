<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados Globales - Byteneko</title>
    <style>
        @page { size: A4; margin: 16mm 14mm; }
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; font-size: 10.5pt; color: #111827; }

        .header { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; }
        .header h1 { margin: 0; font-size: 18pt; }
        .subtitle { margin: 4px 0 0; color: #6b7280; font-size: 9.5pt; }
        .date { margin: 6px 0 0; color: #6b7280; font-size: 9pt; }

        .section-title { font-size: 11.5pt; font-weight: 800; margin: 14px 0 8px; }

        .kpi-table { width: 100%; border-collapse: separate; border-spacing: 8px; margin: 10px 0 10px; }
        .kpi-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; background: #ffffff; }
        .kpi-label { font-size: 8pt; letter-spacing: 0.08em; text-transform: uppercase; color: #6b7280; }
        .kpi-value { font-size: 18pt; font-weight: 800; margin-top: 4px; }
        .kpi-subtext { font-size: 9pt; color: #6b7280; margin-top: 2px; }
        .trend { font-weight: 700; }
        .trend.positive { color: #16a34a; }
        .trend.negative { color: #dc2626; }

        .panel { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; background: #ffffff; page-break-inside: avoid; }
        .nps-grid { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .nps-score { font-size: 26pt; font-weight: 900; text-align: right; }
        .nps-label { font-size: 9pt; color: #6b7280; margin: 2px 0 0; }
        .nps-badges { width: 100%; border-collapse: separate; border-spacing: 6px; margin-top: 8px; }
        .badge { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px 10px; }
        .badge-title { font-size: 8pt; letter-spacing: 0.08em; text-transform: uppercase; color: #6b7280; }
        .badge-value { font-size: 14pt; font-weight: 800; margin-top: 4px; }

        .two-col { width: 100%; border-collapse: separate; border-spacing: 10px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; font-size: 9pt; color: #6b7280; border-bottom: 1px solid #e5e7eb; padding: 6px; }
        .table td { border-bottom: 1px solid #f3f4f6; padding: 6px; vertical-align: top; }
        .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 8.5pt; border: 1px solid #e5e7eb; }

        .bar-row { margin: 6px 0 8px; }
        .bar-head { font-size: 9pt; color: #374151; margin-bottom: 3px; }
        .bar-track { width: 100%; height: 7px; background: #f3f4f6; border-radius: 999px; overflow: hidden; }
        .bar-fill { height: 7px; background: #6366f1; }

        .summary { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; background: #f9fafb; margin-top: 10px; }
        .summary h3 { margin: 0 0 6px; font-size: 10.5pt; }
        .summary ul { margin: 0; padding-left: 18px; }
        .summary li { margin: 0 0 4px; }

        .footer { margin-top: 14px; text-align: center; color: #9ca3af; font-size: 8.5pt; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Vista Global de Resultados</h1>
        <p class="subtitle">Análisis consolidado de tus encuestas (resumen ejecutivo).</p>
        <p class="date">Reporte generado el {{ fecha_generacion|date:"d/m/Y H:i" }}</p>
    </div>

    <table class="kpi-table">
        <tr>
            <td class="kpi-card">
                <div class="kpi-label">Respuestas Recibidas</div>
                <div class="kpi-value">{{ total_responses|default:"0" }}</div>
                <div class="kpi-subtext">
                    {% if weekly_change and weekly_change != 0 %}
                        <span class="trend {% if weekly_change >= 0 %}positive{% else %}negative{% endif %}">
                            {% if weekly_change >= 0 %}▲{% else %}▼{% endif %} {{ weekly_change|floatformat:1 }}% vs semana pasada
                        </span>
                    {% else %}
                        Evolución semanal: N/A
                    {% endif %}
                </div>
            </td>
            <td class="kpi-card">
                <div class="kpi-label">Satisfacción Promedio</div>
                <div class="kpi-value">{{ global_satisfaction|default:"0"|floatformat:1 }}/10</div>
                <div class="kpi-subtext">Promedio de calificaciones numéricas</div>
            </td>
        </tr>
        <tr>
            <td class="kpi-card">
                <div class="kpi-label">Encuestas Activas</div>
                <div class="kpi-value">{{ total_active|default:"0" }}</div>
                <div class="kpi-subtext">Recibiendo respuestas actualmente</div>
            </td>
            <td class="kpi-card">
                <div class="kpi-label">Total de Encuestas</div>
                <div class="kpi-value">{{ total_surveys|default:"0" }}</div>
                <div class="kpi-subtext">Creadas en total</div>
            </td>
        </tr>
    </table>

    <!-- Sección NPS -->
    {% if global_nps is not None %}
    <div class="panel">
        <table class="nps-grid">
            <tr>
                <td style="width: 70%;">
                    <div class="section-title" style="margin-top: 0;">Indicador de Recomendación (NPS)</div>
                    <div class="nps-label">Qué tan probable es que te recomienden (0 a 100)</div>
                </td>
                <td style="width: 30%;">
                    <div class="nps-score">{{ global_nps|default:"0"|floatformat:0 }}</div>
                </td>
            </tr>
        </table>

        <table class="nps-badges">
            <tr>
                <td class="badge">
                    <div class="badge-title">Promotores</div>
                    <div class="badge-value">{{ promoters|default:"0"|floatformat:0 }}%</div>
                </td>
                <td class="badge">
                    <div class="badge-title">Pasivos</div>
                    <div class="badge-value">{{ passives|default:"0"|floatformat:0 }}%</div>
                </td>
                <td class="badge">
                    <div class="badge-title">Detractores</div>
                    <div class="badge-value">{{ detractors|default:"0"|floatformat:0 }}%</div>
                </td>
            </tr>
        </table>
    </div>
    {% endif %}

    <table class="two-col">
        <tr>
            <td class="panel" style="width: 52%;">
                <div class="section-title" style="margin-top: 0;">Preguntas Mejor Valoradas</div>
                {% if top_preguntas %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 8%;">#</th>
                                <th>Pregunta</th>
                                <th style="width: 18%; text-align: right;">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for question in top_preguntas %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div style="font-weight: 700;">{{ question.text|truncatechars:48 }}</div>
                                    <div style="font-size: 8.5pt; color: #6b7280;">{{ question.survey.title|truncatechars:36 }}</div>
                                </td>
                                <td style="text-align: right; font-weight: 800;">{{ question.avg_score|floatformat:1 }}/10</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div style="color: #6b7280;">Sin datos suficientes para ranking.</div>
                {% endif %}
            </td>
            <td class="panel" style="width: 48%;">
                <div class="section-title" style="margin-top: 0;">Encuestas Más Populares</div>
                {% if top_surveys %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 8%;">#</th>
                                <th>Encuesta</th>
                                <th style="width: 18%; text-align: right;">Resp.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for survey in top_surveys %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div style="font-weight: 700;">{{ survey.title|truncatechars:46 }}</div>
                                    <div style="font-size: 8.5pt; color: #6b7280;">Estado: {{ survey.get_status_display|default:survey.status }}</div>
                                </td>
                                <td style="text-align: right; font-weight: 800;">{{ survey.response_count|default:0 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div style="color: #6b7280;">Sin encuestas disponibles.</div>
                {% endif %}
            </td>
        </tr>
    </table>

    {% if categoria_distribution %}
        <div class="section-title">Distribución de Encuestas</div>
        <div class="panel">
            {% for label, count in categoria_distribution %}
                <div class="bar-row">
                    <div class="bar-head">
                        <span style="font-weight: 700;">{{ label }}</span>
                        <span style="float: right; color: #6b7280;">{{ count }}</span>
                    </div>
                    <div class="bar-track">
                        {% if total_surveys|default:0|add:0 > 0 %}
                            <div class="bar-fill" style="width: {% widthratio count total_surveys 100 %}%;"></div>
                        {% else %}
                            <div class="bar-fill" style="width: 0%;"></div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="summary">
        <h3>Resumen ejecutivo</h3>
        <ul>
            <li><strong>{{ total_responses|default:"0" }}</strong> respuestas analizadas; satisfacción promedio <strong>{{ global_satisfaction|default:"0"|floatformat:1 }}/10</strong>.</li>
            <li><strong>{{ total_active|default:"0" }}</strong> encuestas activas de <strong>{{ total_surveys|default:"0" }}</strong> en total.</li>
            {% if global_nps is not None %}
                <li>NPS global: <strong>{{ global_nps|floatformat:0 }}</strong>.</li>
            {% endif %}
        </ul>
    </div>

    <div class="footer">Byteneko • Reporte Global</div>
</body>
</html>
