{% extends 'app_base.html' %}
{% load static %}

{% block app_content %}

<div class="container-xl p-4 p-md-5">

    <div class="mb-4">
        <h1 class="h2 fw-bold">Generador de Reportes</h1>
        <p class="text-muted">Configura y exporta tus análisis en PDF o PowerPoint.</p>
    </div>

    <form method="POST" id="report-form">
        {% csrf_token %}
        <div class="row g-4">

            <div class="col-lg-5">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header p-4">
                        <h5 class="fw-bold mb-0">Configuración del reporte</h5>
                    </div>
                    <div class="card-body p-4">

                        <div class="mb-4">
                            <label for="survey_id" class="form-label fw-medium">Selecciona survey
                                <a tabindex="0" class="ms-2 text-primary small" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Selecciona la survey" data-bs-content="Escoge la survey cuyos datos deseas incluir en el reporte. Si no hay resultados, asegúrate de que la survey tenga respuestas.">
                                    <i class="bi bi-question-circle"></i>
                                </a>
                            </label>
                            <select class="form-select" id="survey_id" name="survey_id" required>
                                <option value="" disabled selected>Selecciona una survey...</option>
                                {% for survey in surveys %}
                                    <option value="{{ survey.public_id }}">{{ survey.title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-medium">Rango de Análisis
                                <a tabindex="0" class="ms-2 text-primary small" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="Rango de Análisis" data-bs-content="Selecciona si quieres todo el histórico o solo los últimos días. Para comparaciones específicas, usa 'Rango personalizado'.">
                                    <i class="bi bi-question-circle"></i>
                                </a>
                            </label>
                            <select class="form-select mb-3" id="window_days" name="window_days">
                                <option value="all" selected>Todo el histórico (Completo)</option>
                                <option value="15">Últimos 15 días (Tendencia)</option>
                                <option value="30">Últimos 30 días (Mensual)</option>
                                <option value="custom" disabled hidden>Rango personalizado (Activo)</option>
                            </select>

                            <div class="collapse" id="customDateCollapse">
                                <div class="card card-body bg-light border-0 py-2 px-3">
                                    <small class="text-muted mb-2 d-block fw-bold">O rango personalizado:</small>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" placeholder="Desde">
                                        </div>
                                        <div class="col-6">
                                            <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" placeholder="Hasta">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text mt-1">
                                <a href="#" class="text-decoration-none small" id="toggleCustomDates">
                                    Definir fechas específicas...
                                </a>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-medium">Secciones a incluir
                                <a tabindex="0" class="ms-2 text-primary small" role="button" data-bs-toggle="popover" data-bs-trigger="focus" title="¿Qué incluir en el reporte?" data-bs-content="Marca KPIs, gráficos y tablas según lo que necesites exportar. Menos secciones reduce tamaño y tiempo de generación.">
                                    <i class="bi bi-question-circle"></i>
                                </a>
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_kpis" id="include_kpis" checked>
                                <label class="form-check-label" for="include_kpis">KPIs de resumen</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_charts" id="include_charts" checked>
                                <label class="form-check-label" for="include_charts">Gráficos de análisis</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_table" id="include_table" checked>
                                <label class="form-check-label" for="include_table">Tablas de análisis detallado</label>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header p-4">
                        <h5 class="fw-bold mb-0">Vista Previa y Descarga</h5>
                    </div>
                    <div class="card-body p-4 d-flex flex-column">

                        <div class="card bg-body-tertiary border-dashed h-100" id="report-preview-container">
                            <div class="card-body p-4 p-md-5 d-flex flex-column align-items-center justify-content-center text-center h-100">
                                <i class="bi bi-file-earmark-medical fs-1 text-muted"></i>
                                <h5 class="text-muted fw-normal mt-3">La vista previa aparecerá aquí</h5>
                                <p class="small text-muted">Selecciona una survey para comenzar.</p>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="button" id="generate-pdf-btn" class="btn btn-primary w-100 mb-2">
                                <i class="bi bi-file-earmark-pdf-fill me-1"></i> Generar PDF
                            </button>
                            {% block extra_js %}
                            <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const pdfBtn = document.getElementById('generate-pdf-btn');
                                if (pdfBtn) {
                                    pdfBtn.addEventListener('click', function(e) {
                                        const select = document.getElementById('survey_id');
                                        const publicId = select ? select.value : '';
                                        if (!publicId) {
                                            alert('Selecciona una survey para generar el PDF.');
                                            return;
                                        }
                                        const url = `{% url 'report_pdf' %}?public_id=${encodeURIComponent(publicId)}`;
                                        window.location.href = url;
                                    });
                                }
                            });
                            </script>
                            {% endblock %}
                            <button type="submit" class="btn btn-outline-primary w-100" formaction="{% url 'report_pptx' %}">
                                <i class="bi bi-file-earmark-slides-fill me-1"></i> Generar PowerPoint
                            </button>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const surveySelect = document.getElementById('survey_id');
    const previewContainer = document.getElementById('report-preview-container');
    const placeholderHtml = previewContainer.innerHTML;

    // Filtros
    const windowSelect = document.getElementById('window_days');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const toggleLink = document.getElementById('toggleCustomDates');
    const customCollapse = document.getElementById('customDateCollapse');

    // Toggles
    const checkKpis = document.getElementById('include_kpis');
    const checkCharts = document.getElementById('include_charts');
    const checkTable = document.getElementById('include_table');

    // --- INTERACCIÓN DE FECHAS ---
    toggleLink.addEventListener('click', function(e) {
        e.preventDefault();
        const bsCollapse = new bootstrap.Collapse(customCollapse, { toggle: true });
    });

    // Si elige rango predefinido
    windowSelect.addEventListener('change', function() {
        if (this.value !== 'custom') {
            startDateInput.value = '';
            endDateInput.value = '';
            loadPreview();
        }
    });

    // Si usa el calendario
    function handleDateChange() {
        if (startDateInput.value || endDateInput.value) {
            windowSelect.value = 'custom';
        } else {
            windowSelect.value = 'all';
        }
        loadPreview();
    }

    startDateInput.addEventListener('change', handleDateChange);
    endDateInput.addEventListener('change', handleDateChange);

    // Listeners generales
    [checkKpis, checkCharts, checkTable, surveySelect].forEach(el => {
        el.addEventListener('change', loadPreview);
    });

    // --- FUNCIÓN DE CARGA ---
    function loadPreview() {
        const surveyId = surveySelect.value;
        if (!surveyId) {
            previewContainer.innerHTML = placeholderHtml;
            return;
        }

        previewContainer.innerHTML = `
            <div class="card-body p-4 p-md-5 d-flex flex-column align-items-center justify-content-center text-center h-100">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p class="text-muted small">Actualizando análisis...</p>
            </div>
        `;

        const params = new URLSearchParams({
            window_days: windowSelect.value,
            start_date: startDateInput.value,
            end_date: endDateInput.value,
            include_kpis: checkKpis.checked,
            include_charts: checkCharts.checked,
            include_table: checkTable.checked
        });

        const previewUrlTemplate = "{% url 'report_preview' public_id='__PUBLIC_ID__' %}";
        const url = previewUrlTemplate.replace('__PUBLIC_ID__', encodeURIComponent(surveyId));

        fetch(`${url}?${params.toString()}`)
            .then(r => r.ok ? r.text() : Promise.reject(r.statusText))
            .then(html => {
                previewContainer.innerHTML = html;
            })
            .catch(err => {
                previewContainer.innerHTML = `<div class="p-4 text-danger text-center">Error: ${err}</div>`;
            });
    }
});
</script>
{% endblock %}