<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Ejecutivo - {{ survey.title }}</title>
    <style>
        /* ===== CONFIGURACIÓN DE PÁGINA ===== */
        @page {
            size: A4;
            margin: 2.2cm 2cm 2.5cm 2cm;
            @bottom-center {
                content: "Página " counter(page) " de " counter(pages);
                font-size: 9pt;
                color: #9ca3af;
                font-family: 'Segoe UI', 'Arial', sans-serif;
                font-weight: 400;
            }
        }

        /* ===== ESTILOS GENERALES ===== */
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            font-size: 10.5pt;
            color: #1f2937;
            line-height: 1.65;
            margin: 0;
            padding: 0;
            text-align: justify;
            text-justify: inter-word;
            hyphens: auto;
            -webkit-hyphens: auto;
        }

        /* ===== TIPOGRAFÍA ===== */
        h1 { 
            font-size: 26pt; 
            color: #0d6efd; 
            margin: 0 0 0.7cm 0;
            font-weight: 700;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }
        
        h2 { 
            font-size: 17pt; 
            border-bottom: 2.5px solid #0d6efd;
            padding-bottom: 6px; 
            margin: 1cm 0 0.6cm 0;
            color: #111827; 
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        
        h3 { 
            font-size: 13.5pt; 
            margin: 0.5cm 0 0.3cm 0;
            color: #374151; 
            font-weight: 600;
            letter-spacing: 0;
        }
        
        h4 { 
            font-size: 10.5pt; 
            margin: 0.35cm 0 0.25cm 0;
            color: #6b7280; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        p { 
            margin: 0 0 0.45cm 0;
            text-align: justify;
            text-justify: inter-word;
            orphans: 3;
            widows: 3;
        }
        
        .text-muted { color: #6b7280; }
        .text-primary { color: #0d6efd; }
        .small { font-size: 9pt; }
        .fw-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .page-break { page-break-before: always; }

        /* ===== PORTADA PROFESIONAL ===== */
        .cover-page {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2cm 0;
        }
        
        .cover-container {
            max-width: 85%;
        }
        
        .cover-title {
            font-size: 40pt;
            font-weight: 700;
            color: #0d6efd;
            line-height: 1.15;
            margin-bottom: 25px;
            letter-spacing: -0.8px;
            word-spacing: 0.05em;
        }
        
        .cover-subtitle {
            font-size: 19pt;
            color: #6b7280;
            margin-bottom: 45px;
            font-weight: 300;
            letter-spacing: 0.3px;
        }
        
        .cover-meta {
            border-top: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
            padding: 22px 0;
            margin: 30px auto;
            width: 75%;
            color: #374151;
            font-size: 10.5pt;
            line-height: 1.9;
        }
        
        .cover-meta strong {
            color: #0d6efd;
            font-weight: 600;
        }
        
        .brand-footer {
            margin-top: 45px;
            font-size: 10pt;
            color: #9ca3af;
            font-weight: 300;
            letter-spacing: 0.2px;
        }

        /* ===== KPIs PROFESIONALES ===== */
        .kpi-grid {
            display: flex;
            justify-content: space-between;
            margin: 35px 0;
            gap: 25px;
            border-top: 3px solid #0d6efd;
            border-bottom: 1px solid #e5e7eb;
            padding: 28px 0;
        }
        
        .kpi-card {
            text-align: center;
            flex: 1;
            border-right: 1px solid #e5e7eb;
            padding: 0 18px;
        }
        
        .kpi-card:last-child {
            border-right: none;
        }
        
        .kpi-value {
            display: block;
            font-size: 32pt;
            font-weight: 700;
            color: #111827;
            margin: 12px 0;
            line-height: 1;
            letter-spacing: -0.5px;
        }
        
        .kpi-value.primary { color: #0d6efd; }
        .kpi-value.success { color: #10b981; }
        .kpi-value.warning { color: #ef4444; }
        .kpi-value.info { color: #0f766e; }
        
        .kpi-label {
            font-size: 9.5pt;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 1.2px;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        
        .kpi-sublabel {
            font-size: 8.5pt;
            color: #9ca3af;
            margin-top: 6px;
            font-weight: 400;
        }

        /* ===== INSIGHTS PROFESIONALES ===== */
        .insight-box {
            padding: 18px 0;
            margin: 25px 0;
            page-break-inside: avoid;
            background: linear-gradient(to right, #f8f9fa 0%, #ffffff 100%);
            padding-left: 16px;
            border-radius: 4px;
        }
        
        .insight-box.success {
            background: linear-gradient(to right, #f0fdf4 0%, #ffffff 100%);
        }
        
        .insight-box.warning {
            background: linear-gradient(to right, #fef2f2 0%, #ffffff 100%);
        }
        
        .insight-title {
            display: block;
            font-size: 9pt;
            font-weight: 700;
            color: #0d6efd;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.9px;
        }
        
        .insight-box.success .insight-title { color: #059669; }
        .insight-box.warning .insight-title { color: #dc2626; }
        
        .insight-text {
            font-size: 10.5pt;
            color: #1f2937;
            line-height: 1.7;
            text-align: justify;
        }
        
        .insight-text strong {
            color: #0d6efd;
            font-weight: 600;
        }

        /* ===== CONTENEDORES DE PREGUNTAS ===== */
        .question-container {
            margin-bottom: 1.3cm;
            page-break-inside: avoid;
            padding: 16px;
            background: #fafbfc;
            border-radius: 4px;
        }

        .question-header {
            margin-bottom: 18px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 12px;
        }
        
        .question-number {
            display: inline-block;
            background: #0d6efd;
            color: white;
            font-weight: 700;
            font-size: 9.5pt;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            margin-right: 10px;
        }
        
        .question-type {
            display: inline-block;
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            color: #0369a1;
            padding: 4px 10px;
            border-radius: 18px;
            font-size: 8pt;
            text-transform: uppercase;
            margin-top: 8px;
            font-weight: 600;
            letter-spacing: 0.7px;
        }

        /* ===== IMÁGENES Y GRÁFICOS ===== */
        .chart-title {
            font-size: 10.5pt;
            font-weight: 700;
            color: #0d6efd;
            margin: 22px 0 12px 0;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            padding-left: 0;
        }
        
        .chart-img {
            width: 100%;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 18px 0;
            border: 1px solid #e5e7eb;
            border-radius: 3px;
        }

        /* ===== TABLAS DE DATOS ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 22px;
            font-size: 9.5pt;
            background: #ffffff;
            page-break-inside: avoid;
        }
        
        .data-table th {
            text-align: left;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 2.5px solid #0d6efd;
            padding: 11px 12px;
            color: #374151;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 8.5pt;
            letter-spacing: 0.7px;
        }
        
        .data-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 10px 12px;
            color: #1f2937;
            line-height: 1.5;
        }
        
        .data-table tr:last-child td { 
            border-bottom: none; 
        }
        
        .data-table tr:hover {
            background: #f9fafb;
        }

        /* ===== LISTAS DE COMENTARIOS ===== */
        ul.text-responses {
            list-style-type: none;
            padding-left: 0;
            margin-top: 20px;
        }
        
        ul.text-responses li {
            background: linear-gradient(to right, #f9fafb 0%, #ffffff 100%);
            padding: 13px 17px;
            margin-bottom: 13px;
            font-style: italic;
            color: #374151;
            font-size: 9.8pt;
            border-radius: 5px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            line-height: 1.6;
        }
        
        ul.text-responses li:before {
            content: "▸ ";
            margin-right: 8px;
            color: #0d6efd;
            font-weight: 700;
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-box {
            margin: 25px 0;
            padding: 22px 0;
            border-top: 2px solid #e5e7eb;
            border-bottom: 2px solid #e5e7eb;
            page-break-inside: avoid;
        }
        
        .stats-grid {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-value {
            font-size: 17pt;
            font-weight: 700;
            color: #0d6efd;
            display: block;
            letter-spacing: -0.3px;
        }
        
        .stat-label {
            font-size: 8.5pt;
            color: #6b7280;
            text-transform: uppercase;
            margin-top: 6px;
            letter-spacing: 0.6px;
        }

        /* ===== ELEMENTOS DECORATIVOS ===== */
        .separator {
            height: 2.5px;
            background: linear-gradient(to right, #0d6efd 0%, #10b981 50%, #0d6efd 100%);
            margin: 1.1cm 0;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(13, 110, 253, 0.15);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 8.5pt;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .badge.primary { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e3a8a;
            border: 1px solid #93c5fd;
        }
        
        .badge.success { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .badge.warning { 
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        /* ===== ÍNDICE Y TABLA DE CONTENIDOS ===== */
        .toc-container {
            background: linear-gradient(to bottom right, #f8f9fa 0%, #ffffff 100%);
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #0d6efd;
            margin: 30px 0;
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
        }
        
        .toc-title {
            font-size: 18pt;
            font-weight: 700;
            color: #0d6efd;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .toc-item {
            padding: 10px 15px;
            margin: 8px 0;
            background: white;
            border-left: 4px solid #10b981;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        /* ===== ICONOS Y DECORACIONES ===== */
        .icon-circle {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: 700;
            margin-right: 10px;
            box-shadow: 0 2px 6px rgba(13, 110, 253, 0.3);
        }
        
        .section-divider {
            margin: 1cm 0;
            height: 1px;
            background: linear-gradient(to right, transparent 0%, #0d6efd 50%, transparent 100%);
        }
    </style>
</head>
<body>

    <!-- ===== PÁGINA DE PORTADA MEJORADA ===== -->
    <div class="cover-page">
        <div class="cover-container">
            <div class="cover-title">{{ survey.title }}</div>
            <div class="cover-subtitle">Reporte Ejecutivo de Análisis</div>

            <div class="cover-meta">
                <p><strong>Fecha de Generación:</strong> {{ fecha_generacion|date:"d \d\e F \d\e Y · H:i" }}</p>
                <p><strong>Autor:</strong> {{ survey.author.get_full_name|default:survey.author.username }}</p>
                
                {% if start_date or end_date %}
                    <p><strong>Periodo Analizado:</strong><br>{{ start_date|date:"d/m/Y"|default:"Desde el inicio" }} – {{ end_date|date:"d/m/Y"|default:"Hasta hoy" }}</p>
                {% else %}
                    <p><strong>Periodo:</strong> Datos históricos completos</p>
                {% endif %}
                
                <p><strong>Total de Respuestas:</strong> <span style="color: #0d6efd; font-size: 16pt; font-weight: 700;">{{ total_respuestas|default:0 }}</span></p>
            </div>
            
            <div class="brand-footer">
                <span style="color: #0d6efd; font-weight: 700;">BYTENEKO</span> Analytics Platform
                <br>
                <span style="font-size: 9pt;">Reporte automático · Diseñado para la excelencia</span>
            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <!-- ===== RESUMEN EJECUTIVO MEJORADO ===== -->
    <h1>Resumen Ejecutivo</h1>
    <p class="text-muted" style="margin-bottom: 40px; font-style: italic;">
        Panorama general de los indicadores clave de desempeño que reflejan la salud de la encuesta 
        y el nivel de satisfacción de los participantes. Este análisis permite identificar fortalezas 
        y áreas de oportunidad de manera inmediata.
    </p>

    <div class="kpi-grid">
        <div class="kpi-card primary">
            <span class="kpi-label">Total Respuestas</span>
            <span class="kpi-value primary">{{ total_respuestas|default:0 }}</span>
            <span class="kpi-sublabel">Participantes únicos</span>
        </div>
        
        <div class="kpi-card {% if kpi_prom_satisfaccion >= 8 %}success{% elif kpi_prom_satisfaccion >= 6 %}info{% else %}warning{% endif %}">
            <span class="kpi-label">Satisfacción Promedio</span>
            <span class="kpi-value {% if kpi_prom_satisfaccion >= 8 %}success{% elif kpi_prom_satisfaccion >= 6 %}info{% else %}warning{% endif %}">
                {{ kpi_prom_satisfaccion|floatformat:1|default:"--" }}
            </span>
            <span class="kpi-sublabel">Escala de 1 a 10</span>
        </div>
        
        <div class="kpi-card {% if nps_score >= 50 %}success{% elif nps_score >= 0 %}info{% else %}warning{% endif %}">
            <span class="kpi-label">Net Promoter Score</span>
            <span class="kpi-value {% if nps_score >= 50 %}success{% elif nps_score >= 0 %}info{% else %}warning{% endif %}">
                {{ nps_score|floatformat:0|default:"--" }}
            </span>
            <span class="kpi-sublabel">NPS Global</span>
        </div>
    </div>

    {% if nps_score is not None %}
        <div class="insight-box {% if nps_score >= 50 %}success{% elif nps_score < 0 %}warning{% endif %}">
            <span class="insight-title">Análisis de Salud de la Marca</span>
            <div class="insight-text">
                <p>
                    Con un <strong>NPS de {{ nps_score|floatformat:0 }}</strong>, la percepción general de la marca 
                    se encuentra en un nivel 
                    {% if nps_score >= 50 %}<strong style="color: #059669;">EXCELENTE</strong>{% elif nps_score >= 0 %}<strong style="color: #0369a1;">POSITIVO</strong>{% else %}<strong style="color: #dc2626;">CRÍTICO</strong>{% endif %}.
                </p>
                
                <p>
                {% if nps_score >= 50 %}
                    La gran mayoría de los clientes son promotores entusiastas que recomendarían activamente su marca.
                    Con <strong>{{ nps_promoters|floatformat:0 }}%</strong> de promotores versus solo <strong>{{ nps_detractors|floatformat:0 }}%</strong> 
                    de detractores, su empresa cuenta con una base sólida de clientes leales que impulsan el crecimiento mediante 
                    recomendaciones orgánicas.
                {% elif nps_score >= 0 %}
                    La percepción es positiva, aunque existe margen significativo de mejora. Actualmente, 
                    <strong>{{ nps_promoters|floatformat:0 }}%</strong> son promotores, pero hay un importante segmento de 
                    <strong>{{ nps_passives|floatformat:0 }}%</strong> de clientes pasivos que, con las estrategias adecuadas, 
                    podrían convertirse en promotores activos, impulsando así el crecimiento de la marca.
                {% else %}
                    La situación requiere atención prioritaria. Actualmente <strong>{{ nps_detractors|floatformat:0 }}%</strong> 
                    son detractores, superando a los promotores (<strong>{{ nps_promoters|floatformat:0 }}%</strong>). Es fundamental 
                    identificar y atender las causas raíz de insatisfacción para evitar impactos negativos en la reputación de la marca 
                    y retener a los clientes existentes.
                {% endif %}
                </p>
            </div>
        </div>
    {% endif %}

    <div class="separator"></div>

    <div class="page-break"></div>

    <!-- ===== ANÁLISIS POR PREGUNTA MEJORADO ===== -->
    <h1>Análisis Detallado por Pregunta</h1>
    <p class="text-muted" style="margin-bottom: 1cm; font-style: italic;">
        A continuación se presenta un desglose exhaustivo de cada pregunta del cuestionario, incluyendo 
        análisis estadístico, distribuciones visuales y hallazgos clave que permiten comprender en profundidad 
        las tendencias y patrones en las respuestas de los participantes.
    </p>

    {% for item in analysis_data %}
        <div class="question-container">

            <div class="question-header">
                <div>
                    <h3 class="text-left">
                        <span class="question-number">{{ item.order }}</span>
                        {{ item.text }}
                    </h3>
                    <span class="question-type">{{ item.tipo_display }}</span>
                    
                    {% if item.total_respuestas > 0 %}
                        <span class="badge primary">{{ item.total_respuestas }} respuestas</span>
                    {% endif %}
                </div>
            </div>

            {% if item.insight %}
                <div class="insight-box">
                    <span class="insight-title">Hallazgo Clave</span>
                    <div class="insight-text">{% autoescape off %}{{ item.insight }}{% endautoescape %}</div>
                </div>
            {% endif %}

            {% if item.total_respuestas > 0 %}

                {% if item.chart_image %}
                    <div class="chart-title">Distribución Visual de Respuestas</div>
                    <img src="data:image/png;base64,{{ item.chart_image }}" class="chart-img" alt="Gráfico de distribución de la pregunta {{ item.order }}">
                    <p class="text-center small text-muted" style="margin-top: 5px; font-style: italic;">
                        Gráfico generado automáticamente basado en {{ item.total_respuestas }} respuestas
                    </p>
                {% endif %}

                {% if item.type == 'text' %}
                    <h4 style="margin-top: 25px;">Muestra de Opiniones Textuales</h4>
                    <p class="text-muted small" style="margin-bottom: 15px;">
                        Las siguientes son algunas de las respuestas escritas por los participantes, 
                        que ilustran las percepciones y experiencias directas:
                    </p>
                    <ul class="text-responses">
                        {% for resp in item.samples_texto %}
                            <li>"{{ resp }}"</li>
                        {% empty %}
                            <li class="text-muted">No hay comentarios textuales disponibles para esta pregunta.</li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if item.estadisticas and item.type != 'text' %}
                    <div class="stats-box">
                        <h4 style="margin-bottom: 15px; text-align: center; color: #0d6efd;">
                            Estadísticas Descriptivas
                        </h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value">{{ item.estadisticas.promedio|floatformat:2 }}</span>
                                <span class="stat-label">Promedio</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ item.estadisticas.mediana|floatformat:1 }}</span>
                                <span class="stat-label">Mediana</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ item.estadisticas.minimo|floatformat:0 }}</span>
                                <span class="stat-label">Mínimo</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">{{ item.estadisticas.maximo|floatformat:0 }}</span>
                                <span class="stat-label">Máximo</span>
                            </div>
                        </div>
                        <p class="text-center small text-muted" style="margin-top: 15px; font-style: italic;">
                            Estas métricas proporcionan una visión estadística de la tendencia central y dispersión de las respuestas.
                        </p>
                    </div>
                {% endif %}

                {% if include_table and item.opciones %}
                    <h4 style="margin-top: 25px;">Tabla de Frecuencias Detallada</h4>
                    <p class="text-muted small" style="margin-bottom: 15px;">
                        Desglose numérico y porcentual de cada opción de respuesta:
                    </p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 60%;">Opción de Respuesta</th>
                                <th style="text-align: center; width: 20%;">Frecuencia</th>
                                <th style="text-align: right; width: 20%;">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for op in item.opciones %}
                                <tr>
                                    <td>
                                        <span class="icon-circle" style="width: 8px; height: 8px; display: inline-block; background: #0d6efd; margin-right: 8px;"></span>
                                        {{ op.opcion }}
                                    </td>
                                    <td style="text-align: center;"><strong>{{ op.frecuencia }}</strong></td>
                                    <td style="text-align: right;">
                                        <strong>{{ op.porcentaje|floatformat:1 }}%</strong>
                                        <div style="background: #e0f2fe; height: 6px; border-radius: 3px; margin-top: 4px; overflow: hidden;">
                                            <div style="background: linear-gradient(to right, #0d6efd, #0b5ed7); height: 100%; width: {{ op.porcentaje }}%;"></div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

            {% else %}
                <div class="insight-box warning">
                    <span class="insight-title">Información No Disponible</span>
                    <div class="insight-text">
                        <p>
                            No se registraron respuestas para esta pregunta en el periodo seleccionado. 
                            Esto podría indicar que la pregunta no era obligatoria o que los participantes 
                            optaron por no responderla.
                        </p>
                    </div>
                </div>
            {% endif %}

        </div>

        <!-- Separador entre preguntas -->
        {% if not forloop.last %}
            <div class="section-divider"></div>
        {% endif %}

        {% if forloop.counter|divisibleby:2 and not forloop.last %}
            <div class="page-break"></div>
        {% endif %}

    {% endfor %}

    <!-- ===== PIE DE REPORTE ===== -->
    <div class="separator"></div>
    
    <div class="text-center" style="margin-top: 40px; padding: 25px 0; border-top: 2px solid #0d6efd;">
        <p style="margin: 0; font-size: 14pt; font-weight: 700; color: #0d6efd; margin-bottom: 8px;">
            BYTENEKO Analytics Platform
        </p>
        <p style="margin: 0; font-size: 10pt; color: #6b7280; margin-bottom: 12px;">
            Reporte generado automáticamente con tecnología de análisis avanzado
        </p>
        <p style="margin: 0; font-size: 9pt; color: #9ca3af;">
            {{ fecha_generacion|date:"d \d\e F \d\e Y \a \l\a\s H:i" }}
        </p>
        <p style="margin-top: 15px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 8pt; color: #9ca3af; font-style: italic;">
            Este documento contiene información confidencial · © {{ fecha_generacion|date:"Y" }} Byteneko
        </p>
    </div>

</body>
</html>