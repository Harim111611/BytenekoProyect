{% comment %}
Preview idéntico al PDF.
Usa los mismos estilos y estructura que el reporte descargable.
{% endcomment %}

<style>
    /* Estilos adaptados del PDF para la web */
    .pdf-preview-wrapper {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        color: #212529;
        background-color: white;
        padding: 20px; /* Padding interno */
    }

    .pdf-preview-wrapper h1 { font-size: 22pt; color: #0d6efd; margin-bottom: 0.5cm; font-weight: bold; }
    .pdf-preview-wrapper h2 { font-size: 16pt; border-bottom: 2px solid #dee2e6; padding-bottom: 5px; margin-top: 1cm; margin-bottom: 0.5cm; color: #343a40; }
    .pdf-preview-wrapper h3 { font-size: 13pt; margin-bottom: 5px; color: #495057; font-weight: 600; }

    .pdf-preview-wrapper .text-muted { color: #6c757d; }
    .pdf-preview-wrapper .small { font-size: 9pt; }

    /* Portada */
    .preview-cover {
        text-align: center;
        padding: 3rem 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px dashed #dee2e6;
    }
    .preview-cover-title {
        font-size: 28pt;
        font-weight: 700;
        color: #0d6efd;
        line-height: 1.2;
        margin-bottom: 10px;
    }
    .preview-cover-subtitle {
        font-size: 14pt;
        color: #495057;
        margin-bottom: 20px;
    }

    /* Tablas KPI */
    .preview-kpi-table {
        width: 100%;
        margin-bottom: 1cm;
        border-collapse: separate;
        border-spacing: 10px;
    }
    .preview-kpi-cell {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        width: 33%;
    }
    .preview-kpi-value {
        display: block;
        font-size: 24pt;
        font-weight: 700;
        color: #212529;
    }
    .preview-kpi-label {
        font-size: 9pt;
        text-transform: uppercase;
        color: #6c757d;
        letter-spacing: 1px;
    }
    .kpi-green { color: #198754; }
    .kpi-blue { color: #0d6efd; }
    .kpi-red { color: #dc3545; }

    /* Cajas de Insight */
    .preview-insight-box {
        background-color: #f0f7ff;
        border-left: 4px solid #0d6efd;
        padding: 12px;
        margin: 15px 0;
        border-radius: 0 4px 4px 0;
    }
    .preview-insight-title {
        display: block;
        font-size: 8pt;
        font-weight: 700;
        color: #0d6efd;
        text-transform: uppercase;
        margin-bottom: 3px;
    }
    .preview-insight-text {
        font-size: 10pt;
        color: #0f172a;
        font-style: italic;
    }

    /* Tablas de Datos */
    .preview-data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 9pt;
    }
    .preview-data-table th {
        text-align: left;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 8px;
        color: #495057;
    }
    .preview-data-table td {
        border-bottom: 1px solid #dee2e6;
        padding: 8px;
        color: #212529;
    }

    .preview-chart-img {
        width: 100%;
        height: auto;
        display: block;
        margin: 10px auto;
        border: 1px solid #f1f1f1;
        border-radius: 4px;
    }

    /* Listas */
    ul.preview-text-responses {
        list-style-type: none;
        padding-left: 0;
    }
    ul.preview-text-responses li {
        background-color: #f9fafb;
        border-left: 3px solid #ced4da;
        padding: 8px 12px;
        margin-bottom: 8px;
        font-style: italic;
        color: #495057;
        font-size: 9pt;
    }
</style>

<div class="card border-0 shadow-sm h-100">
    <div class="card-body p-0" style="max-height: 650px; overflow-y: auto;">

        <div class="pdf-preview-wrapper">

            {# --- PORTADA --- #}
            <div class="preview-cover">
                <div class="preview-cover-title">{{ encuesta.titulo }}</div>
                <div class="preview-cover-subtitle">Reporte Ejecutivo</div>
                <div class="small text-muted">
                    Generado: {% now "d/m/Y" %} • Autor: {{ encuesta.creador.username|title }}
                </div>
            </div>

            {# --- RESUMEN EJECUTIVO --- #}
            {% if include_kpis %}
                <h1>Resumen Ejecutivo</h1>
                <p class="text-muted small mb-4">Visión general de los indicadores clave.</p>

                <div class="d-flex justify-content-between gap-3 mb-4">
                    <div class="preview-kpi-cell">
                        <span class="preview-kpi-value kpi-blue">{{ total_respuestas }}</span>
                        <span class="preview-kpi-label">Total</span>
                    </div>
                    <div class="preview-kpi-cell">
                        <span class="preview-kpi-value kpi-green">{{ kpi_prom_satisfaccion|floatformat:1 }}</span>
                        <span class="preview-kpi-label">Satisfacción</span>
                    </div>
                    <div class="preview-kpi-cell">
                        <span class="preview-kpi-value {% if nps_score > 0 %}kpi-green{% elif nps_score < 0 %}kpi-red{% else %}text-muted{% endif %}">
                            {{ nps_score|default:"--" }}
                        </span>
                        <span class="preview-kpi-label">NPS</span>
                    </div>
                </div>

                {% if nps_score is not None %}
                    <div class="preview-insight-box">
                        <span class="preview-insight-title">Salud de Marca</span>
                        <span class="preview-insight-text">
                            NPS de <strong>{{ nps_score }}</strong>. La percepción es
                            {% if nps_score >= 50 %}excelente.{% endif %}
                            {% if nps_score > 0 and nps_score < 50 %}positiva.{% endif %}
                            {% if nps_score <= 0 %}crítica.{% endif %}
                        </span>
                    </div>
                {% endif %}
                <hr class="my-5">
            {% endif %}

            {# --- DETALLE POR PREGUNTA --- #}
            {% if include_charts %}
                <h1>Análisis Detallado</h1>

                {% for item in analysis_data %}
                    <div class="mb-5 break-avoid">
                        <h3>{{ item.orden }}. {{ item.texto }}</h3>
                        <span class="badge bg-light text-dark border mb-2">{{ item.tipo_display }}</span>

                        {% if item.insight %}
                            <div class="preview-insight-box">
                                <span class="preview-insight-title">Hallazgo</span>
                                <span class="preview-insight-text">{% autoescape off %}{{ item.insight }}{% endautoescape %}</span>
                            </div>
                        {% endif %}

                        {% if item.total_respuestas > 0 %}

                            {# IMAGEN DEL GRÁFICO (IGUAL QUE EN PDF) #}
                            {% if item.chart_image %}
                                <img src="data:image/png;base64,{{ item.chart_image }}" class="preview-chart-img">
                            {% endif %}

                            {# TABLA DE ESTADÍSTICAS #}
                            {% if item.estadisticas and item.tipo != 'text' %}
                                <div class="bg-light p-2 rounded mt-2 border">
                                    <table style="width: 100%; font-size: 9pt;">
                                        <tr>
                                            <td><strong>Promedio:</strong> {{ item.estadisticas.promedio|floatformat:1 }}</td>
                                            <td><strong>Mediana:</strong> {{ item.estadisticas.mediana|floatformat:1 }}</td>
                                            <td class="text-end"><strong>Rango:</strong> {{ item.estadisticas.minimo|floatformat:0 }}-{{ item.estadisticas.maximo|floatformat:0 }}</td>
                                        </tr>
                                    </table>
                                </div>
                            {% endif %}

                            {# TABLA DE OPCIONES #}
                            {% if item.opciones %}
                                <table class="preview-data-table">
                                    <thead>
                                        <tr>
                                            <th>Opción</th>
                                            <th class="text-center">Freq</th>
                                            <th class="text-end">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for op in item.opciones %}
                                            <tr>
                                                <td>{{ op.label }}</td>
                                                <td class="text-center">{{ op.count }}</td>
                                                <td class="text-end">{{ op.percent|floatformat:1 }}%</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}

                            {# MUESTRA DE TEXTO #}
                            {% if item.tipo == 'text' %}
                                <p class="small fw-bold mt-3 mb-2">Opiniones recientes:</p>
                                <ul class="preview-text-responses">
                                    {% for resp in item.samples_texto %}
                                        <li>"{{ resp }}"</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                        {% else %}
                            <p class="text-muted small fst-italic mt-2">Sin respuestas registradas.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% endif %}

        </div>
    </div>
</div>